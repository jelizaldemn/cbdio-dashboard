
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Centro Binacional para el Desarrollo Ind√≠gena Oaxaque√±o ‚Äì An√°lisis Financiero (JLE)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js">
// ====== Executive Analysis ======
function perc(x){ return (x*100).toFixed(1)+'%'; }
function safeDiv(a,b){ return b && b!=0 ? (a/b) : 0; } // Pythonic; fix to JS below


function generateExecutiveAnalysis(){
  const months = STATE.months || [];
  const percent = (x)=> (x*100).toFixed(1)+'%';
  const percentile = (arr, p)=>{ const a=[...arr].sort((x,y)=>x-y); const idx=(a.length-1)*p; const lo=Math.floor(idx), hi=Math.ceil(idx); if (lo===hi) return a[lo]||0; const w=idx-lo; return (a[lo]||0)*(1-w)+(a[hi]||0)*w; };
  const hhi = (shares)=> shares.reduce((acc,s)=> acc + Math.pow(s,2), 0);
  const cats = STATE.cats || [];
  if (!months.length || !cats.length){ const wrap = document.getElementById('execWrap'); if (wrap) wrap.classList.add('hidden'); return; }

  // Totals and trend
  const series = STATE.totalsPerMonth || [];
  const n = series.length;
  const total = series.reduce((a,b)=>a+b,0);
  const avg = n ? total / n : 0;
  const slope = slopePerMonth(series);
  const last = series[n-1] || 0;
  const prev = series[n-2] || 0;
  const mom = last - prev;
  const yoy = n > 12 ? last - (series[n-13]||0) : null;

  // Volatility (coefficient of variation)
  const variance = n ? series.reduce((acc,v)=> acc + Math.pow(v-avg,2), 0) / n : 0;
  const stdev = Math.sqrt(variance);
  const cv = avg ? stdev/avg : 0;

  // Median & IQR on monthly totals
  const med = percentile(series, 0.5);
  const q1 = percentile(series, 0.25);
  const q3 = percentile(series, 0.75);
  const iqr = q3 - q1;

  // Top categories by spend
  const topCats = [...cats].sort((a,b)=> b.total - a.total).slice(0,5);
  const totalAll = total || 1;
  const sharesTop = topCats.map(c => ({ name:c.name, share: (c.total/totalAll) }));
  const sharesAll = cats.map(c => c.total/totalAll);
  const hhiAll = hhi(sharesAll);

  // Category trend drivers
  const catTrends = cats.map(c=>{
    const s = slopePerMonth(c.monthly);
    const mAvg = c.monthly.length ? (c.total / c.monthly.length) : 0;
    return { name: c.name, slope: s, total: c.total, avg: mAvg };
  }).sort((a,b)=> Math.abs(b.slope) - Math.abs(a.slope));

  const upDrivers = catTrends.filter(x=> x.slope > 0).slice(0,3);
  const downDrivers = catTrends.filter(x=> x.slope < 0).slice(0,3);

  // MoM category deltas (√∫ltimo vs anterior)
  const momCat = cats.map(c=>({ name:c.name, delta:(c.monthly[c.monthly.length-1]||0) - (c.monthly[c.monthly.length-2]||0) }));
  const momUp = [...momCat].sort((a,b)=> b.delta - a.delta).slice(0,3);
  const momDown = [...momCat].sort((a,b)=> a.delta - b.delta).slice(0,3);

  // Volatility per category (CV)
  const catVol = cats.map(c=>{ const avgC = c.total/(c.monthly.length||1); const st = Math.sqrt(c.monthly.reduce((acc,v)=> acc + Math.pow(v-avgC,2), 0) / (c.monthly.length||1)); const cvC = avgC? st/avgC : 0; return { name:c.name, cv:cvC, avg:avgC }; });
  const mostVol = [...catVol].sort((a,b)=> b.cv - a.cv).slice(0,3);

  // Sem√°foro counts
  const semCounts = cats.reduce((acc,c)=>{
    const mAvg = c.monthly.length ? (c.total / c.monthly.length) : 0;
    const thr = Math.max(1, 0.05 * (mAvg || 1));
    const s = slopePerMonth(c.monthly);
    if (s > thr) acc.rojo++;
    else if (s < -thr) acc.verde++;
    else acc.amarillo++;
    return acc;
  }, {rojo:0, amarillo:0, verde:0});

  // Narrative
  const lines = [];
  lines.push(`Proyecto: ${STATE.projectTitle}`);
  lines.push(`Periodo: ${months[0]} ‚Äì ${months[months.length-1]}`);
  lines.push('');
  const slopeTxt = (slope>=0?'+':'-') + Math.abs(slope).toFixed(2) + ' USD/mes';
  const momTxt = (mom>=0?'‚ñ≤':'‚ñº') + ' ' + (new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(Math.abs(mom)));
  lines.push('1) Resumen ejecutivo');
  lines.push(`‚Ä¢ Gasto total: ${fmtUSD(total)} ¬∑ Promedio mensual: ${fmtUSD(avg)} ¬∑ Mediana: ${fmtUSD(med)} ¬∑ IQR: ${fmtUSD(iqr)}.`);
  lines.push(`‚Ä¢ Tendencia: ${slope>=0?'üìà al alza':'üìâ a la baja'} (${(slope>=0?'+':'-') + Math.abs(slope).toFixed(2)} USD/mes). Volatilidad (CV): ${(cv*100).toFixed(1)}%.`);
  lines.push(`‚Ä¢ √öltimo mes vs anterior: ${(mom>=0?'‚ñ≤':'‚ñº')} ${fmtUSD(Math.abs(mom))}${(yoy!==null)?(' ¬∑ Œî vs 12m: ' + (yoy>=0?'‚ñ≤ ':'‚ñº ') + fmtUSD(Math.abs(yoy))):''}.`);
  lines.push(`‚Ä¢ Mejor mes: ${months[Math.min(...series.map((v,i)=> v===Math.min(...series)?i:9999))]} ¬∑ Peor mes: ${months[series.indexOf(Math.max(...series))]}`);
  lines.push('');
  lines.push('2) Principales categor√≠as (Top 5 por gasto total)');
  topCats.forEach((c,i)=>{
    const s = slopePerMonth(c.monthly);
    const avgC = c.monthly.length ? c.total / c.monthly.length : 0;
    const sTxt = (s>=0?'+':'-') + Math.abs(s).toFixed(2) + ' USD/mes';
    lines.push(`   ${i+1}. ${c.name}: ${fmtUSD(c.total)} (${fmtUSD(avgC)}/mes) ¬∑ Tendencia: ${s>=0?'üìà':'üìâ'} ${sTxt}.`);
  });
  lines.push('');
  lines.push('   Participaci√≥n de Top 5');
  sharesTop.forEach(s => lines.push(`   ‚Ä¢ ${s.name}: ${(s.share*100).toFixed(1)}% del total`));
  lines.push('');
  lines.push('   Cambios del √∫ltimo mes (MoM)');
  momUp.forEach(m => lines.push(`   ‚Ä¢ ‚Üë ${m.name}: ${fmtUSD(m.delta)}`));
  momDown.forEach(m => lines.push(`   ‚Ä¢ ‚Üì ${m.name}: ${fmtUSD(Math.abs(m.delta))}`));
  lines.push('');
  lines.push('   Volatilidad por categor√≠a (CV alto)');
  mostVol.forEach(v => lines.push(`   ‚Ä¢ ${v.name}: ${(v.cv*100).toFixed(1)}% (prom: ${fmtUSD(v.avg)})`));
  lines.push('');
  lines.push(`‚Ä¢ Sem√°foro categor√≠as ‚Äì Rojo: ${semCounts.rojo} ¬∑ Amarillo: ${semCounts.amarillo} ¬∑ Verde: ${semCounts.verde}`);
  lines.push('');
  lines.push('3) Categor√≠as que m√°s mueven la tendencia');
  lines.push('   Al alza:');
  upDrivers.forEach(d=> lines.push(`   ‚Ä¢ ${d.name}: pendiente +${d.slope.toFixed(2)} USD/mes (prom: ${fmtUSD(d.avg)})`));
  lines.push('   A la baja:');
  downDrivers.forEach(d=> lines.push(`   ‚Ä¢ ${d.name}: pendiente ${d.slope.toFixed(2)} USD/mes (prom: ${fmtUSD(d.avg)})`));
  const topRojos = catTrends.filter(x=> x.slope>0 && x.slope > Math.max(1, 0.05*(x.avg||1))).slice(0,5);
  if (topRojos.length){
    lines.push('   (Top rojos a vigilar)');
    topRojos.forEach(tr => lines.push(`     ‚ó¶ ${tr.name}: +${tr.slope.toFixed(2)} USD/mes`));
  }
  lines.push('');
  lines.push('4) Lectura y riesgos');
  if (cv>0.35){ lines.push('   ‚Ä¢ Alta variabilidad mensual: considerar calendarizar gastos o revisar estacionalidad/one-offs.'); }
  if (slope>0 && (upDrivers[0]?.slope||0) > (0.2*(avg||1))){ lines.push('   ‚Ä¢ La tendencia ascendente est√° concentrada en pocas categor√≠as: riesgo de presi√≥n presupuestal focalizada.'); }
  if (topCats[0] && total>0 && (topCats[0].total/total) > 0.35){ lines.push(`   ‚Ä¢ Concentraci√≥n en ${topCats[0].name}: >35% del total; monitorear dependencia y justificar variaciones.`); }
  lines.push('');
  lines.push('5) Recomendaciones de gesti√≥n');
  lines.push('   ‚Ä¢ Establecer topes mensuales por categor√≠a top y activar alertas (>10% sobre promedio).');
  lines.push('   ‚Ä¢ Revisar contratos/vales en categor√≠as con pendiente positiva elevada y negociar condiciones.');
  lines.push('   ‚Ä¢ Programar gastos estacionales para suavizar picos; usar compromisos (encumbrances) donde aplique.');
  lines.push('   ‚Ä¢ Preparar nota explicativa para el Board si el √∫ltimo mes muestra desviaciones >15% vs promedio.');

  const text = lines.join('\\n');
  const box = document.getElementById('execText');
  if (box) box.textContent = text;
  const wrap = document.getElementById('execWrap');
  if (wrap) wrap.classList.remove('hidden');

  const bPDF = document.getElementById('exportExecPDF');
  
if (bPDF){
  bPDF.onclick = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });
    const margin = 48, width = 540;
    const title = 'Reporte Ejecutivo ‚Äì Gastos';
    const project = STATE.projectTitle || '';
    const period = (STATE.months && STATE.months.length) ? (STATE.months[0] + ' ‚Äì ' + STATE.months[STATE.months.length-1]) : '';

    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text(title, margin, margin);
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    doc.text('Proyecto: ' + project, margin, margin+16);
    doc.text('Periodo: ' + period, margin, margin+30);

    let y = margin + 54;
    const addHeading = (txt)=>{ doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text(stripEmojis(txt), margin, y); y += 16; doc.setFont('helvetica','normal'); doc.setFontSize(10); };
    const addPara = (txt)=>{
      const lines = doc.splitTextToSize(stripEmojis(txt), width);
      lines.forEach(line => { if (y>780){ doc.addPage(); y = margin; } doc.text(line, margin, y); y += 14; });
    };
    const addList = (arr)=>{
      arr.forEach(item => {
        const lines = doc.splitTextToSize('‚Ä¢ ' + stripEmojis(item), width);
        lines.forEach((line, idx) => { if (y>780){ doc.addPage(); y = margin; } doc.text(line, margin, y); y += 14; });
      });
    };

    // Build sections from DOM bullets for clean structure
    const bulletsEl = document.getElementById('execBullets');
    if (bulletsEl){
      const groups = [];
      let current = null;
      bulletsEl.childNodes.forEach(node => {
        if (node.tagName === 'STRONG'){
          if (current) groups.push(current);
          current = { heading: node.textContent.trim(), items: [] };
        } else if (node.tagName === 'UL'){
          const lis = Array.from(node.querySelectorAll('li')).map(li => li.textContent.trim());
          if (!current) current = { heading: '', items: [] };
          current.items.push(...lis);
        } else if (node.tagName === 'DIV'){
          // plain line (e.g., sem√°foro counts)
          if (!current) current = { heading: '', items: [] };
          current.items.push(node.textContent.trim());
        }
      });
      if (current) groups.push(current);

      // Render each group
      groups.forEach(g => {
        if (g.heading){
          addHeading(g.heading);
        }
        if (g.items && g.items.length){
          addList(g.items);
          y += 6;
        }
      });
    } else {
      // Fallback: use text block
      addHeading('Resumen');
      addPara((document.getElementById('execText')?.textContent)||'');
    }

    doc.save('cbdio_exec_summary.pdf');
  };
}

  const bCopy = document.getElementById('copyExec');
  if (bCopy){
    bCopy.onclick = async () => {
      try{ await navigator.clipboard.writeText(text); alert('Reporte ejecutivo copiado al portapapeles.'); }
      catch(e){ alert('No se pudo copiar autom√°ticamente. Selecciona el texto y copia manualmente.'); }
    };
  }
}



// ====== Extra charts (Top5 share & MoM Top3) ======
function renderExtraCharts(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;

    // Build/refresh filter UI
    buildCategoryFilterUI();
    // Compute Top share according to selection
    const total = (STATE.totalsPerMonth||[]).reduce((a,b)=>a+b,0);
    const catsSorted = [...cats].sort((a,b)=> b.total - a.total);
    const sel = getTopShareSelection(total, catsSorted);
    const topNames = sel.selected.map(c=>c.name);
    const topVals = sel.selected.map(c=>c.total);
    const topShares = topVals.map(v => total? (v/total*100) : 0);
    const labelsShare = [...topNames, 'Otros'];
    const dataShare = [...topShares, total? (sel.others/total*100) : 0];
    const colorsShare = [...topNames.map(n=> colorFor(n)), '#9ca3af'];

    // Compute MoM deltas (last vs prev) per category
    const deltas = cats.map(c=> (c.monthly[c.monthly.length-1]||0) - (c.monthly[c.monthly.length-2]||0));
    const momArr = cats.map((c,i)=> ({ name:c.name, delta:deltas[i] }));
    const momUp = [...momArr].sort((a,b)=> b.delta - a.delta).slice(0,3);
    const momDown = [...momArr].sort((a,b)=> a.delta - b.delta).slice(0,3).reverse(); // make it descending absolute with negatives shown
    const momData = [...momUp, ...momDown.map(x=>({name:x.name, delta:x.delta}))]; // keep negatives

    // Show container
    const wrap = document.getElementById('charts3');
    if (wrap) wrap.classList.remove('hidden');

    // Render Top5 Share (bar horizontal)
    const shCtx = document.getElementById('top5Share').getContext('2d');
    if (charts.top5Share) charts.top5Share.destroy();
    charts.top5Share = new Chart(shCtx, {
      type: 'bar',
      data: { labels: labelsShare, datasets: [{ label: '% del total', data: dataShare, backgroundColor: colorsShare }] },
      options: {
        indexAxis: 'y',
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(ctx)=> ctx.parsed.x.toFixed(1) + '%' } } },
        scales:{ x:{ beginAtZero:true, ticks:{ callback:(v)=> v + '%' }, max:100 } }
      }
    });

    // Render MoM Top3 (barras, mezcla de positivos/negativos)
    const momCtx = document.getElementById('momTop3').getContext('2d');
    if (charts.momTop3) charts.momTop3.destroy();
    charts.momTop3 = new Chart(momCtx, {
      type: 'bar',
      data: { labels: momData.map(x=>x.name), datasets: [{ label: 'Œî √∫ltimo mes', data: momData.map(x=>x.delta), backgroundColor: momData.map(x=> x.delta>=0 ? '#10b981' : '#ef4444') }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(ctx)=> (ctx.parsed.y>=0?'+':'-') + Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(Math.abs(ctx.parsed.y)) } } },
        scales:{ y:{ beginAtZero:false } }
      }
    });

  }catch(e){ console.warn('renderExtraCharts failed', e); }
}


// ====== Category filter UI for Top Share ======
function buildCategoryFilterUI(){
  const modeSel = document.getElementById('topShareMode');
  const panel = document.getElementById('customCatPanel');
  const list = document.getElementById('customCatList');
  const btnAll = document.getElementById('btnAllCats');
  const btnNone = document.getElementById('btnNoneCats');
  const btnApply = document.getElementById('btnApplyCats');
  if (!modeSel || !panel || !list) return;

  // Populate checkbox list from STATE.cats, ordered by total desc
  const cats = [...(STATE.cats||[])].sort((a,b)=> b.total - a.total);
  // Restore previous mode/selection if available on first build
  if (!STATE.__restored){ restoreModeAndSelection(); STATE.__restored = true; }

  list.innerHTML = cats.map((c,i)=>{
    const checked = (STATE.customCats.length ? STATE.customCats.includes(c.name) : (i<5));
    return `<label style="display:inline-flex;align-items:center;gap:6px;margin:4px 10px 4px 0">
      <input type="checkbox" data-cat="${c.name.replace(/"/g,'&quot;')}" ${checked?'checked':''}/>
      <span>${c.name}</span>
    </label>`;
  }).join('');

  modeSel.value = STATE.shareMode || 'top5'; seedDefaultPresetsIfEmpty(); populatePresetSelect(); attachPresetHandlers(); attachSearchHandler();
  panel.classList.toggle('hidden', modeSel.value !== 'custom');

  modeSel.onchange = () => {
    STATE.shareMode = modeSel.value;
    panel.classList.toggle('hidden', STATE.shareMode !== 'custom');
    persistModeAndSelection();
    // If not custom, re-render directly
    if (STATE.shareMode !== 'custom'){
      renderExtraCharts();
    }
  };

  btnAll.onclick = () => {
    list.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = true);
  };
  btnNone.onclick = () => {
    list.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = false);
  };
  btnApply.onclick = () => {
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    STATE.customCats = chosen;
    persistModeAndSelection();
    renderExtraCharts();
  };
}

function getTopShareSelection(total, catsSorted){
  // catsSorted: [{name,total,monthly}...] sorted desc by total
  let selected = [];
  if (STATE.shareMode === 'top10'){
    selected = catsSorted.slice(0,10);
  } else if (STATE.shareMode === 'custom'){
    const set = new Set(STATE.customCats||[]);
    selected = catsSorted.filter(c => set.has(c.name));
    if (!selected.length){ selected = catsSorted.slice(0,5); } // fallback
  } else { // top5 default
    selected = catsSorted.slice(0,5);
  }
  const selTotal = selected.reduce((a,c)=> a + c.total, 0);
  const others = Math.max(0, total - selTotal);
  return { selected, others };
}


// ====== Presets & Search for category filter ======
const PRESET_KEY = 'cbdio_topshare_presets_v1';
const MODE_KEY = 'cbdio_topshare_mode';
const SEL_KEY = 'cbdio_topshare_customCats';

function loadPresets(){
  try{ return JSON.parse(localStorage.getItem(PRESET_KEY) || '{}'); }catch(e){ return {}; }
}
function savePresets(obj){
  try{ localStorage.setItem(PRESET_KEY, JSON.stringify(obj)); }catch(e){}
}
function persistModeAndSelection(){
  try{
    localStorage.setItem(MODE_KEY, STATE.shareMode || 'top5');
    localStorage.setItem(SEL_KEY, JSON.stringify(STATE.customCats || []));
  }catch(e){}
}
function restoreModeAndSelection(){
  try{
    const m = localStorage.getItem(MODE_KEY);
    const s = localStorage.getItem(SEL_KEY);
    if (m) STATE.shareMode = m;
    if (s) STATE.customCats = JSON.parse(s);
  }catch(e){}
}

function populatePresetSelect(){
  const sel = document.getElementById('presetSelect');
  if (!sel) return;
  const presets = loadPresets();
  const names = Object.keys(presets).sort();
  sel.innerHTML = '<option value="">(elige un preset)</option>' + names.map(n => `<option value="${n}">${n}</option>`).join('');
}

function attachPresetHandlers(){
  const btnLoad = document.getElementById('btnLoadPreset');
  const btnSave = document.getElementById('btnSavePreset');
  const btnDel  = document.getElementById('btnDeletePreset');
  const sel     = document.getElementById('presetSelect');
  const list    = document.getElementById('customCatList');

  if (btnLoad) btnLoad.onclick = () => {
    const name = sel && sel.value;
    if (!name) return;
    const presets = loadPresets();
    if (presets[name]){
      STATE.customCats = presets[name];
      // Reflect in checkboxes
      list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = STATE.customCats.includes(cb.getAttribute('data-cat'));
      });
      renderExtraCharts();
    }
  };

  if (btnSave) btnSave.onclick = () => {
    const name = prompt('Nombre del preset:');
    if (!name) return;
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    const presets = loadPresets();
    presets[name] = chosen;
    savePresets(presets);
    populatePresetSelect();
    alert('Preset guardado.');
  };

  if (btnDel) btnDel.onclick = () => {
    const name = sel && sel.value;
    if (!name) return;
    const presets = loadPresets();
    if (presets[name]){
      if (confirm('¬øEliminar preset "'+name+'"?')){
        delete presets[name];
        savePresets(presets);
        populatePresetSelect();
        alert('Preset eliminado.');
      }
    }
  };
}

function attachSearchHandler(){
  const input = document.getElementById('catSearch');
  const list  = document.getElementById('customCatList');
  if (!input || !list) return;
  input.oninput = () => {
    const q = input.value.trim().toLowerCase();
    list.querySelectorAll('label').forEach(lbl => {
      const text = lbl.textContent.toLowerCase();
      lbl.style.display = (!q || text.includes(q)) ? 'inline-flex' : 'none';
    });
  };
}


// ====== Seed default presets: Direct vs Indirect ======
function categorizeDefaultBuckets(catNames){
  const direct = new Set();
  const indirect = new Set();
  const push = (set, name) => set.add(name);

  catNames.forEach(name => {
    const low = name.toLowerCase();
    // Likely DIRECT
    if (/(salary|wage)/.test(low)) return push(direct, name);
    if (/(benefit|payroll|fringe|medical|vision|dental|life)/.test(low)) return push(direct, name);
    if (/(stipend|scholar)/.test(low)) return push(direct, name);
    if (/(program supplies|workshop|event)/.test(low)) return push(direct, name);
    if (/(travel|mileage|lodging|hotel|meals)/.test(low)) return push(direct, name);
    if (/(training|capacity)/.test(low)) return push(direct, name);
    if (/(consultant|contract service)/.test(low)) return push(direct, name);
    if (/(equipment)/.test(low)) return push(direct, name);
    if (/(printing|copy)/.test(low)) return push(direct, name);
    // Likely INDIRECT
    if (/(office rent|rent)/.test(low)) return push(indirect, name);
    if (/(office expenses|office|postage|mail|software)/.test(low)) return push(indirect, name);
    if (/(internet|communication|telephone|web)/.test(low)) return push(indirect, name);
    if (/(utilities|maintenance|janitorial|repair)/.test(low)) return push(indirect, name);
    if (/(marketing|advertising)/.test(low)) return push(indirect, name);
    if (/(insurance)/.test(low)) return push(indirect, name);
    if (/(indirect)/.test(low)) return push(indirect, name);
    // Fallback: lean to INDIRECT
    push(indirect, name);
  });

  return { direct: Array.from(direct), indirect: Array.from(indirect) };
}

function seedDefaultPresetsIfEmpty(){
  const presets = loadPresets();
  if (Object.keys(presets).length > 0) return; // already have user presets

  const catNames = (STATE.cats||[]).map(c=>c.name);
  const { direct, indirect } = categorizeDefaultBuckets(catNames);

  // Only save if we have at least something
  if (direct.length || indirect.length){
    presets['Direct'] = direct;
    presets['Indirect'] = indirect;
    savePresets(presets);
  }
}


// ====== Manager Tables Renderer ======
function renderManagerTables(){
  try{
    const months = STATE.months||[];
    const cats = (STATE.cats||[]).filter(c => /(expense|expenses)/i.test(c.name) and not re.search(r'(^|\s)(other\s+)?revenue', c.name, re.I));
    if (!months.length || !cats.length) return;

    // ---- Top categor√≠as por gasto ----
    const totalAll = (STATE.totalsPerMonth||[]).reduce((a,b)=>a+b,0) || 1;
    const topSorted = [...cats].sort((a,b)=> b.total - a.total).slice(0,5);
    const tbodyTop = document.querySelector('#tblTopCats tbody');
    if (tbodyTop){
      tbodyTop.innerHTML = '';
      const maxTotal = topSorted.length ? Math.max(...topSorted.map(c=>c.total)) : 1;
      topSorted.forEach((c,idx)=>{
        const avg = c.total/(c.monthly.length||1);
        const s = slopePerMonth(c.monthly||[]);
        const tag = s>Math.max(1,.05*(avg||1)) ? 'üìà Al alza' : (s<-Math.max(1,.05*(avg||1)) ? 'üìâ A la baja' : '‚û°Ô∏è Estable');
        const pct = (c.total/totalAll*100);
        const color = colorFor(c.name);
        const barW = Math.max(4, (c.total/maxTotal)*100);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx+1}</td>
          <td>${c.name}</td>
          <td style="text-align:right">${fmtUSD(c.total)}</td>
          <td style="text-align:right">${pct.toFixed(1)}%</td>
          <td style="text-align:right">${fmtUSD(avg)}</td>
          <td>${tag}</td>
          <td><div class="barcell"><div class="barfill" style="width:${barW}%;background:${color}33"></div></div></td>`;
        tbodyTop.appendChild(tr);
      });
    }

    // ---- Heatmap mensual por categor√≠a ----
    const head = document.getElementById('hmHead');
    const body = document.getElementById('hmBody');
    if (head && body){
      head.innerHTML = '<tr><th>Categor√≠a</th>' + months.map(m=> `<th>${m}</th>`).join('') + '<th style="text-align:right">Total</th></tr>';
      body.innerHTML = '';
      // Global min/max for scaling
      let gmin = Infinity, gmax = -Infinity;
      cats.forEach(c => (c.monthly||[]).forEach(v => { gmin = Math.min(gmin, v||0); gmax = Math.max(gmax, v||0); }));
      if (!isFinite(gmin)) gmin = 0; if (!isFinite(gmax) || gmax<=0) gmax = 1;
      function cellColor(v){
        const x = Math.max(0, Math.min(1, v/gmax));
        // scale green->yellow->red
        const r = Math.round(255 * x);
        const g = Math.round(200 * (1 - x) + 40);
        const b = 80;
        return `rgba(${r},${g},${b},0.18)`;
      }
      const catsSorted = [...cats].sort((a,b)=> b.total - a.total);
      catsSorted.forEach(c => {
        const tr = document.createElement('tr');
        let tds = `<td>${c.name}</td>`;
        (c.monthly||[]).forEach(v => {
          tds += `<td class="hmcell" style="background:${cellColor(v||0)}">${v?fmtUSD(v):''}</td>`;
        });
        tds += `<td style="text-align:right">${fmtUSD(c.total||0)}</td>`;
        tr.innerHTML = tds;
        body.appendChild(tr);
      });
    }

    // ---- Direct vs Indirect (tabla) ----
    const diBody = document.querySelector('#tblDirectIndirect tbody');
    if (diBody){
      diBody.innerHTML = '';
      const names = cats.map(c=> c.name);
      // Use existing heuristics from V19
      const buckets = categorizeDefaultBuckets ? categorizeDefaultBuckets(names) : { direct:names, indirect:[] };
      const setD = new Set(buckets.direct||[]);
      let totalD = 0, totalI = 0;
      cats.forEach(c => { if (setD.has(c.name)) totalD += c.total; else totalI += c.total; });
      const tot = totalD + totalI || 1;
      const pD = (totalD/tot*100), pI = (totalI/tot*100);

      function barHTML(pct, color){ return `<div class="barcell"><div class="barfill" style="width:${pct.toFixed(1)}%;background:${color}66"></div></div>`; }

      const trD = document.createElement('tr');
      trD.innerHTML = `<td>Direct</td><td style="text-align:right">${fmtUSD(totalD)}</td><td style="text-align:right">${pD.toFixed(1)}%</td><td>${barHTML(pD,'#10b981')}</td>`;
      const trI = document.createElement('tr');
      trI.innerHTML = `<td>Indirect</td><td style="text-align:right">${fmtUSD(totalI)}</td><td style="text-align:right">${pI.toFixed(1)}%</td><td>${barHTML(pI,'#7c3aed')}</td>`;

      diBody.appendChild(trD);
      diBody.appendChild(trI);
    }
  }catch(e){ console.warn('renderManagerTables failed', e); }
}


// ====== Zero-month filter: drop months with total 0 ======
function applyZeroMonthFilter(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;
    // compute totals per month from categories if missing
    const n = (cats[0].monthly||[]).length;
    const totals = Array(n).fill(0);
    cats.forEach(c => { for(let i=0;i<n;i++){ totals[i] += (c.monthly[i]||0); } });
    // indices where totals > 0
    const keepIdx = [];
    for (let i=0;i<n;i++){ if (Math.abs(totals[i]) > 1e-9) keepIdx.push(i); }
    if (keepIdx.length === n) { STATE.totalsPerMonth = totals; return; } // nothing to drop

    // Filter months and cat series
    STATE.months = keepIdx.map(i => months[i]);
    STATE.cats = cats.map(c => ({
      name: c.name,
      monthly: keepIdx.map(i => c.monthly[i]||0),
      total: keepIdx.reduce((s,i)=> s + (c.monthly[i]||0), 0)
    }));
    // Recompute totalsPerMonth
    const totals2 = Array(keepIdx.length).fill(0);
    STATE.cats.forEach(c => { for(let i=0;i<keepIdx.length;i++){ totals2[i] += (c.monthly[i]||0); } });
    STATE.totalsPerMonth = totals2;
  }catch(e){ console.warn('applyZeroMonthFilter failed', e); }
}


// ====== Comparator Chart ======
function buildComparatorUI(){
  const list = document.getElementById('cmpList');
  if (!list) return;
  const cats = STATE.cats || [];
  // order by total desc
  const ordered = [...cats].sort((a,b)=> b.total - a.total);
  list.innerHTML = ordered.map(c => `
    <label style="display:inline-flex;align-items:center;gap:6px;margin:4px 10px 4px 0">
      <input type="checkbox" data-cat="${c.name.replace(/"/g,'&quot;')}"/>
      <span>${c.name}</span>
    </label>
  `).join('');

  const btnTop = document.getElementById('btnCmpTop5');
  const btnClr = document.getElementById('btnCmpClear');
  const btnApp = document.getElementById('btnCmpApply');
  const modeSel = document.getElementById('cmpMode');

  const maxSel = 6;
  function applyTop(n=5){
    list.querySelectorAll('input[type="checkbox"]').forEach((cb,idx)=> cb.checked = (idx<n));
  }
  function clearAll(){
    list.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = false);
  }
  function getChosen(){
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    return chosen.slice(0, maxSel);
  }
  if (btnTop && !btnTop.__wired){ btnTop.__wired = true; btnTop.onclick = ()=> { applyTop(5); renderComparator(); }; }
  if (btnClr && !btnClr.__wired){ btnClr.__wired = true; btnClr.onclick = ()=> { clearAll(); renderComparator(); }; }
  if (btnApp && !btnApp.__wired){ btnApp.__wired = true; btnApp.onclick = ()=> renderComparator(); }
  if (modeSel && !modeSel.__wired){ modeSel.__wired = true; modeSel.onchange = ()=> renderComparator(); }

  // default to Top 5
  applyTop(5);
}

function renderComparator(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;
    const modeSel = document.getElementById('cmpMode');
    const mode = modeSel ? modeSel.value : 'line';
    const list = document.getElementById('cmpList');
    if (!list) return;
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    const chosenSet = new Set(chosen);
    const picked = cats.filter(c => chosenSet.has(c.name)).slice(0,6);

    const datasets = picked.map(c => ({
      label: c.name,
      data: c.monthly,
      borderColor: colorFor(c.name),
      backgroundColor: colorFor(c.name) + '33',
      fill: (mode === 'line') ? false : true,
      tension: 0.25
    }));

    const ctx = document.getElementById('cmpChart').getContext('2d');
    if (!window.charts) window.charts = {};
    if (charts.cmpChart) { try{ charts.cmpChart.destroy(); }catch(e){} }
    charts.cmpChart = new Chart(ctx, {
      type: (mode === 'line') ? 'line' : 'bar',
      data: { labels: months, datasets: datasets },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ position:'bottom' } },
        scales: (mode==='bar') ? { x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } } : { y:{ beginAtZero:true } }
      }
    });
  }catch(e){ console.warn('renderComparator failed', e); }
}


// ====== Chart dropdown filters (scoped) ======
function populateChartFiltersScoped(){
  try{
    const cats = (STATE.cats||[]).slice().sort((a,b)=> b.total - a.total);
    const inject = (containerId)=>{
      const box = document.getElementById(containerId);
      if (!box) return;
      box.innerHTML = cats.map(c => `<label><input type="checkbox" value="${c.name.replace(/"/g,'&quot;')}"/> <span>${c.name}</span></label>`).join('');
    };
    inject('donutChecks'); inject('stackChecks');

    // buttons
    const on = (id, fn)=>{ const el = document.getElementById(id); if (el && !el.__wired){ el.__wired = true; el.onclick = fn; } };
    const selectTop = (wrapId, n)=>{
      const box = document.getElementById(wrapId);
      if (!box) return;
      const inputs = Array.from(box.querySelectorAll('input[type="checkbox"]'));
      inputs.forEach((cb,i)=> cb.checked = (i < n));
    };
    const clearAll = (wrapId)=>{
      const box = document.getElementById(wrapId);
      if (!box) return;
      box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false);
    };
    const reRender = ()=>{ try{ renderCharts(STATE.months||[], STATE.cats||[]); }catch(e){} };

    on('donutTop5', ()=>{ selectTop('donutChecks',5); reRender(); });
    on('donutClear', ()=>{ clearAll('donutChecks'); reRender(); });
    on('donutApply', ()=>{ reRender(); });

    on('stackTop8', ()=>{ selectTop('stackChecks',8); reRender(); });
    on('stackClear', ()=>{ clearAll('stackChecks'); reRender(); });
    on('stackApply', ()=>{ reRender(); });
  }catch(e){ console.warn('populateChartFiltersScoped failed', e); }
}
function getChecked(containerId){
  const box = document.getElementById(containerId);
  if (!box) return [];
  return Array.from(box.querySelectorAll('input[type="checkbox"]:checked')).map(i=> i.value);
}


// === Smart positioning for dropdown panels ===
(function smartPanels(){
  function adjustPanel(detailsEl, panelEl){
    if (!panelEl) return;
    // Reset classes
    panelEl.classList.remove('flip','modal');
    // If narrow viewport, modal class via CSS media already applies, but double-check for tiny heights
    const rect = panelEl.getBoundingClientRect();
    const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
    const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

    // If the panel would overflow to the right by >16px, flip to left
    if (rect.right > vw - 16) panelEl.classList.add('flip');
    // If the panel would overflow bottom by >16px, modal
    if (rect.bottom > vh - 16) panelEl.classList.add('modal');
  }

  function wireOne(detailsSel, panelSel){
    const d = document.querySelector(detailsSel);
    const p = document.querySelector(panelSel);
    if (!d || !p || d.__wired) return;
    d.__wired = true;
    d.addEventListener('toggle', ()=> { if (d.open) { setTimeout(()=> adjustPanel(d,p), 0); } });
    window.addEventListener('resize', ()=> { if (d.open) adjustPanel(d,p); });
    window.addEventListener('scroll', ()=> { if (d.open) adjustPanel(d,p); }, { passive:true });
  }

  // Wire both charts
  wireOne('.chart-filterbar details:nth-of-type(1)', '#donutPanel');
  wireOne('.chart-filterbar details:nth-of-type(2)', '#stackPanel');

  // Close on outside click when modal
  document.addEventListener('click', (ev)=>{
    const openDetails = Array.from(document.querySelectorAll('.chart-filterbar details[open]'));
    for (const d of openDetails){
      const panel = d.querySelector('.panel');
      if (panel && panel.classList.contains('modal')){
        if (!panel.contains(ev.target) && !d.querySelector('summary').contains(ev.target)){
          d.open = false;
        }
      }
    }
  });
})();  


// ====== Snapshot embed utilities ======
function getEmbeddedDataNode(){
  return document.getElementById('embeddedData');
}
function saveSnapshotToHTML(){
  try{
    const node = getEmbeddedDataNode();
    if (!node) return alert('No se encontr√≥ el contenedor de snapshot.');
    const payload = {
      months: STATE.months||[],
      cats: STATE.cats||[],
      totalsPerMonth: STATE.totalsPerMonth||[],
      meta: { generatedAt: new Date().toISOString(), version: 'v19-snapshot-1' }
    };
    node.textContent = JSON.stringify(payload);
    // Quick visual feedback
    const b = document.getElementById('btnEmbedSnapshot');
    if (b){ b.textContent = '‚úÖ Snapshot incrustado'; setTimeout(()=> b.textContent='üì¶ Guardar snapshot (incrustar datos)', 2000); }
  }catch(e){
    console.warn('saveSnapshotToHTML failed', e);
    alert('No se pudo guardar el snapshot.');
  }
}


function tryLoadEmbeddedSnapshot(){
  try{
    const node = document.getElementById('embeddedData');
    if (!node || !node.textContent) return false;
    const p = JSON.parse(node.textContent);
    if (!p || !Array.isArray(p.months) || !Array.isArray(p.cats)) return false;

    window.STATE = window.STATE || {};
    STATE.months = p.months || [];
    STATE.cats = p.cats || [];
    STATE.totalsPerMonth = Array.isArray(p.totalsPerMonth) ? p.totalsPerMonth.slice() : [];

    if ((!STATE.totalsPerMonth || !STATE.totalsPerMonth.length) && STATE.cats.length){
      const n = (STATE.cats[0].monthly||[]).length;
      const totals = Array(n).fill(0);
      STATE.cats.forEach(c => { for(let i=0;i<n;i++){ totals[i] += (c.monthly[i]||0); } });
      STATE.totalsPerMonth = totals;
    }

    const up = document.getElementById('uploadCard'); if (up) up.classList.add('hidden');
    const uz = document.getElementById('uploadZone'); if (uz) uz.classList.add('hidden');

    if (typeof renderKPI==='function') renderKPI(STATE.months, STATE.cats);
    if (typeof renderCharts==='function'){
      try{ renderCharts(STATE.months, STATE.totalsPerMonth, STATE.cats); }
      catch(e){ try{ renderCharts(STATE.months, STATE.cats); }catch(_){ } }
    }
    if (typeof renderTables==='function') renderTables(STATE.months, STATE.cats);
    if (typeof renderExtraCharts==='function') renderExtraCharts();
    if (typeof renderManagerTables==='function') renderManagerTables();
    if (typeof populateChartFiltersScoped==='function') populateChartFiltersScoped();
    if (typeof populateAllCatsFilter==='function') populateAllCatsFilter();
    if (typeof buildComparatorUI==='function') buildComparatorUI();
    if (typeof renderComparator==='function') renderComparator();
    return true;
  }catch(e){
    console.warn('tryLoadEmbeddedSnapshot failed', e);
    return false;
  }
}




// Wire snapshot button
(function(){
  const btn = document.getElementById('btnEmbedSnapshot');
  if (btn && !btn.__wired){
    btn.__wired = true;
    btn.addEventListener('click', (e)=>{ e.preventDefault(); saveSnapshotToHTML(); });
  }
})();
// Try to load embedded snapshot on startup
document.addEventListener('DOMContentLoaded', ()=> {
  try{ tryLoadEmbeddedSnapshot(); }catch(e){}
});


// ====== Download snapshot as self-contained HTML ======
function ensureSnapshotInDOM(){
  // If embeddedData is empty, write current STATE to it
  const node = document.getElementById('embeddedData');
  if (!node) return false;
  if (!node.textContent || node.textContent.trim()===''){
    if (!window.STATE || !Array.isArray(STATE.months) || !Array.isArray(STATE.cats)) return false;
    const payload = {
      months: STATE.months||[],
      cats: STATE.cats||[],
      totalsPerMonth: STATE.totalsPerMonth||[],
      meta: { generatedAt: new Date().toISOString(), version: 'v19-snapshot-1' }
    };
    node.textContent = JSON.stringify(payload);
  }
  return true;
}

function safeSlug(s){
  return String(s||'').normalize('NFKD').replace(/[^\w\s-]+/g,'').trim().replace(/[\s_-]+/g,'_').replace(/^_+|_+$/g,'');
}
function monthRangeStr(){
  try{
    const m = STATE.months||[];
    if (!m.length) return '';
    return `${m[0]}_a_${m[m.length-1]}`.replace(/\s+/g,'_');
  }catch(_){ return ''; }
}
function downloadSnapshotCopy(){
  try{
    if (!ensureSnapshotInDOM()){
      alert('Necesito que subas un Excel primero para poder generar la copia con datos.');
      return;
    }
    const project = safeSlug(STATE.projectTitle || 'Proyecto');
    const period = monthRangeStr();
    const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    const base = `CBDIO_${project}${period?`_${period}`:''}_${ts}.html`;

    const htmlText = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
    const blob = new Blob([htmlText], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.download = base;
    a.href = url;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
  }catch(e){
    console.warn('downloadSnapshotCopy failed', e);
    alert('No se pudo generar la copia con datos.');
  }
}



// Wire download snapshot button
(function(){
  const btn = document.getElementById('btnDownloadSnapshot');
  if (btn && !btn.__wired){
    btn.__wired = true;
    btn.addEventListener('click', (e)=>{ e.preventDefault(); downloadSnapshotCopy(); });
  }
})();


// ===== Export helpers =====
function canvasesToImages(scope=document){
  const canv = Array.from(scope.querySelectorAll('canvas'));
  const payload = [];
  canv.forEach(cv => {
    try{
      const url = cv.toDataURL('image/png');
      const img = document.createElement('img');
      img.src = url;
      img.alt = cv.id || 'chart';
      img.style.maxWidth = '100%';
      img.style.height = 'auto';
      payload.push({canvas: cv, image: img});
    }catch(e){ console.warn('toDataURL failed for', cv.id, e); }
  });
  return payload;
}
function freezeDomClone(){
  // Clone full document to avoid mutating live dashboard
  const clone = document.documentElement.cloneNode(true);
  // Remove scripts to avoid re-running code in snapshot
  clone.querySelectorAll('script').forEach(s => s.remove());
  // Replace canvases with images
  const pairs = canvasesToImages(document);
  pairs.forEach(({canvas, image})=>{
    const sel = canvas.id ? `#${CSS.escape(canvas.id)}` : null;
    const twin = sel ? clone.querySelector(sel) : null;
    if (twin && twin.tagName.toLowerCase()==='canvas'){
      twin.replaceWith(image.cloneNode(true));
    }
  });
  // Add export-clean class and hide uploader
  clone.querySelector('body')?.classList.add('export-clean');
  const up = clone.querySelector('#uploadCard'); if (up) up.remove();
  const uz = clone.querySelector('#uploadZone'); if (uz) uz.remove();
  return '<!DOCTYPE html>\n' + clone.outerHTML;
}
function downloadBlob(text, filename, type='text/html'){
  const blob = new Blob([text], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
}
function buildExportFilename(ext){
  function safeSlug(s){
    return String(s||'').normalize('NFKD').replace(/[^\w\s-]+/g,'').trim().replace(/[\s_-]+/g,'_').replace(/^_+|_+$/g,'');
  }
  function monthRangeStr(){
    try{
      const m = STATE.months||[]; if (!m.length) return '';
      return `${m[0]}_a_${m[m.length-1]}`.replace(/\s+/g,'_');
    }catch(_){ return ''; }
  }
  function totalStr(){
    try{
      const t = (STATE.totalsPerMonth||[]).reduce((a,b)=>a+(b||0),0) || 0;
      return t ? ('Tot_' + t.toFixed(2).replace(/\./g,'_')) : '';
    }catch(_){ return ''; }
  }
  const proj = safeSlug(STATE.projectTitle || 'Proyecto');
  const pid  = STATE.projectId ? ('ID_' + safeSlug(STATE.projectId)) : '';
  const per  = monthRangeStr();
  const tot  = totalStr();
  const ts   = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  const parts = ['CBDIO', proj]; if (pid) parts.push(pid); if (per) parts.push(per); if (tot) parts.push(tot); parts.push(ts);
  return parts.join('_') + '.' + ext;
}
// Freeze & download HTML
function onFreezeHTML(){
  try{
    const frozen = freezeDomClone();
    const fname = buildExportFilename('html');
    downloadBlob(frozen, fname, 'text/html');
  }catch(e){
    console.warn('Freeze HTML failed', e);
    alert('No se pudo generar el HTML congelado.');
  }
}
// Export to PDF via print (clean mode)
function onExportPDF(){
  try{
    document.body.classList.add('export-clean');
    setTimeout(()=> window.print(), 50);
    setTimeout(()=> document.body.classList.remove('export-clean'), 1500);
  }catch(e){
    console.warn('Export PDF failed', e);
    document.body.classList.remove('export-clean');
    alert('No se pudo preparar el PDF.');
  }
}
// PPTX best-effort using PptxGenJS from CDN
async function ensurePptx(){
  if (window.PptxGenJS) return window.PptxGenJS;
  await new Promise((res, rej)=>{
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js';
    s.onload = res; s.onerror = rej; document.head.appendChild(s);
  });
  return window.PptxGenJS;
}
async function onExportPPTX(){
  try{
    await ensurePptx();
    const PptxGenJS = window.PptxGenJS;
    const pptx = new PptxGenJS();
    pptx.author = 'CBDIO Dashboard'; pptx.company = 'CBDIO';
    const title = STATE.projectTitle || 'Reporte de Gastos';
    const per = (STATE.months||[]); const period = per.length? (per[0] + ' ‚Äì ' + per[per.length-1]) : '';
    // Title slide
    let slide = pptx.addSlide();
    slide.addText('Centro Binacional para el Desarrollo Ind√≠gena Oaxaque√±o', { x:0.5, y:0.5, w:9, h:0.6, fontSize:20, bold:true, color:'000000' });
    slide.addText('An√°lisis Financiero (JLE)', { x:0.5, y:1.1, w:9, h:0.5, fontSize:18, color:'000000' });
    slide.addText(`${title}${period?' ¬∑ '+period:''}`, { x:0.5, y:1.7, w:9, h:0.5, fontSize:16, color:'000000' });

    // Collect chart images
    const charts = Array.from(document.querySelectorAll('canvas')).map(cv=>({ id: cv.id, data: cv.toDataURL('image/png') })).filter(o=>o.data);

    for (const chunk of charts){
      const s = pptx.addSlide();
      s.addText(chunk.id || 'Gr√°fica', { x:0.5, y:0.4, w:9, h:0.4, fontSize:16, color:'000000' });
      s.addImage({ data: chunk.data, x:0.5, y:0.9, w:8.5, h:4.5 });
    }

    const fname = buildExportFilename('pptx');
    await pptx.writeFile({ fileName: fname });
  }catch(e){
    console.warn('Export PPTX failed', e);
    alert('No se pudo generar el PPTX (intenta con el HTML congelado o PDF).');
  }
}

// Wire toolbar
(function(){
  const b1 = document.getElementById('btnFreezeHTML');
  const b2 = document.getElementById('btnExportPDF');
  const b3 = document.getElementById('btnExportPPTX');
  if (b1 && !b1.__wired){ b1.__wired = true; b1.addEventListener('click', onFreezeHTML); }
  if (b2 && !b2.__wired){ b2.__wired = true; b2.addEventListener('click', onExportPDF); }
  if (b3 && !b3.__wired){ b3.__wired = true; b3.addEventListener('click', onExportPPTX); }
})();


// ===== All Cats Trend interactive filters =====
window.__allCatsSelection = null; // Set of selected names or null for default
function populateAllCatsFilter(){
  try{
    const box = document.getElementById('allCatsChecks');
    if (!box) return;
    const cats = (STATE.cats||[]).slice().sort((a,b)=> b.total - a.total);
    box.innerHTML = cats.map(c => `<label style="display:flex;align-items:center;gap:6px;padding:4px 2px"><input type="checkbox" value="${c.name.replace(/"/g,'&quot;')}"/> <span>${c.name}</span></label>`).join('');
    // restore selection if present
    const sel = window.__allCatsSelection;
    if (sel && sel.size){
      box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = sel.has(cb.value));
    } else {
      // default to Top 10
      Array.from(box.querySelectorAll('input[type="checkbox"]')).forEach((cb,i)=> cb.checked = (i<10));
    }
    // Wire buttons
    const on = (id, fn)=>{ const el = document.getElementById(id); if (el && !el.__wired){ el.__wired=true; el.onclick=fn; } };
    const chooseTop = (n)=>{
      const inputs = Array.from(box.querySelectorAll('input[type="checkbox"]'));
      inputs.forEach((cb,i)=> cb.checked = (i < n));
      autoApplyAllCats();
    };
    const chooseAll = ()=>{ box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=true); autoApplyAllCats(); };
    const chooseNone = ()=>{ box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false); autoApplyAllCats(); };
    on('allCatsTop5', ()=> chooseTop(5));
    on('allCatsTop10', ()=> chooseTop(10));
    on('allCatsAll', chooseAll);
    on('allCatsNone', chooseNone);
    on('allCatsApply', ()=> autoApplyAllCats(true));

    // search filtering
    const search = document.getElementById('allCatsSearch');
    if (search && !search.__wired){
      search.__wired = true;
      search.addEventListener('input', ()=>{
        const q = search.value.trim().toLowerCase();
        Array.from(box.querySelectorAll('label')).forEach(lab=>{
          const txt = (lab.textContent||'').toLowerCase();
          lab.style.display = txt.includes(q) ? '' : 'none';
        });
      });
    }
    // auto-apply on change
    if (!box.__wiredChange){
      box.__wiredChange = true;
      box.addEventListener('change', ()=> autoApplyAllCats());
    }
  }catch(e){ console.warn('populateAllCatsFilter failed', e); }
}
function getAllCatsSelected(){
  const box = document.getElementById('allCatsChecks');
  if (!box) return [];
  return Array.from(box.querySelectorAll('input[type="checkbox"]:checked')).map(i=> i.value);
}
function autoApplyAllCats(force=false){
  try{
    const picked = getAllCatsSelected();
    window.__allCatsSelection = picked.length ? new Set(picked) : (force ? new Set() : null);
    // Re-render charts, which will read the selection
    renderCharts(STATE.months||[], STATE.totalsPerMonth||[], STATE.cats||[]);
  }catch(e){ console.warn('autoApplyAllCats failed', e); }
}







</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js">
// ====== Executive Analysis ======
function perc(x){ return (x*100).toFixed(1)+'%'; }
function safeDiv(a,b){ return b && b!=0 ? (a/b) : 0; } // Pythonic; fix to JS below

function generateExecutiveAnalysis(){
  const months = STATE.months || [];
  const cats = STATE.cats || [];
  if (!months.length || !cats.length){ document.getElementById('execWrap').classList.add('hidden'); return; }

  // Top categories
  const topCats = [...cats].sort((a,b)=> b.total - a.total).slice(0,5);

  // Overall trend & volatility
  const m = STATE.totalsPerMonth || [];
  const n = m.length;
  const total = m.reduce((a,b)=>a+b,0);
  const avg = total / (n||1);
  const slope = slopePerMonth(m);
  const last = m[n-1] || 0, first = m[0] || 0;
  const mom = n>1 ? (last - (m[n-2]||0)) : 0;
  const yoy = n>12 ? (last - (m[n-13]||0)) : null;

  // volatility (coeficiente de variaci√≥n)
  const varc = m.reduce((acc,v)=> acc + Math.pow(v-avg,2), 0) / (n || 1);

  const stdev = Math.sqrt(varc);
  const cv = avg ? stdev/avg : 0;

  // Category drivers (slopes)
  const catTrends = cats.map(c=>({ 
    name:c.name, 
    slope:slopePerMonth(c.monthly), 
    total:c.total, 
    last:c.monthly[c.monthly.length-1]||0,
    avg:c.total/(c.monthly.length||1)
  })).sort((a,b)=> Math.abs(b.slope) - Math.abs(a.slope));

  const upDrivers = catTrends.filter(x=>x.slope>0).slice(0,3);
  const downDrivers = catTrends.filter(x=>x.slope<0).slice(0,3);

  // Build narrative
  const lines = [];
  lines.push(`Proyecto: ${STATE.projectTitle}`);
  lines.push(`Periodo: ${months[0]} ‚Äì ${months[months.length-1]}`);
  lines.push('');
  lines.push('1) Resumen ejecutivo');
  const slopeTxt = (slope>=0?'+':'-') + Math.abs(slope).toFixed(2) + ' USD/mes';
  const momTxt = (mom>=0?'+':'-') + Math.abs(mom).toFixed(2);
  lines.push(`‚Ä¢ Gasto total: ${fmtUSD(total)} ¬∑ Promedio mensual: ${fmtUSD(avg)} ¬∑ Tendencia: ${slope>=0?'üìà al alza':'üìâ a la baja'} (${slopeTxt}). Volatilidad (CV): ${(cv*100).toFixed(1)}%.`);
  lines.push(`‚Ä¢ √öltimo mes vs anterior: ${mom>=0?'‚ñ≤':'‚ñº'} ${fmtUSD(Math.abs(mom))}${yoy!==null?` ¬∑ Œî vs hace 12 meses: ${yoy>=0?'‚ñ≤':'‚ñº'} ${fmtUSD(Math.abs(yoy))}`:''}.`);
  lines.push('');
  lines.push('2) Principales categor√≠as (Top 5 por gasto total)');
  topCats.forEach((c,i)=>{
    const s = slopePerMonth(c.monthly);
    lines.push(`   ${i+1}. ${c.name}: ${fmtUSD(c.total)} (${fmtUSD(c.total/(c.monthly.length||1))}/mes) ¬∑ Tendencia: ${s>=0?'üìà':'üìâ'} ${ (s>=0?'+':'-') + fmtUSD(Math.abs(s)).replace('$','') } USD/mes.`);
  });
  // Sem√°foro counts
  const semCounts = cats.reduce((acc,c)=>{ const avg = c.total/(c.monthly.length||1); const thr = Math.max(1, 0.05*(avg||1)); const s = slopePerMonth(c.monthly); if (s>thr) acc.rojo++; else if (s<-thr) acc.verde++; else acc.amarillo++; return acc; }, {rojo:0,amarillo:0,verde:0});
  lines.push(`‚Ä¢ Sem√°foro categor√≠as ‚Äì Rojo: ${semCounts.rojo} ¬∑ Amarillo: ${semCounts.amarillo} ¬∑ Verde: ${semCounts.verde}`);
  lines.push('');
  lines.push('3) Categor√≠as que m√°s mueven la tendencia');
  lines.push('   Al alza:');
  upDrivers.forEach(d=> lines.push(`   ‚Ä¢ ${d.name}: pendiente +${d.slope.toFixed(2)} USD/mes (prom: ${fmtUSD(d.avg)})`));
  const topRojos = catTrends.filter(x=> x.slope>0 && x.slope > Math.max(1, 0.05*(x.avg||1))).slice(0,5);
  if (topRojos.length){ lines.push('   (Top rojos a vigilar)'); topRojos.forEach(tr => lines.push(`     ‚ó¶ ${tr.name}: +${tr.slope.toFixed(2)} USD/mes`)); }
  lines.push('   A la baja:');
  downDrivers.forEach(d=> lines.push(`   ‚Ä¢ ${d.name}: pendiente ${d.slope.toFixed(2)} USD/mes (prom: ${fmtUSD(d.avg)})`));
  lines.push('');
  lines.push('4) Lectura y riesgos');
  if (cv>0.35){ lines.push('   ‚Ä¢ Alta variabilidad mensual: considerar calendarizar gastos o revisar estacionalidad/one-offs.'); }
  if (slope>0 && (upDrivers[0]?.slope||0) > (0.2*avg)){ lines.push('   ‚Ä¢ La tendencia ascendente est√° concentrada en pocas categor√≠as: riesgo de presi√≥n presupuestal focalizada.'); }
  if (topCats[0] && (topCats[0].total/total) > 0.35){ lines.push(`   ‚Ä¢ Concentraci√≥n en ${topCats[0].name}: >35% del total; monitorear dependencia y justificar variaciones.`); }
  lines.push('');
  lines.push('5) Recomendaciones de gesti√≥n');
  lines.push('   ‚Ä¢ Establecer topes mensuales por categor√≠a top y activar alertas (>10% sobre promedio).');
  lines.push('   ‚Ä¢ Revisar contratos/vales en categor√≠as con pendiente positiva elevada y negociar condiciones.');
  lines.push('   ‚Ä¢ Programar gastos estacionales para suavizar picos; usar compromisos (encumbrances) donde aplique.');
  lines.push('   ‚Ä¢ Preparar nota explicativa para el Board si el √∫ltimo mes muestra desviaciones >15% vs promedio.');

  const text = lines.join('\n');
  const box = document.getElementById('execText');
  box.textContent = text;
  document.getElementById('execWrap').classList.remove('hidden');

  // Export buttons
  const bPDF = document.getElementById('exportExecPDF');
  
if (bPDF){
  bPDF.onclick = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });
    const margin = 48, width = 540;
    const title = 'Reporte Ejecutivo ‚Äì Gastos';
    const project = STATE.projectTitle || '';
    const period = (STATE.months && STATE.months.length) ? (STATE.months[0] + ' ‚Äì ' + STATE.months[STATE.months.length-1]) : '';

    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text(title, margin, margin);
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    doc.text('Proyecto: ' + project, margin, margin+16);
    doc.text('Periodo: ' + period, margin, margin+30);

    let y = margin + 54;
    const addHeading = (txt)=>{ doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text(stripEmojis(txt), margin, y); y += 16; doc.setFont('helvetica','normal'); doc.setFontSize(10); };
    const addPara = (txt)=>{
      const lines = doc.splitTextToSize(stripEmojis(txt), width);
      lines.forEach(line => { if (y>780){ doc.addPage(); y = margin; } doc.text(line, margin, y); y += 14; });
    };
    const addList = (arr)=>{
      arr.forEach(item => {
        const lines = doc.splitTextToSize('‚Ä¢ ' + stripEmojis(item), width);
        lines.forEach((line, idx) => { if (y>780){ doc.addPage(); y = margin; } doc.text(line, margin, y); y += 14; });
      });
    };

    // Build sections from DOM bullets for clean structure
    const bulletsEl = document.getElementById('execBullets');
    if (bulletsEl){
      const groups = [];
      let current = null;
      bulletsEl.childNodes.forEach(node => {
        if (node.tagName === 'STRONG'){
          if (current) groups.push(current);
          current = { heading: node.textContent.trim(), items: [] };
        } else if (node.tagName === 'UL'){
          const lis = Array.from(node.querySelectorAll('li')).map(li => li.textContent.trim());
          if (!current) current = { heading: '', items: [] };
          current.items.push(...lis);
        } else if (node.tagName === 'DIV'){
          // plain line (e.g., sem√°foro counts)
          if (!current) current = { heading: '', items: [] };
          current.items.push(node.textContent.trim());
        }
      });
      if (current) groups.push(current);

      // Render each group
      groups.forEach(g => {
        if (g.heading){
          addHeading(g.heading);
        }
        if (g.items && g.items.length){
          addList(g.items);
          y += 6;
        }
      });
    } else {
      // Fallback: use text block
      addHeading('Resumen');
      addPara((document.getElementById('execText')?.textContent)||'');
    }

    doc.save('cbdio_exec_summary.pdf');
  };
}


  const bCopy = document.getElementById('copyExec');
  if (bCopy){
    bCopy.onclick = async () => {
      try{ await navigator.clipboard.writeText(text); alert('Reporte ejecutivo copiado al portapapeles.'); }
      catch(e){ alert('No se pudo copiar autom√°ticamente. Selecciona el texto y copia manualmente.'); }
    };
  }
}


// ====== Extra charts (Top5 share & MoM Top3) ======
function renderExtraCharts(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;

    // Build/refresh filter UI
    buildCategoryFilterUI();
    // Compute Top share according to selection
    const total = (STATE.totalsPerMonth||[]).reduce((a,b)=>a+b,0);
    const catsSorted = [...cats].sort((a,b)=> b.total - a.total);
    const sel = getTopShareSelection(total, catsSorted);
    const topNames = sel.selected.map(c=>c.name);
    const topVals = sel.selected.map(c=>c.total);
    const topShares = topVals.map(v => total? (v/total*100) : 0);
    const labelsShare = [...topNames, 'Otros'];
    const dataShare = [...topShares, total? (sel.others/total*100) : 0];
    const colorsShare = [...topNames.map(n=> colorFor(n)), '#9ca3af'];

    // Compute MoM deltas (last vs prev) per category
    const deltas = cats.map(c=> (c.monthly[c.monthly.length-1]||0) - (c.monthly[c.monthly.length-2]||0));
    const momArr = cats.map((c,i)=> ({ name:c.name, delta:deltas[i] }));
    const momUp = [...momArr].sort((a,b)=> b.delta - a.delta).slice(0,3);
    const momDown = [...momArr].sort((a,b)=> a.delta - b.delta).slice(0,3).reverse(); // make it descending absolute with negatives shown
    const momData = [...momUp, ...momDown.map(x=>({name:x.name, delta:x.delta}))]; // keep negatives

    // Show container
    const wrap = document.getElementById('charts3');
    if (wrap) wrap.classList.remove('hidden');

    // Render Top5 Share (bar horizontal)
    const shCtx = document.getElementById('top5Share').getContext('2d');
    if (charts.top5Share) charts.top5Share.destroy();
    charts.top5Share = new Chart(shCtx, {
      type: 'bar',
      data: { labels: labelsShare, datasets: [{ label: '% del total', data: dataShare, backgroundColor: colorsShare }] },
      options: {
        indexAxis: 'y',
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(ctx)=> ctx.parsed.x.toFixed(1) + '%' } } },
        scales:{ x:{ beginAtZero:true, ticks:{ callback:(v)=> v + '%' }, max:100 } }
      }
    });

    // Render MoM Top3 (barras, mezcla de positivos/negativos)
    const momCtx = document.getElementById('momTop3').getContext('2d');
    if (charts.momTop3) charts.momTop3.destroy();
    charts.momTop3 = new Chart(momCtx, {
      type: 'bar',
      data: { labels: momData.map(x=>x.name), datasets: [{ label: 'Œî √∫ltimo mes', data: momData.map(x=>x.delta), backgroundColor: momData.map(x=> x.delta>=0 ? '#10b981' : '#ef4444') }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(ctx)=> (ctx.parsed.y>=0?'+':'-') + Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(Math.abs(ctx.parsed.y)) } } },
        scales:{ y:{ beginAtZero:false } }
      }
    });

  }catch(e){ console.warn('renderExtraCharts failed', e); }
}


// ====== Category filter UI for Top Share ======
function buildCategoryFilterUI(){
  const modeSel = document.getElementById('topShareMode');
  const panel = document.getElementById('customCatPanel');
  const list = document.getElementById('customCatList');
  const btnAll = document.getElementById('btnAllCats');
  const btnNone = document.getElementById('btnNoneCats');
  const btnApply = document.getElementById('btnApplyCats');
  if (!modeSel || !panel || !list) return;

  // Populate checkbox list from STATE.cats, ordered by total desc
  const cats = [...(STATE.cats||[])].sort((a,b)=> b.total - a.total);
  // Restore previous mode/selection if available on first build
  if (!STATE.__restored){ restoreModeAndSelection(); STATE.__restored = true; }

  list.innerHTML = cats.map((c,i)=>{
    const checked = (STATE.customCats.length ? STATE.customCats.includes(c.name) : (i<5));
    return `<label style="display:inline-flex;align-items:center;gap:6px;margin:4px 10px 4px 0">
      <input type="checkbox" data-cat="${c.name.replace(/"/g,'&quot;')}" ${checked?'checked':''}/>
      <span>${c.name}</span>
    </label>`;
  }).join('');

  modeSel.value = STATE.shareMode || 'top5'; seedDefaultPresetsIfEmpty(); populatePresetSelect(); attachPresetHandlers(); attachSearchHandler();
  panel.classList.toggle('hidden', modeSel.value !== 'custom');

  modeSel.onchange = () => {
    STATE.shareMode = modeSel.value;
    panel.classList.toggle('hidden', STATE.shareMode !== 'custom');
    persistModeAndSelection();
    // If not custom, re-render directly
    if (STATE.shareMode !== 'custom'){
      renderExtraCharts();
    }
  };

  btnAll.onclick = () => {
    list.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = true);
  };
  btnNone.onclick = () => {
    list.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = false);
  };
  btnApply.onclick = () => {
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    STATE.customCats = chosen;
    persistModeAndSelection();
    renderExtraCharts();
  };
}

function getTopShareSelection(total, catsSorted){
  // catsSorted: [{name,total,monthly}...] sorted desc by total
  let selected = [];
  if (STATE.shareMode === 'top10'){
    selected = catsSorted.slice(0,10);
  } else if (STATE.shareMode === 'custom'){
    const set = new Set(STATE.customCats||[]);
    selected = catsSorted.filter(c => set.has(c.name));
    if (!selected.length){ selected = catsSorted.slice(0,5); } // fallback
  } else { // top5 default
    selected = catsSorted.slice(0,5);
  }
  const selTotal = selected.reduce((a,c)=> a + c.total, 0);
  const others = Math.max(0, total - selTotal);
  return { selected, others };
}


// ====== Presets & Search for category filter ======
const PRESET_KEY = 'cbdio_topshare_presets_v1';
const MODE_KEY = 'cbdio_topshare_mode';
const SEL_KEY = 'cbdio_topshare_customCats';

function loadPresets(){
  try{ return JSON.parse(localStorage.getItem(PRESET_KEY) || '{}'); }catch(e){ return {}; }
}
function savePresets(obj){
  try{ localStorage.setItem(PRESET_KEY, JSON.stringify(obj)); }catch(e){}
}
function persistModeAndSelection(){
  try{
    localStorage.setItem(MODE_KEY, STATE.shareMode || 'top5');
    localStorage.setItem(SEL_KEY, JSON.stringify(STATE.customCats || []));
  }catch(e){}
}
function restoreModeAndSelection(){
  try{
    const m = localStorage.getItem(MODE_KEY);
    const s = localStorage.getItem(SEL_KEY);
    if (m) STATE.shareMode = m;
    if (s) STATE.customCats = JSON.parse(s);
  }catch(e){}
}

function populatePresetSelect(){
  const sel = document.getElementById('presetSelect');
  if (!sel) return;
  const presets = loadPresets();
  const names = Object.keys(presets).sort();
  sel.innerHTML = '<option value="">(elige un preset)</option>' + names.map(n => `<option value="${n}">${n}</option>`).join('');
}

function attachPresetHandlers(){
  const btnLoad = document.getElementById('btnLoadPreset');
  const btnSave = document.getElementById('btnSavePreset');
  const btnDel  = document.getElementById('btnDeletePreset');
  const sel     = document.getElementById('presetSelect');
  const list    = document.getElementById('customCatList');

  if (btnLoad) btnLoad.onclick = () => {
    const name = sel && sel.value;
    if (!name) return;
    const presets = loadPresets();
    if (presets[name]){
      STATE.customCats = presets[name];
      // Reflect in checkboxes
      list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = STATE.customCats.includes(cb.getAttribute('data-cat'));
      });
      renderExtraCharts();
    }
  };

  if (btnSave) btnSave.onclick = () => {
    const name = prompt('Nombre del preset:');
    if (!name) return;
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    const presets = loadPresets();
    presets[name] = chosen;
    savePresets(presets);
    populatePresetSelect();
    alert('Preset guardado.');
  };

  if (btnDel) btnDel.onclick = () => {
    const name = sel && sel.value;
    if (!name) return;
    const presets = loadPresets();
    if (presets[name]){
      if (confirm('¬øEliminar preset "'+name+'"?')){
        delete presets[name];
        savePresets(presets);
        populatePresetSelect();
        alert('Preset eliminado.');
      }
    }
  };
}

function attachSearchHandler(){
  const input = document.getElementById('catSearch');
  const list  = document.getElementById('customCatList');
  if (!input || !list) return;
  input.oninput = () => {
    const q = input.value.trim().toLowerCase();
    list.querySelectorAll('label').forEach(lbl => {
      const text = lbl.textContent.toLowerCase();
      lbl.style.display = (!q || text.includes(q)) ? 'inline-flex' : 'none';
    });
  };
}


// ====== Seed default presets: Direct vs Indirect ======
function categorizeDefaultBuckets(catNames){
  const direct = new Set();
  const indirect = new Set();
  const push = (set, name) => set.add(name);

  catNames.forEach(name => {
    const low = name.toLowerCase();
    // Likely DIRECT
    if (/(salary|wage)/.test(low)) return push(direct, name);
    if (/(benefit|payroll|fringe|medical|vision|dental|life)/.test(low)) return push(direct, name);
    if (/(stipend|scholar)/.test(low)) return push(direct, name);
    if (/(program supplies|workshop|event)/.test(low)) return push(direct, name);
    if (/(travel|mileage|lodging|hotel|meals)/.test(low)) return push(direct, name);
    if (/(training|capacity)/.test(low)) return push(direct, name);
    if (/(consultant|contract service)/.test(low)) return push(direct, name);
    if (/(equipment)/.test(low)) return push(direct, name);
    if (/(printing|copy)/.test(low)) return push(direct, name);
    // Likely INDIRECT
    if (/(office rent|rent)/.test(low)) return push(indirect, name);
    if (/(office expenses|office|postage|mail|software)/.test(low)) return push(indirect, name);
    if (/(internet|communication|telephone|web)/.test(low)) return push(indirect, name);
    if (/(utilities|maintenance|janitorial|repair)/.test(low)) return push(indirect, name);
    if (/(marketing|advertising)/.test(low)) return push(indirect, name);
    if (/(insurance)/.test(low)) return push(indirect, name);
    if (/(indirect)/.test(low)) return push(indirect, name);
    // Fallback: lean to INDIRECT
    push(indirect, name);
  });

  return { direct: Array.from(direct), indirect: Array.from(indirect) };
}

function seedDefaultPresetsIfEmpty(){
  const presets = loadPresets();
  if (Object.keys(presets).length > 0) return; // already have user presets

  const catNames = (STATE.cats||[]).map(c=>c.name);
  const { direct, indirect } = categorizeDefaultBuckets(catNames);

  // Only save if we have at least something
  if (direct.length || indirect.length){
    presets['Direct'] = direct;
    presets['Indirect'] = indirect;
    savePresets(presets);
  }
}


// ====== Manager Tables Renderer ======
function renderManagerTables(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;

    // ---- Top categor√≠as por gasto ----
    const totalAll = (STATE.totalsPerMonth||[]).reduce((a,b)=>a+b,0) || 1;
    const topSorted = [...cats].sort((a,b)=> b.total - a.total).slice(0,5);
    const tbodyTop = document.querySelector('#tblTopCats tbody');
    if (tbodyTop){
      tbodyTop.innerHTML = '';
      const maxTotal = topSorted.length ? Math.max(...topSorted.map(c=>c.total)) : 1;
      topSorted.forEach((c,idx)=>{
        const avg = c.total/(c.monthly.length||1);
        const s = slopePerMonth(c.monthly||[]);
        const tag = s>Math.max(1,.05*(avg||1)) ? 'üìà Al alza' : (s<-Math.max(1,.05*(avg||1)) ? 'üìâ A la baja' : '‚û°Ô∏è Estable');
        const pct = (c.total/totalAll*100);
        const color = colorFor(c.name);
        const barW = Math.max(4, (c.total/maxTotal)*100);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx+1}</td>
          <td>${c.name}</td>
          <td style="text-align:right">${fmtUSD(c.total)}</td>
          <td style="text-align:right">${pct.toFixed(1)}%</td>
          <td style="text-align:right">${fmtUSD(avg)}</td>
          <td>${tag}</td>
          <td><div class="barcell"><div class="barfill" style="width:${barW}%;background:${color}33"></div></div></td>`;
        tbodyTop.appendChild(tr);
      });
    }

    // ---- Heatmap mensual por categor√≠a ----
    const head = document.getElementById('hmHead');
    const body = document.getElementById('hmBody');
    if (head && body){
      head.innerHTML = '<tr><th>Categor√≠a</th>' + months.map(m=> `<th>${m}</th>`).join('') + '<th style="text-align:right">Total</th></tr>';
      body.innerHTML = '';
      // Global min/max for scaling
      let gmin = Infinity, gmax = -Infinity;
      cats.forEach(c => (c.monthly||[]).forEach(v => { gmin = Math.min(gmin, v||0); gmax = Math.max(gmax, v||0); }));
      if (!isFinite(gmin)) gmin = 0; if (!isFinite(gmax) || gmax<=0) gmax = 1;
      function cellColor(v){
        const x = Math.max(0, Math.min(1, v/gmax));
        // scale green->yellow->red
        const r = Math.round(255 * x);
        const g = Math.round(200 * (1 - x) + 40);
        const b = 80;
        return `rgba(${r},${g},${b},0.18)`;
      }
      const catsSorted = [...cats].sort((a,b)=> b.total - a.total);
      catsSorted.forEach(c => {
        const tr = document.createElement('tr');
        let tds = `<td>${c.name}</td>`;
        (c.monthly||[]).forEach(v => {
          tds += `<td class="hmcell" style="background:${cellColor(v||0)}">${v?fmtUSD(v):''}</td>`;
        });
        tds += `<td style="text-align:right">${fmtUSD(c.total||0)}</td>`;
        tr.innerHTML = tds;
        body.appendChild(tr);
      });
    }

    // ---- Direct vs Indirect (tabla) ----
    const diBody = document.querySelector('#tblDirectIndirect tbody');
    if (diBody){
      diBody.innerHTML = '';
      const names = cats.map(c=> c.name);
      // Use existing heuristics from V19
      const buckets = categorizeDefaultBuckets ? categorizeDefaultBuckets(names) : { direct:names, indirect:[] };
      const setD = new Set(buckets.direct||[]);
      let totalD = 0, totalI = 0;
      cats.forEach(c => { if (setD.has(c.name)) totalD += c.total; else totalI += c.total; });
      const tot = totalD + totalI || 1;
      const pD = (totalD/tot*100), pI = (totalI/tot*100);

      function barHTML(pct, color){ return `<div class="barcell"><div class="barfill" style="width:${pct.toFixed(1)}%;background:${color}66"></div></div>`; }

      const trD = document.createElement('tr');
      trD.innerHTML = `<td>Direct</td><td style="text-align:right">${fmtUSD(totalD)}</td><td style="text-align:right">${pD.toFixed(1)}%</td><td>${barHTML(pD,'#10b981')}</td>`;
      const trI = document.createElement('tr');
      trI.innerHTML = `<td>Indirect</td><td style="text-align:right">${fmtUSD(totalI)}</td><td style="text-align:right">${pI.toFixed(1)}%</td><td>${barHTML(pI,'#7c3aed')}</td>`;

      diBody.appendChild(trD);
      diBody.appendChild(trI);
    }
  }catch(e){ console.warn('renderManagerTables failed', e); }
}


// ====== Zero-month filter: drop months with total 0 ======
function applyZeroMonthFilter(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;
    // compute totals per month from categories if missing
    const n = (cats[0].monthly||[]).length;
    const totals = Array(n).fill(0);
    cats.forEach(c => { for(let i=0;i<n;i++){ totals[i] += (c.monthly[i]||0); } });
    // indices where totals > 0
    const keepIdx = [];
    for (let i=0;i<n;i++){ if (Math.abs(totals[i]) > 1e-9) keepIdx.push(i); }
    if (keepIdx.length === n) { STATE.totalsPerMonth = totals; return; } // nothing to drop

    // Filter months and cat series
    STATE.months = keepIdx.map(i => months[i]);
    STATE.cats = cats.map(c => ({
      name: c.name,
      monthly: keepIdx.map(i => c.monthly[i]||0),
      total: keepIdx.reduce((s,i)=> s + (c.monthly[i]||0), 0)
    }));
    // Recompute totalsPerMonth
    const totals2 = Array(keepIdx.length).fill(0);
    STATE.cats.forEach(c => { for(let i=0;i<keepIdx.length;i++){ totals2[i] += (c.monthly[i]||0); } });
    STATE.totalsPerMonth = totals2;
  }catch(e){ console.warn('applyZeroMonthFilter failed', e); }
}


// ====== Comparator Chart ======
function buildComparatorUI(){
  const list = document.getElementById('cmpList');
  if (!list) return;
  const cats = STATE.cats || [];
  // order by total desc
  const ordered = [...cats].sort((a,b)=> b.total - a.total);
  list.innerHTML = ordered.map(c => `
    <label style="display:inline-flex;align-items:center;gap:6px;margin:4px 10px 4px 0">
      <input type="checkbox" data-cat="${c.name.replace(/"/g,'&quot;')}"/>
      <span>${c.name}</span>
    </label>
  `).join('');

  const btnTop = document.getElementById('btnCmpTop5');
  const btnClr = document.getElementById('btnCmpClear');
  const btnApp = document.getElementById('btnCmpApply');
  const modeSel = document.getElementById('cmpMode');

  const maxSel = 6;
  function applyTop(n=5){
    list.querySelectorAll('input[type="checkbox"]').forEach((cb,idx)=> cb.checked = (idx<n));
  }
  function clearAll(){
    list.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = false);
  }
  function getChosen(){
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    return chosen.slice(0, maxSel);
  }
  if (btnTop && !btnTop.__wired){ btnTop.__wired = true; btnTop.onclick = ()=> { applyTop(5); renderComparator(); }; }
  if (btnClr && !btnClr.__wired){ btnClr.__wired = true; btnClr.onclick = ()=> { clearAll(); renderComparator(); }; }
  if (btnApp && !btnApp.__wired){ btnApp.__wired = true; btnApp.onclick = ()=> renderComparator(); }
  if (modeSel && !modeSel.__wired){ modeSel.__wired = true; modeSel.onchange = ()=> renderComparator(); }

  // default to Top 5
  applyTop(5);
}

function renderComparator(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;
    const modeSel = document.getElementById('cmpMode');
    const mode = modeSel ? modeSel.value : 'line';
    const list = document.getElementById('cmpList');
    if (!list) return;
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    const chosenSet = new Set(chosen);
    const picked = cats.filter(c => chosenSet.has(c.name)).slice(0,6);

    const datasets = picked.map(c => ({
      label: c.name,
      data: c.monthly,
      borderColor: colorFor(c.name),
      backgroundColor: colorFor(c.name) + '33',
      fill: (mode === 'line') ? false : true,
      tension: 0.25
    }));

    const ctx = document.getElementById('cmpChart').getContext('2d');
    if (!window.charts) window.charts = {};
    if (charts.cmpChart) { try{ charts.cmpChart.destroy(); }catch(e){} }
    charts.cmpChart = new Chart(ctx, {
      type: (mode === 'line') ? 'line' : 'bar',
      data: { labels: months, datasets: datasets },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ position:'bottom' } },
        scales: (mode==='bar') ? { x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } } : { y:{ beginAtZero:true } }
      }
    });
  }catch(e){ console.warn('renderComparator failed', e); }
}


// ====== Chart dropdown filters (scoped) ======
function populateChartFiltersScoped(){
  try{
    const cats = (STATE.cats||[]).slice().sort((a,b)=> b.total - a.total);
    const inject = (containerId)=>{
      const box = document.getElementById(containerId);
      if (!box) return;
      box.innerHTML = cats.map(c => `<label><input type="checkbox" value="${c.name.replace(/"/g,'&quot;')}"/> <span>${c.name}</span></label>`).join('');
    };
    inject('donutChecks'); inject('stackChecks');

    // buttons
    const on = (id, fn)=>{ const el = document.getElementById(id); if (el && !el.__wired){ el.__wired = true; el.onclick = fn; } };
    const selectTop = (wrapId, n)=>{
      const box = document.getElementById(wrapId);
      if (!box) return;
      const inputs = Array.from(box.querySelectorAll('input[type="checkbox"]'));
      inputs.forEach((cb,i)=> cb.checked = (i < n));
    };
    const clearAll = (wrapId)=>{
      const box = document.getElementById(wrapId);
      if (!box) return;
      box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false);
    };
    const reRender = ()=>{ try{ renderCharts(STATE.months||[], STATE.cats||[]); }catch(e){} };

    on('donutTop5', ()=>{ selectTop('donutChecks',5); reRender(); });
    on('donutClear', ()=>{ clearAll('donutChecks'); reRender(); });
    on('donutApply', ()=>{ reRender(); });

    on('stackTop8', ()=>{ selectTop('stackChecks',8); reRender(); });
    on('stackClear', ()=>{ clearAll('stackChecks'); reRender(); });
    on('stackApply', ()=>{ reRender(); });
  }catch(e){ console.warn('populateChartFiltersScoped failed', e); }
}
function getChecked(containerId){
  const box = document.getElementById(containerId);
  if (!box) return [];
  return Array.from(box.querySelectorAll('input[type="checkbox"]:checked')).map(i=> i.value);
}


// === Smart positioning for dropdown panels ===
(function smartPanels(){
  function adjustPanel(detailsEl, panelEl){
    if (!panelEl) return;
    // Reset classes
    panelEl.classList.remove('flip','modal');
    // If narrow viewport, modal class via CSS media already applies, but double-check for tiny heights
    const rect = panelEl.getBoundingClientRect();
    const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
    const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

    // If the panel would overflow to the right by >16px, flip to left
    if (rect.right > vw - 16) panelEl.classList.add('flip');
    // If the panel would overflow bottom by >16px, modal
    if (rect.bottom > vh - 16) panelEl.classList.add('modal');
  }

  function wireOne(detailsSel, panelSel){
    const d = document.querySelector(detailsSel);
    const p = document.querySelector(panelSel);
    if (!d || !p || d.__wired) return;
    d.__wired = true;
    d.addEventListener('toggle', ()=> { if (d.open) { setTimeout(()=> adjustPanel(d,p), 0); } });
    window.addEventListener('resize', ()=> { if (d.open) adjustPanel(d,p); });
    window.addEventListener('scroll', ()=> { if (d.open) adjustPanel(d,p); }, { passive:true });
  }

  // Wire both charts
  wireOne('.chart-filterbar details:nth-of-type(1)', '#donutPanel');
  wireOne('.chart-filterbar details:nth-of-type(2)', '#stackPanel');

  // Close on outside click when modal
  document.addEventListener('click', (ev)=>{
    const openDetails = Array.from(document.querySelectorAll('.chart-filterbar details[open]'));
    for (const d of openDetails){
      const panel = d.querySelector('.panel');
      if (panel && panel.classList.contains('modal')){
        if (!panel.contains(ev.target) && !d.querySelector('summary').contains(ev.target)){
          d.open = false;
        }
      }
    }
  });
})();  


// ====== Snapshot embed utilities ======
function getEmbeddedDataNode(){
  return document.getElementById('embeddedData');
}
function saveSnapshotToHTML(){
  try{
    const node = getEmbeddedDataNode();
    if (!node) return alert('No se encontr√≥ el contenedor de snapshot.');
    const payload = {
      months: STATE.months||[],
      cats: STATE.cats||[],
      totalsPerMonth: STATE.totalsPerMonth||[],
      meta: { generatedAt: new Date().toISOString(), version: 'v19-snapshot-1' }
    };
    node.textContent = JSON.stringify(payload);
    // Quick visual feedback
    const b = document.getElementById('btnEmbedSnapshot');
    if (b){ b.textContent = '‚úÖ Snapshot incrustado'; setTimeout(()=> b.textContent='üì¶ Guardar snapshot (incrustar datos)', 2000); }
  }catch(e){
    console.warn('saveSnapshotToHTML failed', e);
    alert('No se pudo guardar el snapshot.');
  }
}
function tryLoadEmbeddedSnapshot(){
  try{
    const node = getEmbeddedDataNode();
    if (!node || !node.textContent) return false;
    const p = JSON.parse(node.textContent);
    if (!p || !Array.isArray(p.months) || !Array.isArray(p.cats)) return false;
    // Set STATE
    STATE.months = p.months;
    STATE.cats = p.cats;
    STATE.totalsPerMonth = p.totalsPerMonth || [];
    // Hide upload card if present
    const up = document.getElementById('uploadCard');
    if (up) up.classList.add('hidden');
    const uz = document.getElementById('uploadZone'); if (uz) uz.classList.add('hidden');
    // Render everything
    renderKPI(STATE.months, STATE.cats);
    renderCharts(STATE.months, STATE.totalsPerMonth, STATE.cats);
    renderTables(STATE.months, STATE.cats);
    generateExecutiveAnalysis();
    renderManagerTables();
  populateAllCatsFilter();
    if (typeof renderExtraCharts==='function') renderExtraCharts();
    populateChartFiltersScoped && populateChartFiltersScoped();
    buildComparatorUI && buildComparatorUI();
    renderComparator && renderComparator();
    return true;
  }catch(e){
    console.warn('tryLoadEmbeddedSnapshot failed', e);
    return false;
  }
}


// Wire snapshot button
(function(){
  const btn = document.getElementById('btnEmbedSnapshot');
  if (btn && !btn.__wired){
    btn.__wired = true;
    btn.addEventListener('click', (e)=>{ e.preventDefault(); saveSnapshotToHTML(); });
  }
})();
// Try to load embedded snapshot on startup
document.addEventListener('DOMContentLoaded', ()=> {
  try{ tryLoadEmbeddedSnapshot(); }catch(e){}
});


// ====== Download snapshot as self-contained HTML ======
function ensureSnapshotInDOM(){
  // If embeddedData is empty, write current STATE to it
  const node = document.getElementById('embeddedData');
  if (!node) return false;
  if (!node.textContent || node.textContent.trim()===''){
    if (!window.STATE || !Array.isArray(STATE.months) || !Array.isArray(STATE.cats)) return false;
    const payload = {
      months: STATE.months||[],
      cats: STATE.cats||[],
      totalsPerMonth: STATE.totalsPerMonth||[],
      meta: { generatedAt: new Date().toISOString(), version: 'v19-snapshot-1' }
    };
    node.textContent = JSON.stringify(payload);
  }
  return true;
}
function downloadSnapshotCopy(){
  try{
    if (!ensureSnapshotInDOM()){
      alert('Necesito que subas un Excel primero para poder generar la copia con datos.');
      return;
    }
    // Serialize full HTML
    const htmlText = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
    const blob = new Blob([htmlText], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    a.download = `CBDIO_Expenses_Snapshot_${ts}.html`;
    a.href = url;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{
      URL.revokeObjectURL(url);
      a.remove();
    }, 100);
  }catch(e){
    console.warn('downloadSnapshotCopy failed', e);
    alert('No se pudo generar la copia con datos.');
  }
}


// Wire download snapshot button
(function(){
  const btn = document.getElementById('btnDownloadSnapshot');
  if (btn && !btn.__wired){
    btn.__wired = true;
    btn.addEventListener('click', (e)=>{ e.preventDefault(); downloadSnapshotCopy(); });
  }
})();


// ===== Export helpers =====
function canvasesToImages(scope=document){
  const canv = Array.from(scope.querySelectorAll('canvas'));
  const payload = [];
  canv.forEach(cv => {
    try{
      const url = cv.toDataURL('image/png');
      const img = document.createElement('img');
      img.src = url;
      img.alt = cv.id || 'chart';
      img.style.maxWidth = '100%';
      img.style.height = 'auto';
      payload.push({canvas: cv, image: img});
    }catch(e){ console.warn('toDataURL failed for', cv.id, e); }
  });
  return payload;
}
function freezeDomClone(){
  // Clone full document to avoid mutating live dashboard
  const clone = document.documentElement.cloneNode(true);
  // Remove scripts to avoid re-running code in snapshot
  clone.querySelectorAll('script').forEach(s => s.remove());
  // Replace canvases with images
  const pairs = canvasesToImages(document);
  pairs.forEach(({canvas, image})=>{
    const sel = canvas.id ? `#${CSS.escape(canvas.id)}` : null;
    const twin = sel ? clone.querySelector(sel) : null;
    if (twin && twin.tagName.toLowerCase()==='canvas'){
      twin.replaceWith(image.cloneNode(true));
    }
  });
  // Add export-clean class and hide uploader
  clone.querySelector('body')?.classList.add('export-clean');
  const up = clone.querySelector('#uploadCard'); if (up) up.remove();
  const uz = clone.querySelector('#uploadZone'); if (uz) uz.remove();
  return '<!DOCTYPE html>\n' + clone.outerHTML;
}
function downloadBlob(text, filename, type='text/html'){
  const blob = new Blob([text], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
}
function buildExportFilename(ext){
  function safeSlug(s){
    return String(s||'').normalize('NFKD').replace(/[^\w\s-]+/g,'').trim().replace(/[\s_-]+/g,'_').replace(/^_+|_+$/g,'');
  }
  function monthRangeStr(){
    try{
      const m = STATE.months||[]; if (!m.length) return '';
      return `${m[0]}_a_${m[m.length-1]}`.replace(/\s+/g,'_');
    }catch(_){ return ''; }
  }
  function totalStr(){
    try{
      const t = (STATE.totalsPerMonth||[]).reduce((a,b)=>a+(b||0),0) || 0;
      return t ? ('Tot_' + t.toFixed(2).replace(/\./g,'_')) : '';
    }catch(_){ return ''; }
  }
  const proj = safeSlug(STATE.projectTitle || 'Proyecto');
  const pid  = STATE.projectId ? ('ID_' + safeSlug(STATE.projectId)) : '';
  const per  = monthRangeStr();
  const tot  = totalStr();
  const ts   = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  const parts = ['CBDIO', proj]; if (pid) parts.push(pid); if (per) parts.push(per); if (tot) parts.push(tot); parts.push(ts);
  return parts.join('_') + '.' + ext;
}
// Freeze & download HTML
function onFreezeHTML(){
  try{
    const frozen = freezeDomClone();
    const fname = buildExportFilename('html');
    downloadBlob(frozen, fname, 'text/html');
  }catch(e){
    console.warn('Freeze HTML failed', e);
    alert('No se pudo generar el HTML congelado.');
  }
}
// Export to PDF via print (clean mode)
function onExportPDF(){
  try{
    document.body.classList.add('export-clean');
    setTimeout(()=> window.print(), 50);
    setTimeout(()=> document.body.classList.remove('export-clean'), 1500);
  }catch(e){
    console.warn('Export PDF failed', e);
    document.body.classList.remove('export-clean');
    alert('No se pudo preparar el PDF.');
  }
}
// PPTX best-effort using PptxGenJS from CDN
async function ensurePptx(){
  if (window.PptxGenJS) return window.PptxGenJS;
  await new Promise((res, rej)=>{
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js';
    s.onload = res; s.onerror = rej; document.head.appendChild(s);
  });
  return window.PptxGenJS;
}
async function onExportPPTX(){
  try{
    await ensurePptx();
    const PptxGenJS = window.PptxGenJS;
    const pptx = new PptxGenJS();
    pptx.author = 'CBDIO Dashboard'; pptx.company = 'CBDIO';
    const title = STATE.projectTitle || 'Reporte de Gastos';
    const per = (STATE.months||[]); const period = per.length? (per[0] + ' ‚Äì ' + per[per.length-1]) : '';
    // Title slide
    let slide = pptx.addSlide();
    slide.addText('Centro Binacional para el Desarrollo Ind√≠gena Oaxaque√±o', { x:0.5, y:0.5, w:9, h:0.6, fontSize:20, bold:true, color:'000000' });
    slide.addText('An√°lisis Financiero (JLE)', { x:0.5, y:1.1, w:9, h:0.5, fontSize:18, color:'000000' });
    slide.addText(`${title}${period?' ¬∑ '+period:''}`, { x:0.5, y:1.7, w:9, h:0.5, fontSize:16, color:'000000' });

    // Collect chart images
    const charts = Array.from(document.querySelectorAll('canvas')).map(cv=>({ id: cv.id, data: cv.toDataURL('image/png') })).filter(o=>o.data);

    for (const chunk of charts){
      const s = pptx.addSlide();
      s.addText(chunk.id || 'Gr√°fica', { x:0.5, y:0.4, w:9, h:0.4, fontSize:16, color:'000000' });
      s.addImage({ data: chunk.data, x:0.5, y:0.9, w:8.5, h:4.5 });
    }

    const fname = buildExportFilename('pptx');
    await pptx.writeFile({ fileName: fname });
  }catch(e){
    console.warn('Export PPTX failed', e);
    alert('No se pudo generar el PPTX (intenta con el HTML congelado o PDF).');
  }
}

// Wire toolbar
(function(){
  const b1 = document.getElementById('btnFreezeHTML');
  const b2 = document.getElementById('btnExportPDF');
  const b3 = document.getElementById('btnExportPPTX');
  if (b1 && !b1.__wired){ b1.__wired = true; b1.addEventListener('click', onFreezeHTML); }
  if (b2 && !b2.__wired){ b2.__wired = true; b2.addEventListener('click', onExportPDF); }
  if (b3 && !b3.__wired){ b3.__wired = true; b3.addEventListener('click', onExportPPTX); }
})();


// ===== All Cats Trend interactive filters =====
window.__allCatsSelection = null; // Set of selected names or null for default
function populateAllCatsFilter(){
  try{
    const box = document.getElementById('allCatsChecks');
    if (!box) return;
    const cats = (STATE.cats||[]).slice().sort((a,b)=> b.total - a.total);
    box.innerHTML = cats.map(c => `<label style="display:flex;align-items:center;gap:6px;padding:4px 2px"><input type="checkbox" value="${c.name.replace(/"/g,'&quot;')}"/> <span>${c.name}</span></label>`).join('');
    // restore selection if present
    const sel = window.__allCatsSelection;
    if (sel && sel.size){
      box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = sel.has(cb.value));
    } else {
      // default to Top 10
      Array.from(box.querySelectorAll('input[type="checkbox"]')).forEach((cb,i)=> cb.checked = (i<10));
    }
    // Wire buttons
    const on = (id, fn)=>{ const el = document.getElementById(id); if (el && !el.__wired){ el.__wired=true; el.onclick=fn; } };
    const chooseTop = (n)=>{
      const inputs = Array.from(box.querySelectorAll('input[type="checkbox"]'));
      inputs.forEach((cb,i)=> cb.checked = (i < n));
      autoApplyAllCats();
    };
    const chooseAll = ()=>{ box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=true); autoApplyAllCats(); };
    const chooseNone = ()=>{ box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false); autoApplyAllCats(); };
    on('allCatsTop5', ()=> chooseTop(5));
    on('allCatsTop10', ()=> chooseTop(10));
    on('allCatsAll', chooseAll);
    on('allCatsNone', chooseNone);
    on('allCatsApply', ()=> autoApplyAllCats(true));

    // search filtering
    const search = document.getElementById('allCatsSearch');
    if (search && !search.__wired){
      search.__wired = true;
      search.addEventListener('input', ()=>{
        const q = search.value.trim().toLowerCase();
        Array.from(box.querySelectorAll('label')).forEach(lab=>{
          const txt = (lab.textContent||'').toLowerCase();
          lab.style.display = txt.includes(q) ? '' : 'none';
        });
      });
    }
    // auto-apply on change
    if (!box.__wiredChange){
      box.__wiredChange = true;
      box.addEventListener('change', ()=> autoApplyAllCats());
    }
  }catch(e){ console.warn('populateAllCatsFilter failed', e); }
}
function getAllCatsSelected(){
  const box = document.getElementById('allCatsChecks');
  if (!box) return [];
  return Array.from(box.querySelectorAll('input[type="checkbox"]:checked')).map(i=> i.value);
}
function autoApplyAllCats(force=false){
  try{
    const picked = getAllCatsSelected();
    window.__allCatsSelection = picked.length ? new Set(picked) : (force ? new Set() : null);
    // Re-render charts, which will read the selection
    renderCharts(STATE.months||[], STATE.totalsPerMonth||[], STATE.cats||[]);
  }catch(e){ console.warn('autoApplyAllCats failed', e); }
}







</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
// ====== Executive Analysis ======
function perc(x){ return (x*100).toFixed(1)+'%'; }
function safeDiv(a,b){ return b && b!=0 ? (a/b) : 0; } // Pythonic; fix to JS below

function generateExecutiveAnalysis(){
  const months = STATE.months || [];
  const cats = STATE.cats || [];
  if (!months.length || !cats.length){ document.getElementById('execWrap').classList.add('hidden'); return; }

  // Top categories
  const topCats = [...cats].sort((a,b)=> b.total - a.total).slice(0,5);

  // Overall trend & volatility
  const m = STATE.totalsPerMonth || [];
  const n = m.length;
  const total = m.reduce((a,b)=>a+b,0);
  const avg = total / (n||1);
  const slope = slopePerMonth(m);
  const last = m[n-1] || 0, first = m[0] || 0;
  const mom = n>1 ? (last - (m[n-2]||0)) : 0;
  const yoy = n>12 ? (last - (m[n-13]||0)) : null;

  // volatility (coeficiente de variaci√≥n)
  const varc = m.reduce((acc,v)=> acc + Math.pow(v-avg,2), 0) / (n || 1);

  const stdev = Math.sqrt(varc);
  const cv = avg ? stdev/avg : 0;

  // Category drivers (slopes)
  const catTrends = cats.map(c=>({ 
    name:c.name, 
    slope:slopePerMonth(c.monthly), 
    total:c.total, 
    last:c.monthly[c.monthly.length-1]||0,
    avg:c.total/(c.monthly.length||1)
  })).sort((a,b)=> Math.abs(b.slope) - Math.abs(a.slope));

  const upDrivers = catTrends.filter(x=>x.slope>0).slice(0,3);
  const downDrivers = catTrends.filter(x=>x.slope<0).slice(0,3);

  // Build narrative
  const lines = [];
  lines.push(`Proyecto: ${STATE.projectTitle}`);
  lines.push(`Periodo: ${months[0]} ‚Äì ${months[months.length-1]}`);
  lines.push('');
  lines.push('1) Resumen ejecutivo');
  const slopeTxt = (slope>=0?'+':'-') + Math.abs(slope).toFixed(2) + ' USD/mes';
  const momTxt = (mom>=0?'+':'-') + Math.abs(mom).toFixed(2);
  lines.push(`‚Ä¢ Gasto total: ${fmtUSD(total)} ¬∑ Promedio mensual: ${fmtUSD(avg)} ¬∑ Tendencia: ${slope>=0?'üìà al alza':'üìâ a la baja'} (${slopeTxt}). Volatilidad (CV): ${(cv*100).toFixed(1)}%.`);
  lines.push(`‚Ä¢ √öltimo mes vs anterior: ${mom>=0?'‚ñ≤':'‚ñº'} ${fmtUSD(Math.abs(mom))}${yoy!==null?` ¬∑ Œî vs hace 12 meses: ${yoy>=0?'‚ñ≤':'‚ñº'} ${fmtUSD(Math.abs(yoy))}`:''}.`);
  lines.push('');
  lines.push('2) Principales categor√≠as (Top 5 por gasto total)');
  topCats.forEach((c,i)=>{
    const s = slopePerMonth(c.monthly);
    lines.push(`   ${i+1}. ${c.name}: ${fmtUSD(c.total)} (${fmtUSD(c.total/(c.monthly.length||1))}/mes) ¬∑ Tendencia: ${s>=0?'üìà':'üìâ'} ${ (s>=0?'+':'-') + fmtUSD(Math.abs(s)).replace('$','') } USD/mes.`);
  });
  // Sem√°foro counts
  const semCounts = cats.reduce((acc,c)=>{ const avg = c.total/(c.monthly.length||1); const thr = Math.max(1, 0.05*(avg||1)); const s = slopePerMonth(c.monthly); if (s>thr) acc.rojo++; else if (s<-thr) acc.verde++; else acc.amarillo++; return acc; }, {rojo:0,amarillo:0,verde:0});
  lines.push(`‚Ä¢ Sem√°foro categor√≠as ‚Äì Rojo: ${semCounts.rojo} ¬∑ Amarillo: ${semCounts.amarillo} ¬∑ Verde: ${semCounts.verde}`);
  lines.push('');
  lines.push('3) Categor√≠as que m√°s mueven la tendencia');
  lines.push('   Al alza:');
  upDrivers.forEach(d=> lines.push(`   ‚Ä¢ ${d.name}: pendiente +${d.slope.toFixed(2)} USD/mes (prom: ${fmtUSD(d.avg)})`));
  const topRojos = catTrends.filter(x=> x.slope>0 && x.slope > Math.max(1, 0.05*(x.avg||1))).slice(0,5);
  if (topRojos.length){ lines.push('   (Top rojos a vigilar)'); topRojos.forEach(tr => lines.push(`     ‚ó¶ ${tr.name}: +${tr.slope.toFixed(2)} USD/mes`)); }
  lines.push('   A la baja:');
  downDrivers.forEach(d=> lines.push(`   ‚Ä¢ ${d.name}: pendiente ${d.slope.toFixed(2)} USD/mes (prom: ${fmtUSD(d.avg)})`));
  lines.push('');
  lines.push('4) Lectura y riesgos');
  if (cv>0.35){ lines.push('   ‚Ä¢ Alta variabilidad mensual: considerar calendarizar gastos o revisar estacionalidad/one-offs.'); }
  if (slope>0 && (upDrivers[0]?.slope||0) > (0.2*avg)){ lines.push('   ‚Ä¢ La tendencia ascendente est√° concentrada en pocas categor√≠as: riesgo de presi√≥n presupuestal focalizada.'); }
  if (topCats[0] && (topCats[0].total/total) > 0.35){ lines.push(`   ‚Ä¢ Concentraci√≥n en ${topCats[0].name}: >35% del total; monitorear dependencia y justificar variaciones.`); }
  lines.push('');
  lines.push('5) Recomendaciones de gesti√≥n');
  lines.push('   ‚Ä¢ Establecer topes mensuales por categor√≠a top y activar alertas (>10% sobre promedio).');
  lines.push('   ‚Ä¢ Revisar contratos/vales en categor√≠as con pendiente positiva elevada y negociar condiciones.');
  lines.push('   ‚Ä¢ Programar gastos estacionales para suavizar picos; usar compromisos (encumbrances) donde aplique.');
  lines.push('   ‚Ä¢ Preparar nota explicativa para el Board si el √∫ltimo mes muestra desviaciones >15% vs promedio.');

  const text = lines.join('\n');
  const box = document.getElementById('execText');
  box.textContent = text;
  document.getElementById('execWrap').classList.remove('hidden');

  // Export buttons
  const bPDF = document.getElementById('exportExecPDF');
  
if (bPDF){
  bPDF.onclick = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });
    const margin = 48, width = 540;
    const title = 'Reporte Ejecutivo ‚Äì Gastos';
    const project = STATE.projectTitle || '';
    const period = (STATE.months && STATE.months.length) ? (STATE.months[0] + ' ‚Äì ' + STATE.months[STATE.months.length-1]) : '';

    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text(title, margin, margin);
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    doc.text('Proyecto: ' + project, margin, margin+16);
    doc.text('Periodo: ' + period, margin, margin+30);

    let y = margin + 54;
    const addHeading = (txt)=>{ doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text(stripEmojis(txt), margin, y); y += 16; doc.setFont('helvetica','normal'); doc.setFontSize(10); };
    const addPara = (txt)=>{
      const lines = doc.splitTextToSize(stripEmojis(txt), width);
      lines.forEach(line => { if (y>780){ doc.addPage(); y = margin; } doc.text(line, margin, y); y += 14; });
    };
    const addList = (arr)=>{
      arr.forEach(item => {
        const lines = doc.splitTextToSize('‚Ä¢ ' + stripEmojis(item), width);
        lines.forEach((line, idx) => { if (y>780){ doc.addPage(); y = margin; } doc.text(line, margin, y); y += 14; });
      });
    };

    // Build sections from DOM bullets for clean structure
    const bulletsEl = document.getElementById('execBullets');
    if (bulletsEl){
      const groups = [];
      let current = null;
      bulletsEl.childNodes.forEach(node => {
        if (node.tagName === 'STRONG'){
          if (current) groups.push(current);
          current = { heading: node.textContent.trim(), items: [] };
        } else if (node.tagName === 'UL'){
          const lis = Array.from(node.querySelectorAll('li')).map(li => li.textContent.trim());
          if (!current) current = { heading: '', items: [] };
          current.items.push(...lis);
        } else if (node.tagName === 'DIV'){
          // plain line (e.g., sem√°foro counts)
          if (!current) current = { heading: '', items: [] };
          current.items.push(node.textContent.trim());
        }
      });
      if (current) groups.push(current);

      // Render each group
      groups.forEach(g => {
        if (g.heading){
          addHeading(g.heading);
        }
        if (g.items && g.items.length){
          addList(g.items);
          y += 6;
        }
      });
    } else {
      // Fallback: use text block
      addHeading('Resumen');
      addPara((document.getElementById('execText')?.textContent)||'');
    }

    doc.save('cbdio_exec_summary.pdf');
  };
}


  const bCopy = document.getElementById('copyExec');
  if (bCopy){
    bCopy.onclick = async () => {
      try{ await navigator.clipboard.writeText(text); alert('Reporte ejecutivo copiado al portapapeles.'); }
      catch(e){ alert('No se pudo copiar autom√°ticamente. Selecciona el texto y copia manualmente.'); }
    };
  }
}


// ====== Extra charts (Top5 share & MoM Top3) ======
function renderExtraCharts(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;

    // Build/refresh filter UI
    buildCategoryFilterUI();
    // Compute Top share according to selection
    const total = (STATE.totalsPerMonth||[]).reduce((a,b)=>a+b,0);
    const catsSorted = [...cats].sort((a,b)=> b.total - a.total);
    const sel = getTopShareSelection(total, catsSorted);
    const topNames = sel.selected.map(c=>c.name);
    const topVals = sel.selected.map(c=>c.total);
    const topShares = topVals.map(v => total? (v/total*100) : 0);
    const labelsShare = [...topNames, 'Otros'];
    const dataShare = [...topShares, total? (sel.others/total*100) : 0];
    const colorsShare = [...topNames.map(n=> colorFor(n)), '#9ca3af'];

    // Compute MoM deltas (last vs prev) per category
    const deltas = cats.map(c=> (c.monthly[c.monthly.length-1]||0) - (c.monthly[c.monthly.length-2]||0));
    const momArr = cats.map((c,i)=> ({ name:c.name, delta:deltas[i] }));
    const momUp = [...momArr].sort((a,b)=> b.delta - a.delta).slice(0,3);
    const momDown = [...momArr].sort((a,b)=> a.delta - b.delta).slice(0,3).reverse(); // make it descending absolute with negatives shown
    const momData = [...momUp, ...momDown.map(x=>({name:x.name, delta:x.delta}))]; // keep negatives

    // Show container
    const wrap = document.getElementById('charts3');
    if (wrap) wrap.classList.remove('hidden');

    // Render Top5 Share (bar horizontal)
    const shCtx = document.getElementById('top5Share').getContext('2d');
    if (charts.top5Share) charts.top5Share.destroy();
    charts.top5Share = new Chart(shCtx, {
      type: 'bar',
      data: { labels: labelsShare, datasets: [{ label: '% del total', data: dataShare, backgroundColor: colorsShare }] },
      options: {
        indexAxis: 'y',
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(ctx)=> ctx.parsed.x.toFixed(1) + '%' } } },
        scales:{ x:{ beginAtZero:true, ticks:{ callback:(v)=> v + '%' }, max:100 } }
      }
    });

    // Render MoM Top3 (barras, mezcla de positivos/negativos)
    const momCtx = document.getElementById('momTop3').getContext('2d');
    if (charts.momTop3) charts.momTop3.destroy();
    charts.momTop3 = new Chart(momCtx, {
      type: 'bar',
      data: { labels: momData.map(x=>x.name), datasets: [{ label: 'Œî √∫ltimo mes', data: momData.map(x=>x.delta), backgroundColor: momData.map(x=> x.delta>=0 ? '#10b981' : '#ef4444') }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(ctx)=> (ctx.parsed.y>=0?'+':'-') + Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(Math.abs(ctx.parsed.y)) } } },
        scales:{ y:{ beginAtZero:false } }
      }
    });

  }catch(e){ console.warn('renderExtraCharts failed', e); }
}


// ====== Category filter UI for Top Share ======
function buildCategoryFilterUI(){
  const modeSel = document.getElementById('topShareMode');
  const panel = document.getElementById('customCatPanel');
  const list = document.getElementById('customCatList');
  const btnAll = document.getElementById('btnAllCats');
  const btnNone = document.getElementById('btnNoneCats');
  const btnApply = document.getElementById('btnApplyCats');
  if (!modeSel || !panel || !list) return;

  // Populate checkbox list from STATE.cats, ordered by total desc
  const cats = [...(STATE.cats||[])].sort((a,b)=> b.total - a.total);
  // Restore previous mode/selection if available on first build
  if (!STATE.__restored){ restoreModeAndSelection(); STATE.__restored = true; }

  list.innerHTML = cats.map((c,i)=>{
    const checked = (STATE.customCats.length ? STATE.customCats.includes(c.name) : (i<5));
    return `<label style="display:inline-flex;align-items:center;gap:6px;margin:4px 10px 4px 0">
      <input type="checkbox" data-cat="${c.name.replace(/"/g,'&quot;')}" ${checked?'checked':''}/>
      <span>${c.name}</span>
    </label>`;
  }).join('');

  modeSel.value = STATE.shareMode || 'top5'; seedDefaultPresetsIfEmpty(); populatePresetSelect(); attachPresetHandlers(); attachSearchHandler();
  panel.classList.toggle('hidden', modeSel.value !== 'custom');

  modeSel.onchange = () => {
    STATE.shareMode = modeSel.value;
    panel.classList.toggle('hidden', STATE.shareMode !== 'custom');
    persistModeAndSelection();
    // If not custom, re-render directly
    if (STATE.shareMode !== 'custom'){
      renderExtraCharts();
    }
  };

  btnAll.onclick = () => {
    list.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = true);
  };
  btnNone.onclick = () => {
    list.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = false);
  };
  btnApply.onclick = () => {
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    STATE.customCats = chosen;
    persistModeAndSelection();
    renderExtraCharts();
  };
}

function getTopShareSelection(total, catsSorted){
  // catsSorted: [{name,total,monthly}...] sorted desc by total
  let selected = [];
  if (STATE.shareMode === 'top10'){
    selected = catsSorted.slice(0,10);
  } else if (STATE.shareMode === 'custom'){
    const set = new Set(STATE.customCats||[]);
    selected = catsSorted.filter(c => set.has(c.name));
    if (!selected.length){ selected = catsSorted.slice(0,5); } // fallback
  } else { // top5 default
    selected = catsSorted.slice(0,5);
  }
  const selTotal = selected.reduce((a,c)=> a + c.total, 0);
  const others = Math.max(0, total - selTotal);
  return { selected, others };
}


// ====== Presets & Search for category filter ======
const PRESET_KEY = 'cbdio_topshare_presets_v1';
const MODE_KEY = 'cbdio_topshare_mode';
const SEL_KEY = 'cbdio_topshare_customCats';

function loadPresets(){
  try{ return JSON.parse(localStorage.getItem(PRESET_KEY) || '{}'); }catch(e){ return {}; }
}
function savePresets(obj){
  try{ localStorage.setItem(PRESET_KEY, JSON.stringify(obj)); }catch(e){}
}
function persistModeAndSelection(){
  try{
    localStorage.setItem(MODE_KEY, STATE.shareMode || 'top5');
    localStorage.setItem(SEL_KEY, JSON.stringify(STATE.customCats || []));
  }catch(e){}
}
function restoreModeAndSelection(){
  try{
    const m = localStorage.getItem(MODE_KEY);
    const s = localStorage.getItem(SEL_KEY);
    if (m) STATE.shareMode = m;
    if (s) STATE.customCats = JSON.parse(s);
  }catch(e){}
}

function populatePresetSelect(){
  const sel = document.getElementById('presetSelect');
  if (!sel) return;
  const presets = loadPresets();
  const names = Object.keys(presets).sort();
  sel.innerHTML = '<option value="">(elige un preset)</option>' + names.map(n => `<option value="${n}">${n}</option>`).join('');
}

function attachPresetHandlers(){
  const btnLoad = document.getElementById('btnLoadPreset');
  const btnSave = document.getElementById('btnSavePreset');
  const btnDel  = document.getElementById('btnDeletePreset');
  const sel     = document.getElementById('presetSelect');
  const list    = document.getElementById('customCatList');

  if (btnLoad) btnLoad.onclick = () => {
    const name = sel && sel.value;
    if (!name) return;
    const presets = loadPresets();
    if (presets[name]){
      STATE.customCats = presets[name];
      // Reflect in checkboxes
      list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = STATE.customCats.includes(cb.getAttribute('data-cat'));
      });
      renderExtraCharts();
    }
  };

  if (btnSave) btnSave.onclick = () => {
    const name = prompt('Nombre del preset:');
    if (!name) return;
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    const presets = loadPresets();
    presets[name] = chosen;
    savePresets(presets);
    populatePresetSelect();
    alert('Preset guardado.');
  };

  if (btnDel) btnDel.onclick = () => {
    const name = sel && sel.value;
    if (!name) return;
    const presets = loadPresets();
    if (presets[name]){
      if (confirm('¬øEliminar preset "'+name+'"?')){
        delete presets[name];
        savePresets(presets);
        populatePresetSelect();
        alert('Preset eliminado.');
      }
    }
  };
}

function attachSearchHandler(){
  const input = document.getElementById('catSearch');
  const list  = document.getElementById('customCatList');
  if (!input || !list) return;
  input.oninput = () => {
    const q = input.value.trim().toLowerCase();
    list.querySelectorAll('label').forEach(lbl => {
      const text = lbl.textContent.toLowerCase();
      lbl.style.display = (!q || text.includes(q)) ? 'inline-flex' : 'none';
    });
  };
}


// ====== Seed default presets: Direct vs Indirect ======
function categorizeDefaultBuckets(catNames){
  const direct = new Set();
  const indirect = new Set();
  const push = (set, name) => set.add(name);

  catNames.forEach(name => {
    const low = name.toLowerCase();
    // Likely DIRECT
    if (/(salary|wage)/.test(low)) return push(direct, name);
    if (/(benefit|payroll|fringe|medical|vision|dental|life)/.test(low)) return push(direct, name);
    if (/(stipend|scholar)/.test(low)) return push(direct, name);
    if (/(program supplies|workshop|event)/.test(low)) return push(direct, name);
    if (/(travel|mileage|lodging|hotel|meals)/.test(low)) return push(direct, name);
    if (/(training|capacity)/.test(low)) return push(direct, name);
    if (/(consultant|contract service)/.test(low)) return push(direct, name);
    if (/(equipment)/.test(low)) return push(direct, name);
    if (/(printing|copy)/.test(low)) return push(direct, name);
    // Likely INDIRECT
    if (/(office rent|rent)/.test(low)) return push(indirect, name);
    if (/(office expenses|office|postage|mail|software)/.test(low)) return push(indirect, name);
    if (/(internet|communication|telephone|web)/.test(low)) return push(indirect, name);
    if (/(utilities|maintenance|janitorial|repair)/.test(low)) return push(indirect, name);
    if (/(marketing|advertising)/.test(low)) return push(indirect, name);
    if (/(insurance)/.test(low)) return push(indirect, name);
    if (/(indirect)/.test(low)) return push(indirect, name);
    // Fallback: lean to INDIRECT
    push(indirect, name);
  });

  return { direct: Array.from(direct), indirect: Array.from(indirect) };
}

function seedDefaultPresetsIfEmpty(){
  const presets = loadPresets();
  if (Object.keys(presets).length > 0) return; // already have user presets

  const catNames = (STATE.cats||[]).map(c=>c.name);
  const { direct, indirect } = categorizeDefaultBuckets(catNames);

  // Only save if we have at least something
  if (direct.length || indirect.length){
    presets['Direct'] = direct;
    presets['Indirect'] = indirect;
    savePresets(presets);
  }
}


// ====== Manager Tables Renderer ======
function renderManagerTables(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;

    // ---- Top categor√≠as por gasto ----
    const totalAll = (STATE.totalsPerMonth||[]).reduce((a,b)=>a+b,0) || 1;
    const topSorted = [...cats].sort((a,b)=> b.total - a.total).slice(0,5);
    const tbodyTop = document.querySelector('#tblTopCats tbody');
    if (tbodyTop){
      tbodyTop.innerHTML = '';
      const maxTotal = topSorted.length ? Math.max(...topSorted.map(c=>c.total)) : 1;
      topSorted.forEach((c,idx)=>{
        const avg = c.total/(c.monthly.length||1);
        const s = slopePerMonth(c.monthly||[]);
        const tag = s>Math.max(1,.05*(avg||1)) ? 'üìà Al alza' : (s<-Math.max(1,.05*(avg||1)) ? 'üìâ A la baja' : '‚û°Ô∏è Estable');
        const pct = (c.total/totalAll*100);
        const color = colorFor(c.name);
        const barW = Math.max(4, (c.total/maxTotal)*100);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx+1}</td>
          <td>${c.name}</td>
          <td style="text-align:right">${fmtUSD(c.total)}</td>
          <td style="text-align:right">${pct.toFixed(1)}%</td>
          <td style="text-align:right">${fmtUSD(avg)}</td>
          <td>${tag}</td>
          <td><div class="barcell"><div class="barfill" style="width:${barW}%;background:${color}33"></div></div></td>`;
        tbodyTop.appendChild(tr);
      });
    }

    // ---- Heatmap mensual por categor√≠a ----
    const head = document.getElementById('hmHead');
    const body = document.getElementById('hmBody');
    if (head && body){
      head.innerHTML = '<tr><th>Categor√≠a</th>' + months.map(m=> `<th>${m}</th>`).join('') + '<th style="text-align:right">Total</th></tr>';
      body.innerHTML = '';
      // Global min/max for scaling
      let gmin = Infinity, gmax = -Infinity;
      cats.forEach(c => (c.monthly||[]).forEach(v => { gmin = Math.min(gmin, v||0); gmax = Math.max(gmax, v||0); }));
      if (!isFinite(gmin)) gmin = 0; if (!isFinite(gmax) || gmax<=0) gmax = 1;
      function cellColor(v){
        const x = Math.max(0, Math.min(1, v/gmax));
        // scale green->yellow->red
        const r = Math.round(255 * x);
        const g = Math.round(200 * (1 - x) + 40);
        const b = 80;
        return `rgba(${r},${g},${b},0.18)`;
      }
      const catsSorted = [...cats].sort((a,b)=> b.total - a.total);
      catsSorted.forEach(c => {
        const tr = document.createElement('tr');
        let tds = `<td>${c.name}</td>`;
        (c.monthly||[]).forEach(v => {
          tds += `<td class="hmcell" style="background:${cellColor(v||0)}">${v?fmtUSD(v):''}</td>`;
        });
        tds += `<td style="text-align:right">${fmtUSD(c.total||0)}</td>`;
        tr.innerHTML = tds;
        body.appendChild(tr);
      });
    }

    // ---- Direct vs Indirect (tabla) ----
    const diBody = document.querySelector('#tblDirectIndirect tbody');
    if (diBody){
      diBody.innerHTML = '';
      const names = cats.map(c=> c.name);
      // Use existing heuristics from V19
      const buckets = categorizeDefaultBuckets ? categorizeDefaultBuckets(names) : { direct:names, indirect:[] };
      const setD = new Set(buckets.direct||[]);
      let totalD = 0, totalI = 0;
      cats.forEach(c => { if (setD.has(c.name)) totalD += c.total; else totalI += c.total; });
      const tot = totalD + totalI || 1;
      const pD = (totalD/tot*100), pI = (totalI/tot*100);

      function barHTML(pct, color){ return `<div class="barcell"><div class="barfill" style="width:${pct.toFixed(1)}%;background:${color}66"></div></div>`; }

      const trD = document.createElement('tr');
      trD.innerHTML = `<td>Direct</td><td style="text-align:right">${fmtUSD(totalD)}</td><td style="text-align:right">${pD.toFixed(1)}%</td><td>${barHTML(pD,'#10b981')}</td>`;
      const trI = document.createElement('tr');
      trI.innerHTML = `<td>Indirect</td><td style="text-align:right">${fmtUSD(totalI)}</td><td style="text-align:right">${pI.toFixed(1)}%</td><td>${barHTML(pI,'#7c3aed')}</td>`;

      diBody.appendChild(trD);
      diBody.appendChild(trI);
    }
  }catch(e){ console.warn('renderManagerTables failed', e); }
}


// ====== Zero-month filter: drop months with total 0 ======
function applyZeroMonthFilter(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;
    // compute totals per month from categories if missing
    const n = (cats[0].monthly||[]).length;
    const totals = Array(n).fill(0);
    cats.forEach(c => { for(let i=0;i<n;i++){ totals[i] += (c.monthly[i]||0); } });
    // indices where totals > 0
    const keepIdx = [];
    for (let i=0;i<n;i++){ if (Math.abs(totals[i]) > 1e-9) keepIdx.push(i); }
    if (keepIdx.length === n) { STATE.totalsPerMonth = totals; return; } // nothing to drop

    // Filter months and cat series
    STATE.months = keepIdx.map(i => months[i]);
    STATE.cats = cats.map(c => ({
      name: c.name,
      monthly: keepIdx.map(i => c.monthly[i]||0),
      total: keepIdx.reduce((s,i)=> s + (c.monthly[i]||0), 0)
    }));
    // Recompute totalsPerMonth
    const totals2 = Array(keepIdx.length).fill(0);
    STATE.cats.forEach(c => { for(let i=0;i<keepIdx.length;i++){ totals2[i] += (c.monthly[i]||0); } });
    STATE.totalsPerMonth = totals2;
  }catch(e){ console.warn('applyZeroMonthFilter failed', e); }
}


// ====== Comparator Chart ======
function buildComparatorUI(){
  const list = document.getElementById('cmpList');
  if (!list) return;
  const cats = STATE.cats || [];
  // order by total desc
  const ordered = [...cats].sort((a,b)=> b.total - a.total);
  list.innerHTML = ordered.map(c => `
    <label style="display:inline-flex;align-items:center;gap:6px;margin:4px 10px 4px 0">
      <input type="checkbox" data-cat="${c.name.replace(/"/g,'&quot;')}"/>
      <span>${c.name}</span>
    </label>
  `).join('');

  const btnTop = document.getElementById('btnCmpTop5');
  const btnClr = document.getElementById('btnCmpClear');
  const btnApp = document.getElementById('btnCmpApply');
  const modeSel = document.getElementById('cmpMode');

  const maxSel = 6;
  function applyTop(n=5){
    list.querySelectorAll('input[type="checkbox"]').forEach((cb,idx)=> cb.checked = (idx<n));
  }
  function clearAll(){
    list.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = false);
  }
  function getChosen(){
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    return chosen.slice(0, maxSel);
  }
  if (btnTop && !btnTop.__wired){ btnTop.__wired = true; btnTop.onclick = ()=> { applyTop(5); renderComparator(); }; }
  if (btnClr && !btnClr.__wired){ btnClr.__wired = true; btnClr.onclick = ()=> { clearAll(); renderComparator(); }; }
  if (btnApp && !btnApp.__wired){ btnApp.__wired = true; btnApp.onclick = ()=> renderComparator(); }
  if (modeSel && !modeSel.__wired){ modeSel.__wired = true; modeSel.onchange = ()=> renderComparator(); }

  // default to Top 5
  applyTop(5);
}

function renderComparator(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;
    const modeSel = document.getElementById('cmpMode');
    const mode = modeSel ? modeSel.value : 'line';
    const list = document.getElementById('cmpList');
    if (!list) return;
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    const chosenSet = new Set(chosen);
    const picked = cats.filter(c => chosenSet.has(c.name)).slice(0,6);

    const datasets = picked.map(c => ({
      label: c.name,
      data: c.monthly,
      borderColor: colorFor(c.name),
      backgroundColor: colorFor(c.name) + '33',
      fill: (mode === 'line') ? false : true,
      tension: 0.25
    }));

    const ctx = document.getElementById('cmpChart').getContext('2d');
    if (!window.charts) window.charts = {};
    if (charts.cmpChart) { try{ charts.cmpChart.destroy(); }catch(e){} }
    charts.cmpChart = new Chart(ctx, {
      type: (mode === 'line') ? 'line' : 'bar',
      data: { labels: months, datasets: datasets },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ position:'bottom' } },
        scales: (mode==='bar') ? { x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } } : { y:{ beginAtZero:true } }
      }
    });
  }catch(e){ console.warn('renderComparator failed', e); }
}


// ====== Chart dropdown filters (scoped) ======
function populateChartFiltersScoped(){
  try{
    const cats = (STATE.cats||[]).slice().sort((a,b)=> b.total - a.total);
    const inject = (containerId)=>{
      const box = document.getElementById(containerId);
      if (!box) return;
      box.innerHTML = cats.map(c => `<label><input type="checkbox" value="${c.name.replace(/"/g,'&quot;')}"/> <span>${c.name}</span></label>`).join('');
    };
    inject('donutChecks'); inject('stackChecks');

    // buttons
    const on = (id, fn)=>{ const el = document.getElementById(id); if (el && !el.__wired){ el.__wired = true; el.onclick = fn; } };
    const selectTop = (wrapId, n)=>{
      const box = document.getElementById(wrapId);
      if (!box) return;
      const inputs = Array.from(box.querySelectorAll('input[type="checkbox"]'));
      inputs.forEach((cb,i)=> cb.checked = (i < n));
    };
    const clearAll = (wrapId)=>{
      const box = document.getElementById(wrapId);
      if (!box) return;
      box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false);
    };
    const reRender = ()=>{ try{ renderCharts(STATE.months||[], STATE.cats||[]); }catch(e){} };

    on('donutTop5', ()=>{ selectTop('donutChecks',5); reRender(); });
    on('donutClear', ()=>{ clearAll('donutChecks'); reRender(); });
    on('donutApply', ()=>{ reRender(); });

    on('stackTop8', ()=>{ selectTop('stackChecks',8); reRender(); });
    on('stackClear', ()=>{ clearAll('stackChecks'); reRender(); });
    on('stackApply', ()=>{ reRender(); });
  }catch(e){ console.warn('populateChartFiltersScoped failed', e); }
}
function getChecked(containerId){
  const box = document.getElementById(containerId);
  if (!box) return [];
  return Array.from(box.querySelectorAll('input[type="checkbox"]:checked')).map(i=> i.value);
}


// === Smart positioning for dropdown panels ===
(function smartPanels(){
  function adjustPanel(detailsEl, panelEl){
    if (!panelEl) return;
    // Reset classes
    panelEl.classList.remove('flip','modal');
    // If narrow viewport, modal class via CSS media already applies, but double-check for tiny heights
    const rect = panelEl.getBoundingClientRect();
    const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
    const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

    // If the panel would overflow to the right by >16px, flip to left
    if (rect.right > vw - 16) panelEl.classList.add('flip');
    // If the panel would overflow bottom by >16px, modal
    if (rect.bottom > vh - 16) panelEl.classList.add('modal');
  }

  function wireOne(detailsSel, panelSel){
    const d = document.querySelector(detailsSel);
    const p = document.querySelector(panelSel);
    if (!d || !p || d.__wired) return;
    d.__wired = true;
    d.addEventListener('toggle', ()=> { if (d.open) { setTimeout(()=> adjustPanel(d,p), 0); } });
    window.addEventListener('resize', ()=> { if (d.open) adjustPanel(d,p); });
    window.addEventListener('scroll', ()=> { if (d.open) adjustPanel(d,p); }, { passive:true });
  }

  // Wire both charts
  wireOne('.chart-filterbar details:nth-of-type(1)', '#donutPanel');
  wireOne('.chart-filterbar details:nth-of-type(2)', '#stackPanel');

  // Close on outside click when modal
  document.addEventListener('click', (ev)=>{
    const openDetails = Array.from(document.querySelectorAll('.chart-filterbar details[open]'));
    for (const d of openDetails){
      const panel = d.querySelector('.panel');
      if (panel && panel.classList.contains('modal')){
        if (!panel.contains(ev.target) && !d.querySelector('summary').contains(ev.target)){
          d.open = false;
        }
      }
    }
  });
})();  


// ====== Snapshot embed utilities ======
function getEmbeddedDataNode(){
  return document.getElementById('embeddedData');
}
function saveSnapshotToHTML(){
  try{
    const node = getEmbeddedDataNode();
    if (!node) return alert('No se encontr√≥ el contenedor de snapshot.');
    const payload = {
      months: STATE.months||[],
      cats: STATE.cats||[],
      totalsPerMonth: STATE.totalsPerMonth||[],
      meta: { generatedAt: new Date().toISOString(), version: 'v19-snapshot-1' }
    };
    node.textContent = JSON.stringify(payload);
    // Quick visual feedback
    const b = document.getElementById('btnEmbedSnapshot');
    if (b){ b.textContent = '‚úÖ Snapshot incrustado'; setTimeout(()=> b.textContent='üì¶ Guardar snapshot (incrustar datos)', 2000); }
  }catch(e){
    console.warn('saveSnapshotToHTML failed', e);
    alert('No se pudo guardar el snapshot.');
  }
}
function tryLoadEmbeddedSnapshot(){
  try{
    const node = getEmbeddedDataNode();
    if (!node || !node.textContent) return false;
    const p = JSON.parse(node.textContent);
    if (!p || !Array.isArray(p.months) || !Array.isArray(p.cats)) return false;
    // Set STATE
    STATE.months = p.months;
    STATE.cats = p.cats;
    STATE.totalsPerMonth = p.totalsPerMonth || [];
    // Hide upload card if present
    const up = document.getElementById('uploadCard');
    if (up) up.classList.add('hidden');
    const uz = document.getElementById('uploadZone'); if (uz) uz.classList.add('hidden');
    // Render everything
    renderKPI(STATE.months, STATE.cats);
    renderCharts(STATE.months, STATE.totalsPerMonth, STATE.cats);
    renderTables(STATE.months, STATE.cats);
    generateExecutiveAnalysis();
    renderManagerTables();
  populateAllCatsFilter();
    if (typeof renderExtraCharts==='function') renderExtraCharts();
    populateChartFiltersScoped && populateChartFiltersScoped();
    buildComparatorUI && buildComparatorUI();
    renderComparator && renderComparator();
    return true;
  }catch(e){
    console.warn('tryLoadEmbeddedSnapshot failed', e);
    return false;
  }
}


// Wire snapshot button
(function(){
  const btn = document.getElementById('btnEmbedSnapshot');
  if (btn && !btn.__wired){
    btn.__wired = true;
    btn.addEventListener('click', (e)=>{ e.preventDefault(); saveSnapshotToHTML(); });
  }
})();
// Try to load embedded snapshot on startup
document.addEventListener('DOMContentLoaded', ()=> {
  try{ tryLoadEmbeddedSnapshot(); }catch(e){}
});


// ====== Download snapshot as self-contained HTML ======
function ensureSnapshotInDOM(){
  // If embeddedData is empty, write current STATE to it
  const node = document.getElementById('embeddedData');
  if (!node) return false;
  if (!node.textContent || node.textContent.trim()===''){
    if (!window.STATE || !Array.isArray(STATE.months) || !Array.isArray(STATE.cats)) return false;
    const payload = {
      months: STATE.months||[],
      cats: STATE.cats||[],
      totalsPerMonth: STATE.totalsPerMonth||[],
      meta: { generatedAt: new Date().toISOString(), version: 'v19-snapshot-1' }
    };
    node.textContent = JSON.stringify(payload);
  }
  return true;
}
function downloadSnapshotCopy(){
  try{
    if (!ensureSnapshotInDOM()){
      alert('Necesito que subas un Excel primero para poder generar la copia con datos.');
      return;
    }
    // Serialize full HTML
    const htmlText = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
    const blob = new Blob([htmlText], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    a.download = `CBDIO_Expenses_Snapshot_${ts}.html`;
    a.href = url;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{
      URL.revokeObjectURL(url);
      a.remove();
    }, 100);
  }catch(e){
    console.warn('downloadSnapshotCopy failed', e);
    alert('No se pudo generar la copia con datos.');
  }
}


// Wire download snapshot button
(function(){
  const btn = document.getElementById('btnDownloadSnapshot');
  if (btn && !btn.__wired){
    btn.__wired = true;
    btn.addEventListener('click', (e)=>{ e.preventDefault(); downloadSnapshotCopy(); });
  }
})();


// ===== Export helpers =====
function canvasesToImages(scope=document){
  const canv = Array.from(scope.querySelectorAll('canvas'));
  const payload = [];
  canv.forEach(cv => {
    try{
      const url = cv.toDataURL('image/png');
      const img = document.createElement('img');
      img.src = url;
      img.alt = cv.id || 'chart';
      img.style.maxWidth = '100%';
      img.style.height = 'auto';
      payload.push({canvas: cv, image: img});
    }catch(e){ console.warn('toDataURL failed for', cv.id, e); }
  });
  return payload;
}
function freezeDomClone(){
  // Clone full document to avoid mutating live dashboard
  const clone = document.documentElement.cloneNode(true);
  // Remove scripts to avoid re-running code in snapshot
  clone.querySelectorAll('script').forEach(s => s.remove());
  // Replace canvases with images
  const pairs = canvasesToImages(document);
  pairs.forEach(({canvas, image})=>{
    const sel = canvas.id ? `#${CSS.escape(canvas.id)}` : null;
    const twin = sel ? clone.querySelector(sel) : null;
    if (twin && twin.tagName.toLowerCase()==='canvas'){
      twin.replaceWith(image.cloneNode(true));
    }
  });
  // Add export-clean class and hide uploader
  clone.querySelector('body')?.classList.add('export-clean');
  const up = clone.querySelector('#uploadCard'); if (up) up.remove();
  const uz = clone.querySelector('#uploadZone'); if (uz) uz.remove();
  return '<!DOCTYPE html>\n' + clone.outerHTML;
}
function downloadBlob(text, filename, type='text/html'){
  const blob = new Blob([text], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
}
function buildExportFilename(ext){
  function safeSlug(s){
    return String(s||'').normalize('NFKD').replace(/[^\w\s-]+/g,'').trim().replace(/[\s_-]+/g,'_').replace(/^_+|_+$/g,'');
  }
  function monthRangeStr(){
    try{
      const m = STATE.months||[]; if (!m.length) return '';
      return `${m[0]}_a_${m[m.length-1]}`.replace(/\s+/g,'_');
    }catch(_){ return ''; }
  }
  function totalStr(){
    try{
      const t = (STATE.totalsPerMonth||[]).reduce((a,b)=>a+(b||0),0) || 0;
      return t ? ('Tot_' + t.toFixed(2).replace(/\./g,'_')) : '';
    }catch(_){ return ''; }
  }
  const proj = safeSlug(STATE.projectTitle || 'Proyecto');
  const pid  = STATE.projectId ? ('ID_' + safeSlug(STATE.projectId)) : '';
  const per  = monthRangeStr();
  const tot  = totalStr();
  const ts   = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  const parts = ['CBDIO', proj]; if (pid) parts.push(pid); if (per) parts.push(per); if (tot) parts.push(tot); parts.push(ts);
  return parts.join('_') + '.' + ext;
}
// Freeze & download HTML
function onFreezeHTML(){
  try{
    const frozen = freezeDomClone();
    const fname = buildExportFilename('html');
    downloadBlob(frozen, fname, 'text/html');
  }catch(e){
    console.warn('Freeze HTML failed', e);
    alert('No se pudo generar el HTML congelado.');
  }
}
// Export to PDF via print (clean mode)
function onExportPDF(){
  try{
    document.body.classList.add('export-clean');
    setTimeout(()=> window.print(), 50);
    setTimeout(()=> document.body.classList.remove('export-clean'), 1500);
  }catch(e){
    console.warn('Export PDF failed', e);
    document.body.classList.remove('export-clean');
    alert('No se pudo preparar el PDF.');
  }
}
// PPTX best-effort using PptxGenJS from CDN
async function ensurePptx(){
  if (window.PptxGenJS) return window.PptxGenJS;
  await new Promise((res, rej)=>{
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js';
    s.onload = res; s.onerror = rej; document.head.appendChild(s);
  });
  return window.PptxGenJS;
}
async function onExportPPTX(){
  try{
    await ensurePptx();
    const PptxGenJS = window.PptxGenJS;
    const pptx = new PptxGenJS();
    pptx.author = 'CBDIO Dashboard'; pptx.company = 'CBDIO';
    const title = STATE.projectTitle || 'Reporte de Gastos';
    const per = (STATE.months||[]); const period = per.length? (per[0] + ' ‚Äì ' + per[per.length-1]) : '';
    // Title slide
    let slide = pptx.addSlide();
    slide.addText('Centro Binacional para el Desarrollo Ind√≠gena Oaxaque√±o', { x:0.5, y:0.5, w:9, h:0.6, fontSize:20, bold:true, color:'000000' });
    slide.addText('An√°lisis Financiero (JLE)', { x:0.5, y:1.1, w:9, h:0.5, fontSize:18, color:'000000' });
    slide.addText(`${title}${period?' ¬∑ '+period:''}`, { x:0.5, y:1.7, w:9, h:0.5, fontSize:16, color:'000000' });

    // Collect chart images
    const charts = Array.from(document.querySelectorAll('canvas')).map(cv=>({ id: cv.id, data: cv.toDataURL('image/png') })).filter(o=>o.data);

    for (const chunk of charts){
      const s = pptx.addSlide();
      s.addText(chunk.id || 'Gr√°fica', { x:0.5, y:0.4, w:9, h:0.4, fontSize:16, color:'000000' });
      s.addImage({ data: chunk.data, x:0.5, y:0.9, w:8.5, h:4.5 });
    }

    const fname = buildExportFilename('pptx');
    await pptx.writeFile({ fileName: fname });
  }catch(e){
    console.warn('Export PPTX failed', e);
    alert('No se pudo generar el PPTX (intenta con el HTML congelado o PDF).');
  }
}

// Wire toolbar
(function(){
  const b1 = document.getElementById('btnFreezeHTML');
  const b2 = document.getElementById('btnExportPDF');
  const b3 = document.getElementById('btnExportPPTX');
  if (b1 && !b1.__wired){ b1.__wired = true; b1.addEventListener('click', onFreezeHTML); }
  if (b2 && !b2.__wired){ b2.__wired = true; b2.addEventListener('click', onExportPDF); }
  if (b3 && !b3.__wired){ b3.__wired = true; b3.addEventListener('click', onExportPPTX); }
})();


// ===== All Cats Trend interactive filters =====
window.__allCatsSelection = null; // Set of selected names or null for default
function populateAllCatsFilter(){
  try{
    const box = document.getElementById('allCatsChecks');
    if (!box) return;
    const cats = (STATE.cats||[]).slice().sort((a,b)=> b.total - a.total);
    box.innerHTML = cats.map(c => `<label style="display:flex;align-items:center;gap:6px;padding:4px 2px"><input type="checkbox" value="${c.name.replace(/"/g,'&quot;')}"/> <span>${c.name}</span></label>`).join('');
    // restore selection if present
    const sel = window.__allCatsSelection;
    if (sel && sel.size){
      box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = sel.has(cb.value));
    } else {
      // default to Top 10
      Array.from(box.querySelectorAll('input[type="checkbox"]')).forEach((cb,i)=> cb.checked = (i<10));
    }
    // Wire buttons
    const on = (id, fn)=>{ const el = document.getElementById(id); if (el && !el.__wired){ el.__wired=true; el.onclick=fn; } };
    const chooseTop = (n)=>{
      const inputs = Array.from(box.querySelectorAll('input[type="checkbox"]'));
      inputs.forEach((cb,i)=> cb.checked = (i < n));
      autoApplyAllCats();
    };
    const chooseAll = ()=>{ box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=true); autoApplyAllCats(); };
    const chooseNone = ()=>{ box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false); autoApplyAllCats(); };
    on('allCatsTop5', ()=> chooseTop(5));
    on('allCatsTop10', ()=> chooseTop(10));
    on('allCatsAll', chooseAll);
    on('allCatsNone', chooseNone);
    on('allCatsApply', ()=> autoApplyAllCats(true));

    // search filtering
    const search = document.getElementById('allCatsSearch');
    if (search && !search.__wired){
      search.__wired = true;
      search.addEventListener('input', ()=>{
        const q = search.value.trim().toLowerCase();
        Array.from(box.querySelectorAll('label')).forEach(lab=>{
          const txt = (lab.textContent||'').toLowerCase();
          lab.style.display = txt.includes(q) ? '' : 'none';
        });
      });
    }
    // auto-apply on change
    if (!box.__wiredChange){
      box.__wiredChange = true;
      box.addEventListener('change', ()=> autoApplyAllCats());
    }
  }catch(e){ console.warn('populateAllCatsFilter failed', e); }
}
function getAllCatsSelected(){
  const box = document.getElementById('allCatsChecks');
  if (!box) return [];
  return Array.from(box.querySelectorAll('input[type="checkbox"]:checked')).map(i=> i.value);
}
function autoApplyAllCats(force=false){
  try{
    const picked = getAllCatsSelected();
    window.__allCatsSelection = picked.length ? new Set(picked) : (force ? new Set() : null);
    // Re-render charts, which will read the selection
    renderCharts(STATE.months||[], STATE.totalsPerMonth||[], STATE.cats||[]);
  }catch(e){ console.warn('autoApplyAllCats failed', e); }
}







</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pptxgenjs/3.10.1/pptxgen.bundle.js">
// ====== Executive Analysis ======
function perc(x){ return (x*100).toFixed(1)+'%'; }
function safeDiv(a,b){ return b && b!=0 ? (a/b) : 0; } // Pythonic; fix to JS below

function generateExecutiveAnalysis(){
  const months = STATE.months || [];
  const cats = STATE.cats || [];
  if (!months.length || !cats.length){ document.getElementById('execWrap').classList.add('hidden'); return; }

  // Top categories
  const topCats = [...cats].sort((a,b)=> b.total - a.total).slice(0,5);

  // Overall trend & volatility
  const m = STATE.totalsPerMonth || [];
  const n = m.length;
  const total = m.reduce((a,b)=>a+b,0);
  const avg = total / (n||1);
  const slope = slopePerMonth(m);
  const last = m[n-1] || 0, first = m[0] || 0;
  const mom = n>1 ? (last - (m[n-2]||0)) : 0;
  const yoy = n>12 ? (last - (m[n-13]||0)) : null;

  // volatility (coeficiente de variaci√≥n)
  const varc = m.reduce((acc,v)=> acc + Math.pow(v-avg,2), 0) / (n || 1);

  const stdev = Math.sqrt(varc);
  const cv = avg ? stdev/avg : 0;

  // Category drivers (slopes)
  const catTrends = cats.map(c=>({ 
    name:c.name, 
    slope:slopePerMonth(c.monthly), 
    total:c.total, 
    last:c.monthly[c.monthly.length-1]||0,
    avg:c.total/(c.monthly.length||1)
  })).sort((a,b)=> Math.abs(b.slope) - Math.abs(a.slope));

  const upDrivers = catTrends.filter(x=>x.slope>0).slice(0,3);
  const downDrivers = catTrends.filter(x=>x.slope<0).slice(0,3);

  // Build narrative
  const lines = [];
  lines.push(`Proyecto: ${STATE.projectTitle}`);
  lines.push(`Periodo: ${months[0]} ‚Äì ${months[months.length-1]}`);
  lines.push('');
  lines.push('1) Resumen ejecutivo');
  const slopeTxt = (slope>=0?'+':'-') + Math.abs(slope).toFixed(2) + ' USD/mes';
  const momTxt = (mom>=0?'+':'-') + Math.abs(mom).toFixed(2);
  lines.push(`‚Ä¢ Gasto total: ${fmtUSD(total)} ¬∑ Promedio mensual: ${fmtUSD(avg)} ¬∑ Tendencia: ${slope>=0?'üìà al alza':'üìâ a la baja'} (${slopeTxt}). Volatilidad (CV): ${(cv*100).toFixed(1)}%.`);
  lines.push(`‚Ä¢ √öltimo mes vs anterior: ${mom>=0?'‚ñ≤':'‚ñº'} ${fmtUSD(Math.abs(mom))}${yoy!==null?` ¬∑ Œî vs hace 12 meses: ${yoy>=0?'‚ñ≤':'‚ñº'} ${fmtUSD(Math.abs(yoy))}`:''}.`);
  lines.push('');
  lines.push('2) Principales categor√≠as (Top 5 por gasto total)');
  topCats.forEach((c,i)=>{
    const s = slopePerMonth(c.monthly);
    lines.push(`   ${i+1}. ${c.name}: ${fmtUSD(c.total)} (${fmtUSD(c.total/(c.monthly.length||1))}/mes) ¬∑ Tendencia: ${s>=0?'üìà':'üìâ'} ${ (s>=0?'+':'-') + fmtUSD(Math.abs(s)).replace('$','') } USD/mes.`);
  });
  // Sem√°foro counts
  const semCounts = cats.reduce((acc,c)=>{ const avg = c.total/(c.monthly.length||1); const thr = Math.max(1, 0.05*(avg||1)); const s = slopePerMonth(c.monthly); if (s>thr) acc.rojo++; else if (s<-thr) acc.verde++; else acc.amarillo++; return acc; }, {rojo:0,amarillo:0,verde:0});
  lines.push(`‚Ä¢ Sem√°foro categor√≠as ‚Äì Rojo: ${semCounts.rojo} ¬∑ Amarillo: ${semCounts.amarillo} ¬∑ Verde: ${semCounts.verde}`);
  lines.push('');
  lines.push('3) Categor√≠as que m√°s mueven la tendencia');
  lines.push('   Al alza:');
  upDrivers.forEach(d=> lines.push(`   ‚Ä¢ ${d.name}: pendiente +${d.slope.toFixed(2)} USD/mes (prom: ${fmtUSD(d.avg)})`));
  const topRojos = catTrends.filter(x=> x.slope>0 && x.slope > Math.max(1, 0.05*(x.avg||1))).slice(0,5);
  if (topRojos.length){ lines.push('   (Top rojos a vigilar)'); topRojos.forEach(tr => lines.push(`     ‚ó¶ ${tr.name}: +${tr.slope.toFixed(2)} USD/mes`)); }
  lines.push('   A la baja:');
  downDrivers.forEach(d=> lines.push(`   ‚Ä¢ ${d.name}: pendiente ${d.slope.toFixed(2)} USD/mes (prom: ${fmtUSD(d.avg)})`));
  lines.push('');
  lines.push('4) Lectura y riesgos');
  if (cv>0.35){ lines.push('   ‚Ä¢ Alta variabilidad mensual: considerar calendarizar gastos o revisar estacionalidad/one-offs.'); }
  if (slope>0 && (upDrivers[0]?.slope||0) > (0.2*avg)){ lines.push('   ‚Ä¢ La tendencia ascendente est√° concentrada en pocas categor√≠as: riesgo de presi√≥n presupuestal focalizada.'); }
  if (topCats[0] && (topCats[0].total/total) > 0.35){ lines.push(`   ‚Ä¢ Concentraci√≥n en ${topCats[0].name}: >35% del total; monitorear dependencia y justificar variaciones.`); }
  lines.push('');
  lines.push('5) Recomendaciones de gesti√≥n');
  lines.push('   ‚Ä¢ Establecer topes mensuales por categor√≠a top y activar alertas (>10% sobre promedio).');
  lines.push('   ‚Ä¢ Revisar contratos/vales en categor√≠as con pendiente positiva elevada y negociar condiciones.');
  lines.push('   ‚Ä¢ Programar gastos estacionales para suavizar picos; usar compromisos (encumbrances) donde aplique.');
  lines.push('   ‚Ä¢ Preparar nota explicativa para el Board si el √∫ltimo mes muestra desviaciones >15% vs promedio.');

  const text = lines.join('\n');
  const box = document.getElementById('execText');
  box.textContent = text;
  document.getElementById('execWrap').classList.remove('hidden');

  // Export buttons
  const bPDF = document.getElementById('exportExecPDF');
  
if (bPDF){
  bPDF.onclick = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });
    const margin = 48, width = 540;
    const title = 'Reporte Ejecutivo ‚Äì Gastos';
    const project = STATE.projectTitle || '';
    const period = (STATE.months && STATE.months.length) ? (STATE.months[0] + ' ‚Äì ' + STATE.months[STATE.months.length-1]) : '';

    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text(title, margin, margin);
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    doc.text('Proyecto: ' + project, margin, margin+16);
    doc.text('Periodo: ' + period, margin, margin+30);

    let y = margin + 54;
    const addHeading = (txt)=>{ doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text(stripEmojis(txt), margin, y); y += 16; doc.setFont('helvetica','normal'); doc.setFontSize(10); };
    const addPara = (txt)=>{
      const lines = doc.splitTextToSize(stripEmojis(txt), width);
      lines.forEach(line => { if (y>780){ doc.addPage(); y = margin; } doc.text(line, margin, y); y += 14; });
    };
    const addList = (arr)=>{
      arr.forEach(item => {
        const lines = doc.splitTextToSize('‚Ä¢ ' + stripEmojis(item), width);
        lines.forEach((line, idx) => { if (y>780){ doc.addPage(); y = margin; } doc.text(line, margin, y); y += 14; });
      });
    };

    // Build sections from DOM bullets for clean structure
    const bulletsEl = document.getElementById('execBullets');
    if (bulletsEl){
      const groups = [];
      let current = null;
      bulletsEl.childNodes.forEach(node => {
        if (node.tagName === 'STRONG'){
          if (current) groups.push(current);
          current = { heading: node.textContent.trim(), items: [] };
        } else if (node.tagName === 'UL'){
          const lis = Array.from(node.querySelectorAll('li')).map(li => li.textContent.trim());
          if (!current) current = { heading: '', items: [] };
          current.items.push(...lis);
        } else if (node.tagName === 'DIV'){
          // plain line (e.g., sem√°foro counts)
          if (!current) current = { heading: '', items: [] };
          current.items.push(node.textContent.trim());
        }
      });
      if (current) groups.push(current);

      // Render each group
      groups.forEach(g => {
        if (g.heading){
          addHeading(g.heading);
        }
        if (g.items && g.items.length){
          addList(g.items);
          y += 6;
        }
      });
    } else {
      // Fallback: use text block
      addHeading('Resumen');
      addPara((document.getElementById('execText')?.textContent)||'');
    }

    doc.save('cbdio_exec_summary.pdf');
  };
}


  const bCopy = document.getElementById('copyExec');
  if (bCopy){
    bCopy.onclick = async () => {
      try{ await navigator.clipboard.writeText(text); alert('Reporte ejecutivo copiado al portapapeles.'); }
      catch(e){ alert('No se pudo copiar autom√°ticamente. Selecciona el texto y copia manualmente.'); }
    };
  }
}


// ====== Extra charts (Top5 share & MoM Top3) ======
function renderExtraCharts(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;

    // Build/refresh filter UI
    buildCategoryFilterUI();
    // Compute Top share according to selection
    const total = (STATE.totalsPerMonth||[]).reduce((a,b)=>a+b,0);
    const catsSorted = [...cats].sort((a,b)=> b.total - a.total);
    const sel = getTopShareSelection(total, catsSorted);
    const topNames = sel.selected.map(c=>c.name);
    const topVals = sel.selected.map(c=>c.total);
    const topShares = topVals.map(v => total? (v/total*100) : 0);
    const labelsShare = [...topNames, 'Otros'];
    const dataShare = [...topShares, total? (sel.others/total*100) : 0];
    const colorsShare = [...topNames.map(n=> colorFor(n)), '#9ca3af'];

    // Compute MoM deltas (last vs prev) per category
    const deltas = cats.map(c=> (c.monthly[c.monthly.length-1]||0) - (c.monthly[c.monthly.length-2]||0));
    const momArr = cats.map((c,i)=> ({ name:c.name, delta:deltas[i] }));
    const momUp = [...momArr].sort((a,b)=> b.delta - a.delta).slice(0,3);
    const momDown = [...momArr].sort((a,b)=> a.delta - b.delta).slice(0,3).reverse(); // make it descending absolute with negatives shown
    const momData = [...momUp, ...momDown.map(x=>({name:x.name, delta:x.delta}))]; // keep negatives

    // Show container
    const wrap = document.getElementById('charts3');
    if (wrap) wrap.classList.remove('hidden');

    // Render Top5 Share (bar horizontal)
    const shCtx = document.getElementById('top5Share').getContext('2d');
    if (charts.top5Share) charts.top5Share.destroy();
    charts.top5Share = new Chart(shCtx, {
      type: 'bar',
      data: { labels: labelsShare, datasets: [{ label: '% del total', data: dataShare, backgroundColor: colorsShare }] },
      options: {
        indexAxis: 'y',
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(ctx)=> ctx.parsed.x.toFixed(1) + '%' } } },
        scales:{ x:{ beginAtZero:true, ticks:{ callback:(v)=> v + '%' }, max:100 } }
      }
    });

    // Render MoM Top3 (barras, mezcla de positivos/negativos)
    const momCtx = document.getElementById('momTop3').getContext('2d');
    if (charts.momTop3) charts.momTop3.destroy();
    charts.momTop3 = new Chart(momCtx, {
      type: 'bar',
      data: { labels: momData.map(x=>x.name), datasets: [{ label: 'Œî √∫ltimo mes', data: momData.map(x=>x.delta), backgroundColor: momData.map(x=> x.delta>=0 ? '#10b981' : '#ef4444') }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(ctx)=> (ctx.parsed.y>=0?'+':'-') + Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(Math.abs(ctx.parsed.y)) } } },
        scales:{ y:{ beginAtZero:false } }
      }
    });

  }catch(e){ console.warn('renderExtraCharts failed', e); }
}


// ====== Category filter UI for Top Share ======
function buildCategoryFilterUI(){
  const modeSel = document.getElementById('topShareMode');
  const panel = document.getElementById('customCatPanel');
  const list = document.getElementById('customCatList');
  const btnAll = document.getElementById('btnAllCats');
  const btnNone = document.getElementById('btnNoneCats');
  const btnApply = document.getElementById('btnApplyCats');
  if (!modeSel || !panel || !list) return;

  // Populate checkbox list from STATE.cats, ordered by total desc
  const cats = [...(STATE.cats||[])].sort((a,b)=> b.total - a.total);
  // Restore previous mode/selection if available on first build
  if (!STATE.__restored){ restoreModeAndSelection(); STATE.__restored = true; }

  list.innerHTML = cats.map((c,i)=>{
    const checked = (STATE.customCats.length ? STATE.customCats.includes(c.name) : (i<5));
    return `<label style="display:inline-flex;align-items:center;gap:6px;margin:4px 10px 4px 0">
      <input type="checkbox" data-cat="${c.name.replace(/"/g,'&quot;')}" ${checked?'checked':''}/>
      <span>${c.name}</span>
    </label>`;
  }).join('');

  modeSel.value = STATE.shareMode || 'top5'; seedDefaultPresetsIfEmpty(); populatePresetSelect(); attachPresetHandlers(); attachSearchHandler();
  panel.classList.toggle('hidden', modeSel.value !== 'custom');

  modeSel.onchange = () => {
    STATE.shareMode = modeSel.value;
    panel.classList.toggle('hidden', STATE.shareMode !== 'custom');
    persistModeAndSelection();
    // If not custom, re-render directly
    if (STATE.shareMode !== 'custom'){
      renderExtraCharts();
    }
  };

  btnAll.onclick = () => {
    list.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = true);
  };
  btnNone.onclick = () => {
    list.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = false);
  };
  btnApply.onclick = () => {
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    STATE.customCats = chosen;
    persistModeAndSelection();
    renderExtraCharts();
  };
}

function getTopShareSelection(total, catsSorted){
  // catsSorted: [{name,total,monthly}...] sorted desc by total
  let selected = [];
  if (STATE.shareMode === 'top10'){
    selected = catsSorted.slice(0,10);
  } else if (STATE.shareMode === 'custom'){
    const set = new Set(STATE.customCats||[]);
    selected = catsSorted.filter(c => set.has(c.name));
    if (!selected.length){ selected = catsSorted.slice(0,5); } // fallback
  } else { // top5 default
    selected = catsSorted.slice(0,5);
  }
  const selTotal = selected.reduce((a,c)=> a + c.total, 0);
  const others = Math.max(0, total - selTotal);
  return { selected, others };
}


// ====== Presets & Search for category filter ======
const PRESET_KEY = 'cbdio_topshare_presets_v1';
const MODE_KEY = 'cbdio_topshare_mode';
const SEL_KEY = 'cbdio_topshare_customCats';

function loadPresets(){
  try{ return JSON.parse(localStorage.getItem(PRESET_KEY) || '{}'); }catch(e){ return {}; }
}
function savePresets(obj){
  try{ localStorage.setItem(PRESET_KEY, JSON.stringify(obj)); }catch(e){}
}
function persistModeAndSelection(){
  try{
    localStorage.setItem(MODE_KEY, STATE.shareMode || 'top5');
    localStorage.setItem(SEL_KEY, JSON.stringify(STATE.customCats || []));
  }catch(e){}
}
function restoreModeAndSelection(){
  try{
    const m = localStorage.getItem(MODE_KEY);
    const s = localStorage.getItem(SEL_KEY);
    if (m) STATE.shareMode = m;
    if (s) STATE.customCats = JSON.parse(s);
  }catch(e){}
}

function populatePresetSelect(){
  const sel = document.getElementById('presetSelect');
  if (!sel) return;
  const presets = loadPresets();
  const names = Object.keys(presets).sort();
  sel.innerHTML = '<option value="">(elige un preset)</option>' + names.map(n => `<option value="${n}">${n}</option>`).join('');
}

function attachPresetHandlers(){
  const btnLoad = document.getElementById('btnLoadPreset');
  const btnSave = document.getElementById('btnSavePreset');
  const btnDel  = document.getElementById('btnDeletePreset');
  const sel     = document.getElementById('presetSelect');
  const list    = document.getElementById('customCatList');

  if (btnLoad) btnLoad.onclick = () => {
    const name = sel && sel.value;
    if (!name) return;
    const presets = loadPresets();
    if (presets[name]){
      STATE.customCats = presets[name];
      // Reflect in checkboxes
      list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = STATE.customCats.includes(cb.getAttribute('data-cat'));
      });
      renderExtraCharts();
    }
  };

  if (btnSave) btnSave.onclick = () => {
    const name = prompt('Nombre del preset:');
    if (!name) return;
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    const presets = loadPresets();
    presets[name] = chosen;
    savePresets(presets);
    populatePresetSelect();
    alert('Preset guardado.');
  };

  if (btnDel) btnDel.onclick = () => {
    const name = sel && sel.value;
    if (!name) return;
    const presets = loadPresets();
    if (presets[name]){
      if (confirm('¬øEliminar preset "'+name+'"?')){
        delete presets[name];
        savePresets(presets);
        populatePresetSelect();
        alert('Preset eliminado.');
      }
    }
  };
}

function attachSearchHandler(){
  const input = document.getElementById('catSearch');
  const list  = document.getElementById('customCatList');
  if (!input || !list) return;
  input.oninput = () => {
    const q = input.value.trim().toLowerCase();
    list.querySelectorAll('label').forEach(lbl => {
      const text = lbl.textContent.toLowerCase();
      lbl.style.display = (!q || text.includes(q)) ? 'inline-flex' : 'none';
    });
  };
}


// ====== Seed default presets: Direct vs Indirect ======
function categorizeDefaultBuckets(catNames){
  const direct = new Set();
  const indirect = new Set();
  const push = (set, name) => set.add(name);

  catNames.forEach(name => {
    const low = name.toLowerCase();
    // Likely DIRECT
    if (/(salary|wage)/.test(low)) return push(direct, name);
    if (/(benefit|payroll|fringe|medical|vision|dental|life)/.test(low)) return push(direct, name);
    if (/(stipend|scholar)/.test(low)) return push(direct, name);
    if (/(program supplies|workshop|event)/.test(low)) return push(direct, name);
    if (/(travel|mileage|lodging|hotel|meals)/.test(low)) return push(direct, name);
    if (/(training|capacity)/.test(low)) return push(direct, name);
    if (/(consultant|contract service)/.test(low)) return push(direct, name);
    if (/(equipment)/.test(low)) return push(direct, name);
    if (/(printing|copy)/.test(low)) return push(direct, name);
    // Likely INDIRECT
    if (/(office rent|rent)/.test(low)) return push(indirect, name);
    if (/(office expenses|office|postage|mail|software)/.test(low)) return push(indirect, name);
    if (/(internet|communication|telephone|web)/.test(low)) return push(indirect, name);
    if (/(utilities|maintenance|janitorial|repair)/.test(low)) return push(indirect, name);
    if (/(marketing|advertising)/.test(low)) return push(indirect, name);
    if (/(insurance)/.test(low)) return push(indirect, name);
    if (/(indirect)/.test(low)) return push(indirect, name);
    // Fallback: lean to INDIRECT
    push(indirect, name);
  });

  return { direct: Array.from(direct), indirect: Array.from(indirect) };
}

function seedDefaultPresetsIfEmpty(){
  const presets = loadPresets();
  if (Object.keys(presets).length > 0) return; // already have user presets

  const catNames = (STATE.cats||[]).map(c=>c.name);
  const { direct, indirect } = categorizeDefaultBuckets(catNames);

  // Only save if we have at least something
  if (direct.length || indirect.length){
    presets['Direct'] = direct;
    presets['Indirect'] = indirect;
    savePresets(presets);
  }
}


// ====== Manager Tables Renderer ======
function renderManagerTables(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;

    // ---- Top categor√≠as por gasto ----
    const totalAll = (STATE.totalsPerMonth||[]).reduce((a,b)=>a+b,0) || 1;
    const topSorted = [...cats].sort((a,b)=> b.total - a.total).slice(0,5);
    const tbodyTop = document.querySelector('#tblTopCats tbody');
    if (tbodyTop){
      tbodyTop.innerHTML = '';
      const maxTotal = topSorted.length ? Math.max(...topSorted.map(c=>c.total)) : 1;
      topSorted.forEach((c,idx)=>{
        const avg = c.total/(c.monthly.length||1);
        const s = slopePerMonth(c.monthly||[]);
        const tag = s>Math.max(1,.05*(avg||1)) ? 'üìà Al alza' : (s<-Math.max(1,.05*(avg||1)) ? 'üìâ A la baja' : '‚û°Ô∏è Estable');
        const pct = (c.total/totalAll*100);
        const color = colorFor(c.name);
        const barW = Math.max(4, (c.total/maxTotal)*100);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx+1}</td>
          <td>${c.name}</td>
          <td style="text-align:right">${fmtUSD(c.total)}</td>
          <td style="text-align:right">${pct.toFixed(1)}%</td>
          <td style="text-align:right">${fmtUSD(avg)}</td>
          <td>${tag}</td>
          <td><div class="barcell"><div class="barfill" style="width:${barW}%;background:${color}33"></div></div></td>`;
        tbodyTop.appendChild(tr);
      });
    }

    // ---- Heatmap mensual por categor√≠a ----
    const head = document.getElementById('hmHead');
    const body = document.getElementById('hmBody');
    if (head && body){
      head.innerHTML = '<tr><th>Categor√≠a</th>' + months.map(m=> `<th>${m}</th>`).join('') + '<th style="text-align:right">Total</th></tr>';
      body.innerHTML = '';
      // Global min/max for scaling
      let gmin = Infinity, gmax = -Infinity;
      cats.forEach(c => (c.monthly||[]).forEach(v => { gmin = Math.min(gmin, v||0); gmax = Math.max(gmax, v||0); }));
      if (!isFinite(gmin)) gmin = 0; if (!isFinite(gmax) || gmax<=0) gmax = 1;
      function cellColor(v){
        const x = Math.max(0, Math.min(1, v/gmax));
        // scale green->yellow->red
        const r = Math.round(255 * x);
        const g = Math.round(200 * (1 - x) + 40);
        const b = 80;
        return `rgba(${r},${g},${b},0.18)`;
      }
      const catsSorted = [...cats].sort((a,b)=> b.total - a.total);
      catsSorted.forEach(c => {
        const tr = document.createElement('tr');
        let tds = `<td>${c.name}</td>`;
        (c.monthly||[]).forEach(v => {
          tds += `<td class="hmcell" style="background:${cellColor(v||0)}">${v?fmtUSD(v):''}</td>`;
        });
        tds += `<td style="text-align:right">${fmtUSD(c.total||0)}</td>`;
        tr.innerHTML = tds;
        body.appendChild(tr);
      });
    }

    // ---- Direct vs Indirect (tabla) ----
    const diBody = document.querySelector('#tblDirectIndirect tbody');
    if (diBody){
      diBody.innerHTML = '';
      const names = cats.map(c=> c.name);
      // Use existing heuristics from V19
      const buckets = categorizeDefaultBuckets ? categorizeDefaultBuckets(names) : { direct:names, indirect:[] };
      const setD = new Set(buckets.direct||[]);
      let totalD = 0, totalI = 0;
      cats.forEach(c => { if (setD.has(c.name)) totalD += c.total; else totalI += c.total; });
      const tot = totalD + totalI || 1;
      const pD = (totalD/tot*100), pI = (totalI/tot*100);

      function barHTML(pct, color){ return `<div class="barcell"><div class="barfill" style="width:${pct.toFixed(1)}%;background:${color}66"></div></div>`; }

      const trD = document.createElement('tr');
      trD.innerHTML = `<td>Direct</td><td style="text-align:right">${fmtUSD(totalD)}</td><td style="text-align:right">${pD.toFixed(1)}%</td><td>${barHTML(pD,'#10b981')}</td>`;
      const trI = document.createElement('tr');
      trI.innerHTML = `<td>Indirect</td><td style="text-align:right">${fmtUSD(totalI)}</td><td style="text-align:right">${pI.toFixed(1)}%</td><td>${barHTML(pI,'#7c3aed')}</td>`;

      diBody.appendChild(trD);
      diBody.appendChild(trI);
    }
  }catch(e){ console.warn('renderManagerTables failed', e); }
}


// ====== Zero-month filter: drop months with total 0 ======
function applyZeroMonthFilter(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;
    // compute totals per month from categories if missing
    const n = (cats[0].monthly||[]).length;
    const totals = Array(n).fill(0);
    cats.forEach(c => { for(let i=0;i<n;i++){ totals[i] += (c.monthly[i]||0); } });
    // indices where totals > 0
    const keepIdx = [];
    for (let i=0;i<n;i++){ if (Math.abs(totals[i]) > 1e-9) keepIdx.push(i); }
    if (keepIdx.length === n) { STATE.totalsPerMonth = totals; return; } // nothing to drop

    // Filter months and cat series
    STATE.months = keepIdx.map(i => months[i]);
    STATE.cats = cats.map(c => ({
      name: c.name,
      monthly: keepIdx.map(i => c.monthly[i]||0),
      total: keepIdx.reduce((s,i)=> s + (c.monthly[i]||0), 0)
    }));
    // Recompute totalsPerMonth
    const totals2 = Array(keepIdx.length).fill(0);
    STATE.cats.forEach(c => { for(let i=0;i<keepIdx.length;i++){ totals2[i] += (c.monthly[i]||0); } });
    STATE.totalsPerMonth = totals2;
  }catch(e){ console.warn('applyZeroMonthFilter failed', e); }
}


// ====== Comparator Chart ======
function buildComparatorUI(){
  const list = document.getElementById('cmpList');
  if (!list) return;
  const cats = STATE.cats || [];
  // order by total desc
  const ordered = [...cats].sort((a,b)=> b.total - a.total);
  list.innerHTML = ordered.map(c => `
    <label style="display:inline-flex;align-items:center;gap:6px;margin:4px 10px 4px 0">
      <input type="checkbox" data-cat="${c.name.replace(/"/g,'&quot;')}"/>
      <span>${c.name}</span>
    </label>
  `).join('');

  const btnTop = document.getElementById('btnCmpTop5');
  const btnClr = document.getElementById('btnCmpClear');
  const btnApp = document.getElementById('btnCmpApply');
  const modeSel = document.getElementById('cmpMode');

  const maxSel = 6;
  function applyTop(n=5){
    list.querySelectorAll('input[type="checkbox"]').forEach((cb,idx)=> cb.checked = (idx<n));
  }
  function clearAll(){
    list.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = false);
  }
  function getChosen(){
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    return chosen.slice(0, maxSel);
  }
  if (btnTop && !btnTop.__wired){ btnTop.__wired = true; btnTop.onclick = ()=> { applyTop(5); renderComparator(); }; }
  if (btnClr && !btnClr.__wired){ btnClr.__wired = true; btnClr.onclick = ()=> { clearAll(); renderComparator(); }; }
  if (btnApp && !btnApp.__wired){ btnApp.__wired = true; btnApp.onclick = ()=> renderComparator(); }
  if (modeSel && !modeSel.__wired){ modeSel.__wired = true; modeSel.onchange = ()=> renderComparator(); }

  // default to Top 5
  applyTop(5);
}

function renderComparator(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;
    const modeSel = document.getElementById('cmpMode');
    const mode = modeSel ? modeSel.value : 'line';
    const list = document.getElementById('cmpList');
    if (!list) return;
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    const chosenSet = new Set(chosen);
    const picked = cats.filter(c => chosenSet.has(c.name)).slice(0,6);

    const datasets = picked.map(c => ({
      label: c.name,
      data: c.monthly,
      borderColor: colorFor(c.name),
      backgroundColor: colorFor(c.name) + '33',
      fill: (mode === 'line') ? false : true,
      tension: 0.25
    }));

    const ctx = document.getElementById('cmpChart').getContext('2d');
    if (!window.charts) window.charts = {};
    if (charts.cmpChart) { try{ charts.cmpChart.destroy(); }catch(e){} }
    charts.cmpChart = new Chart(ctx, {
      type: (mode === 'line') ? 'line' : 'bar',
      data: { labels: months, datasets: datasets },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ position:'bottom' } },
        scales: (mode==='bar') ? { x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } } : { y:{ beginAtZero:true } }
      }
    });
  }catch(e){ console.warn('renderComparator failed', e); }
}


// ====== Chart dropdown filters (scoped) ======
function populateChartFiltersScoped(){
  try{
    const cats = (STATE.cats||[]).slice().sort((a,b)=> b.total - a.total);
    const inject = (containerId)=>{
      const box = document.getElementById(containerId);
      if (!box) return;
      box.innerHTML = cats.map(c => `<label><input type="checkbox" value="${c.name.replace(/"/g,'&quot;')}"/> <span>${c.name}</span></label>`).join('');
    };
    inject('donutChecks'); inject('stackChecks');

    // buttons
    const on = (id, fn)=>{ const el = document.getElementById(id); if (el && !el.__wired){ el.__wired = true; el.onclick = fn; } };
    const selectTop = (wrapId, n)=>{
      const box = document.getElementById(wrapId);
      if (!box) return;
      const inputs = Array.from(box.querySelectorAll('input[type="checkbox"]'));
      inputs.forEach((cb,i)=> cb.checked = (i < n));
    };
    const clearAll = (wrapId)=>{
      const box = document.getElementById(wrapId);
      if (!box) return;
      box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false);
    };
    const reRender = ()=>{ try{ renderCharts(STATE.months||[], STATE.cats||[]); }catch(e){} };

    on('donutTop5', ()=>{ selectTop('donutChecks',5); reRender(); });
    on('donutClear', ()=>{ clearAll('donutChecks'); reRender(); });
    on('donutApply', ()=>{ reRender(); });

    on('stackTop8', ()=>{ selectTop('stackChecks',8); reRender(); });
    on('stackClear', ()=>{ clearAll('stackChecks'); reRender(); });
    on('stackApply', ()=>{ reRender(); });
  }catch(e){ console.warn('populateChartFiltersScoped failed', e); }
}
function getChecked(containerId){
  const box = document.getElementById(containerId);
  if (!box) return [];
  return Array.from(box.querySelectorAll('input[type="checkbox"]:checked')).map(i=> i.value);
}


// === Smart positioning for dropdown panels ===
(function smartPanels(){
  function adjustPanel(detailsEl, panelEl){
    if (!panelEl) return;
    // Reset classes
    panelEl.classList.remove('flip','modal');
    // If narrow viewport, modal class via CSS media already applies, but double-check for tiny heights
    const rect = panelEl.getBoundingClientRect();
    const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
    const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

    // If the panel would overflow to the right by >16px, flip to left
    if (rect.right > vw - 16) panelEl.classList.add('flip');
    // If the panel would overflow bottom by >16px, modal
    if (rect.bottom > vh - 16) panelEl.classList.add('modal');
  }

  function wireOne(detailsSel, panelSel){
    const d = document.querySelector(detailsSel);
    const p = document.querySelector(panelSel);
    if (!d || !p || d.__wired) return;
    d.__wired = true;
    d.addEventListener('toggle', ()=> { if (d.open) { setTimeout(()=> adjustPanel(d,p), 0); } });
    window.addEventListener('resize', ()=> { if (d.open) adjustPanel(d,p); });
    window.addEventListener('scroll', ()=> { if (d.open) adjustPanel(d,p); }, { passive:true });
  }

  // Wire both charts
  wireOne('.chart-filterbar details:nth-of-type(1)', '#donutPanel');
  wireOne('.chart-filterbar details:nth-of-type(2)', '#stackPanel');

  // Close on outside click when modal
  document.addEventListener('click', (ev)=>{
    const openDetails = Array.from(document.querySelectorAll('.chart-filterbar details[open]'));
    for (const d of openDetails){
      const panel = d.querySelector('.panel');
      if (panel && panel.classList.contains('modal')){
        if (!panel.contains(ev.target) && !d.querySelector('summary').contains(ev.target)){
          d.open = false;
        }
      }
    }
  });
})();  


// ====== Snapshot embed utilities ======
function getEmbeddedDataNode(){
  return document.getElementById('embeddedData');
}
function saveSnapshotToHTML(){
  try{
    const node = getEmbeddedDataNode();
    if (!node) return alert('No se encontr√≥ el contenedor de snapshot.');
    const payload = {
      months: STATE.months||[],
      cats: STATE.cats||[],
      totalsPerMonth: STATE.totalsPerMonth||[],
      meta: { generatedAt: new Date().toISOString(), version: 'v19-snapshot-1' }
    };
    node.textContent = JSON.stringify(payload);
    // Quick visual feedback
    const b = document.getElementById('btnEmbedSnapshot');
    if (b){ b.textContent = '‚úÖ Snapshot incrustado'; setTimeout(()=> b.textContent='üì¶ Guardar snapshot (incrustar datos)', 2000); }
  }catch(e){
    console.warn('saveSnapshotToHTML failed', e);
    alert('No se pudo guardar el snapshot.');
  }
}
function tryLoadEmbeddedSnapshot(){
  try{
    const node = getEmbeddedDataNode();
    if (!node || !node.textContent) return false;
    const p = JSON.parse(node.textContent);
    if (!p || !Array.isArray(p.months) || !Array.isArray(p.cats)) return false;
    // Set STATE
    STATE.months = p.months;
    STATE.cats = p.cats;
    STATE.totalsPerMonth = p.totalsPerMonth || [];
    // Hide upload card if present
    const up = document.getElementById('uploadCard');
    if (up) up.classList.add('hidden');
    const uz = document.getElementById('uploadZone'); if (uz) uz.classList.add('hidden');
    // Render everything
    renderKPI(STATE.months, STATE.cats);
    renderCharts(STATE.months, STATE.totalsPerMonth, STATE.cats);
    renderTables(STATE.months, STATE.cats);
    generateExecutiveAnalysis();
    renderManagerTables();
  populateAllCatsFilter();
    if (typeof renderExtraCharts==='function') renderExtraCharts();
    populateChartFiltersScoped && populateChartFiltersScoped();
    buildComparatorUI && buildComparatorUI();
    renderComparator && renderComparator();
    return true;
  }catch(e){
    console.warn('tryLoadEmbeddedSnapshot failed', e);
    return false;
  }
}


// Wire snapshot button
(function(){
  const btn = document.getElementById('btnEmbedSnapshot');
  if (btn && !btn.__wired){
    btn.__wired = true;
    btn.addEventListener('click', (e)=>{ e.preventDefault(); saveSnapshotToHTML(); });
  }
})();
// Try to load embedded snapshot on startup
document.addEventListener('DOMContentLoaded', ()=> {
  try{ tryLoadEmbeddedSnapshot(); }catch(e){}
});


// ====== Download snapshot as self-contained HTML ======
function ensureSnapshotInDOM(){
  // If embeddedData is empty, write current STATE to it
  const node = document.getElementById('embeddedData');
  if (!node) return false;
  if (!node.textContent || node.textContent.trim()===''){
    if (!window.STATE || !Array.isArray(STATE.months) || !Array.isArray(STATE.cats)) return false;
    const payload = {
      months: STATE.months||[],
      cats: STATE.cats||[],
      totalsPerMonth: STATE.totalsPerMonth||[],
      meta: { generatedAt: new Date().toISOString(), version: 'v19-snapshot-1' }
    };
    node.textContent = JSON.stringify(payload);
  }
  return true;
}
function downloadSnapshotCopy(){
  try{
    if (!ensureSnapshotInDOM()){
      alert('Necesito que subas un Excel primero para poder generar la copia con datos.');
      return;
    }
    // Serialize full HTML
    const htmlText = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
    const blob = new Blob([htmlText], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    a.download = `CBDIO_Expenses_Snapshot_${ts}.html`;
    a.href = url;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{
      URL.revokeObjectURL(url);
      a.remove();
    }, 100);
  }catch(e){
    console.warn('downloadSnapshotCopy failed', e);
    alert('No se pudo generar la copia con datos.');
  }
}


// Wire download snapshot button
(function(){
  const btn = document.getElementById('btnDownloadSnapshot');
  if (btn && !btn.__wired){
    btn.__wired = true;
    btn.addEventListener('click', (e)=>{ e.preventDefault(); downloadSnapshotCopy(); });
  }
})();


// ===== Export helpers =====
function canvasesToImages(scope=document){
  const canv = Array.from(scope.querySelectorAll('canvas'));
  const payload = [];
  canv.forEach(cv => {
    try{
      const url = cv.toDataURL('image/png');
      const img = document.createElement('img');
      img.src = url;
      img.alt = cv.id || 'chart';
      img.style.maxWidth = '100%';
      img.style.height = 'auto';
      payload.push({canvas: cv, image: img});
    }catch(e){ console.warn('toDataURL failed for', cv.id, e); }
  });
  return payload;
}
function freezeDomClone(){
  // Clone full document to avoid mutating live dashboard
  const clone = document.documentElement.cloneNode(true);
  // Remove scripts to avoid re-running code in snapshot
  clone.querySelectorAll('script').forEach(s => s.remove());
  // Replace canvases with images
  const pairs = canvasesToImages(document);
  pairs.forEach(({canvas, image})=>{
    const sel = canvas.id ? `#${CSS.escape(canvas.id)}` : null;
    const twin = sel ? clone.querySelector(sel) : null;
    if (twin && twin.tagName.toLowerCase()==='canvas'){
      twin.replaceWith(image.cloneNode(true));
    }
  });
  // Add export-clean class and hide uploader
  clone.querySelector('body')?.classList.add('export-clean');
  const up = clone.querySelector('#uploadCard'); if (up) up.remove();
  const uz = clone.querySelector('#uploadZone'); if (uz) uz.remove();
  return '<!DOCTYPE html>\n' + clone.outerHTML;
}
function downloadBlob(text, filename, type='text/html'){
  const blob = new Blob([text], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
}
function buildExportFilename(ext){
  function safeSlug(s){
    return String(s||'').normalize('NFKD').replace(/[^\w\s-]+/g,'').trim().replace(/[\s_-]+/g,'_').replace(/^_+|_+$/g,'');
  }
  function monthRangeStr(){
    try{
      const m = STATE.months||[]; if (!m.length) return '';
      return `${m[0]}_a_${m[m.length-1]}`.replace(/\s+/g,'_');
    }catch(_){ return ''; }
  }
  function totalStr(){
    try{
      const t = (STATE.totalsPerMonth||[]).reduce((a,b)=>a+(b||0),0) || 0;
      return t ? ('Tot_' + t.toFixed(2).replace(/\./g,'_')) : '';
    }catch(_){ return ''; }
  }
  const proj = safeSlug(STATE.projectTitle || 'Proyecto');
  const pid  = STATE.projectId ? ('ID_' + safeSlug(STATE.projectId)) : '';
  const per  = monthRangeStr();
  const tot  = totalStr();
  const ts   = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  const parts = ['CBDIO', proj]; if (pid) parts.push(pid); if (per) parts.push(per); if (tot) parts.push(tot); parts.push(ts);
  return parts.join('_') + '.' + ext;
}
// Freeze & download HTML
function onFreezeHTML(){
  try{
    const frozen = freezeDomClone();
    const fname = buildExportFilename('html');
    downloadBlob(frozen, fname, 'text/html');
  }catch(e){
    console.warn('Freeze HTML failed', e);
    alert('No se pudo generar el HTML congelado.');
  }
}
// Export to PDF via print (clean mode)
function onExportPDF(){
  try{
    document.body.classList.add('export-clean');
    setTimeout(()=> window.print(), 50);
    setTimeout(()=> document.body.classList.remove('export-clean'), 1500);
  }catch(e){
    console.warn('Export PDF failed', e);
    document.body.classList.remove('export-clean');
    alert('No se pudo preparar el PDF.');
  }
}
// PPTX best-effort using PptxGenJS from CDN
async function ensurePptx(){
  if (window.PptxGenJS) return window.PptxGenJS;
  await new Promise((res, rej)=>{
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js';
    s.onload = res; s.onerror = rej; document.head.appendChild(s);
  });
  return window.PptxGenJS;
}
async function onExportPPTX(){
  try{
    await ensurePptx();
    const PptxGenJS = window.PptxGenJS;
    const pptx = new PptxGenJS();
    pptx.author = 'CBDIO Dashboard'; pptx.company = 'CBDIO';
    const title = STATE.projectTitle || 'Reporte de Gastos';
    const per = (STATE.months||[]); const period = per.length? (per[0] + ' ‚Äì ' + per[per.length-1]) : '';
    // Title slide
    let slide = pptx.addSlide();
    slide.addText('Centro Binacional para el Desarrollo Ind√≠gena Oaxaque√±o', { x:0.5, y:0.5, w:9, h:0.6, fontSize:20, bold:true, color:'000000' });
    slide.addText('An√°lisis Financiero (JLE)', { x:0.5, y:1.1, w:9, h:0.5, fontSize:18, color:'000000' });
    slide.addText(`${title}${period?' ¬∑ '+period:''}`, { x:0.5, y:1.7, w:9, h:0.5, fontSize:16, color:'000000' });

    // Collect chart images
    const charts = Array.from(document.querySelectorAll('canvas')).map(cv=>({ id: cv.id, data: cv.toDataURL('image/png') })).filter(o=>o.data);

    for (const chunk of charts){
      const s = pptx.addSlide();
      s.addText(chunk.id || 'Gr√°fica', { x:0.5, y:0.4, w:9, h:0.4, fontSize:16, color:'000000' });
      s.addImage({ data: chunk.data, x:0.5, y:0.9, w:8.5, h:4.5 });
    }

    const fname = buildExportFilename('pptx');
    await pptx.writeFile({ fileName: fname });
  }catch(e){
    console.warn('Export PPTX failed', e);
    alert('No se pudo generar el PPTX (intenta con el HTML congelado o PDF).');
  }
}

// Wire toolbar
(function(){
  const b1 = document.getElementById('btnFreezeHTML');
  const b2 = document.getElementById('btnExportPDF');
  const b3 = document.getElementById('btnExportPPTX');
  if (b1 && !b1.__wired){ b1.__wired = true; b1.addEventListener('click', onFreezeHTML); }
  if (b2 && !b2.__wired){ b2.__wired = true; b2.addEventListener('click', onExportPDF); }
  if (b3 && !b3.__wired){ b3.__wired = true; b3.addEventListener('click', onExportPPTX); }
})();


// ===== All Cats Trend interactive filters =====
window.__allCatsSelection = null; // Set of selected names or null for default
function populateAllCatsFilter(){
  try{
    const box = document.getElementById('allCatsChecks');
    if (!box) return;
    const cats = (STATE.cats||[]).slice().sort((a,b)=> b.total - a.total);
    box.innerHTML = cats.map(c => `<label style="display:flex;align-items:center;gap:6px;padding:4px 2px"><input type="checkbox" value="${c.name.replace(/"/g,'&quot;')}"/> <span>${c.name}</span></label>`).join('');
    // restore selection if present
    const sel = window.__allCatsSelection;
    if (sel && sel.size){
      box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = sel.has(cb.value));
    } else {
      // default to Top 10
      Array.from(box.querySelectorAll('input[type="checkbox"]')).forEach((cb,i)=> cb.checked = (i<10));
    }
    // Wire buttons
    const on = (id, fn)=>{ const el = document.getElementById(id); if (el && !el.__wired){ el.__wired=true; el.onclick=fn; } };
    const chooseTop = (n)=>{
      const inputs = Array.from(box.querySelectorAll('input[type="checkbox"]'));
      inputs.forEach((cb,i)=> cb.checked = (i < n));
      autoApplyAllCats();
    };
    const chooseAll = ()=>{ box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=true); autoApplyAllCats(); };
    const chooseNone = ()=>{ box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false); autoApplyAllCats(); };
    on('allCatsTop5', ()=> chooseTop(5));
    on('allCatsTop10', ()=> chooseTop(10));
    on('allCatsAll', chooseAll);
    on('allCatsNone', chooseNone);
    on('allCatsApply', ()=> autoApplyAllCats(true));

    // search filtering
    const search = document.getElementById('allCatsSearch');
    if (search && !search.__wired){
      search.__wired = true;
      search.addEventListener('input', ()=>{
        const q = search.value.trim().toLowerCase();
        Array.from(box.querySelectorAll('label')).forEach(lab=>{
          const txt = (lab.textContent||'').toLowerCase();
          lab.style.display = txt.includes(q) ? '' : 'none';
        });
      });
    }
    // auto-apply on change
    if (!box.__wiredChange){
      box.__wiredChange = true;
      box.addEventListener('change', ()=> autoApplyAllCats());
    }
  }catch(e){ console.warn('populateAllCatsFilter failed', e); }
}
function getAllCatsSelected(){
  const box = document.getElementById('allCatsChecks');
  if (!box) return [];
  return Array.from(box.querySelectorAll('input[type="checkbox"]:checked')).map(i=> i.value);
}
function autoApplyAllCats(force=false){
  try{
    const picked = getAllCatsSelected();
    window.__allCatsSelection = picked.length ? new Set(picked) : (force ? new Set() : null);
    // Re-render charts, which will read the selection
    renderCharts(STATE.months||[], STATE.totalsPerMonth||[], STATE.cats||[]);
  }catch(e){ console.warn('autoApplyAllCats failed', e); }
}







</script>
  <style>
    :root{--ink:#0f172a;--muted:#64748b;--ok:#16a34a;--bad:#dc2626;--card:#fff;--b:#e5e7eb}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:12px;background:linear-gradient(135deg,#f3e8ff,#ede9fe);color:var(--ink)}
    .container{max-width:1500px;margin:0 auto}
    .card{background:var(--card);border-radius:14px;padding:14px;margin-bottom:12px;box-shadow:0 6px 16px rgba(2,6,23,.06)}
    .muted{color:var(--muted)} .hidden{display:none}
    .upload-zone{border:2px dashed #3b82f6;border-radius:14px;padding:28px;text-align:center;background:#f8fbff;cursor:pointer}
    .upload-zone.processing{border-color:#22c55e;background:#effef3}
    .status{margin-top:10px;padding:10px;border-radius:10px;font-weight:700}
    .status.success{background:#d4edda;color:#155724} .status.error{background:#fde2e2;color:#7a1b1b} .status.info{background:#e0f2fe;color:#075985}
    input[type=file]{display:none}
    .summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:1100px){.summary{grid-template-columns:1fr}}
    .tile{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:14px;padding:16px;text-align:center}
    .tile .v{font-size:1.6rem;font-weight:800}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:1100px){.grid{grid-template-columns:1fr}}
    .chart-container{position:relative;height:360px;margin-top:8px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid var(--b);padding:10px;text-align:left}
    th{background:#f5f7fb}
    .amount{text-align:right;font-weight:700}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .kbd{font-family:ui-monospace,monospace;background:#e5e7eb;padding:2px 6px;border-radius:6px}
    .note{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:10px;border-radius:12px}
    .small{font-size:.9rem}
    .diag{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:12px;white-space:pre-wrap;font-family:ui-monospace,monospace;font-size:12px;color:#111827}
    .btn{background:#111827;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#334155}
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .sem{display:inline-flex;align-items:center;gap:6px}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .dot.g{background:#16a34a}
    .dot.y{background:#f59e0b}
    .dot.r{background:#dc2626}
    #execBullets ul{margin:6px 0 10px 22px}
    #execBullets li{margin:3px 0}
    .headerTitle{color:#111827;text-align:center;margin-bottom:16px}
    .headerTitle h1{margin:0;font-size:1.6rem;letter-spacing:.2px}
    .headerTitle h2{margin:6px 0 0;font-size:1.1rem;font-weight:700;opacity:.95}
  
.table-responsive{overflow:auto}
table.compact{width:100%;border-collapse:collapse;font-size:14px}
table.compact th,table.compact td{padding:8px 10px;border-bottom:1px solid #e5e7eb}
.barcell{height:10px;border-radius:999px;background:#e5e7eb;position:relative;overflow:hidden}
.barfill{position:absolute;left:0;top:0;bottom:0;border-radius:999px}
.hmcell{min-width:68px;text-align:right;border-radius:6px}
.hm-legend{display:flex;gap:6px;align-items:center}
.hm-swatch{width:14px;height:14px;border-radius:4px;display:inline-block}


/* Scoped filters UI for charts (no global z-index to avoid input issues) */
.chart-filterbar{display:flex;justify-content:flex-end;margin:-6px 0 8px 0}
.chart-filterbar details{position:relative}
.chart-filterbar details>summary{list-style:none;cursor:pointer}
.chart-filterbar .panel{display:none;position:absolute;right:0;top:110%;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:10px;min-width:260px;max-height:260px;overflow:auto}
.chart-filterbar details[open] .panel{display:block}
.chart-filterbar .panel label{display:flex;align-items:center;gap:6px;padding:4px 2px}
.chart-filterbar .panel .row-actions{display:flex;gap:8px;margin-top:8px;justify-content:flex-end}
@media (max-width:720px){ .chart-filterbar .panel{right:auto;left:0} }


/* === Dropdown panel layering & responsive behavior === */
.card{ position: relative; } /* ensure a stacking context per card */
.chart-filterbar{ position: relative; z-index: 3; } /* toolbar above canvas */
.chart-container{ position: relative; z-index: 1; overflow: visible; } /* allow popover to overflow */
.chart-filterbar details{ position: relative; }
.chart-filterbar details > summary{ list-style: none; cursor: pointer; }
.chart-filterbar .panel{
  display:none; position:absolute; right:0; top:110%;
  background:#fff; border:1px solid #e5e7eb; border-radius:10px;
  box-shadow:0 12px 28px rgba(0,0,0,.12);
  padding:10px; min-width:280px; max-width:360px;
  max-height:320px; overflow:auto; z-index: 50;  /* above canvases */
}
.chart-filterbar details[open] .panel{ display:block; }
.chart-filterbar .panel.flip{ right:auto; left:0; } /* flip when near right edge */
.chart-filterbar .panel.modal{ position:fixed; left:12px; right:12px; top:auto; bottom:12px; max-height:60vh; z-index: 1000; }
.chart-filterbar .panel label{ display:flex; align-items:center; gap:6px; padding:4px 2px; }
.chart-filterbar .panel .row-actions{ display:flex; gap:8px; margin-top:8px; justify-content:flex-end; }

@media (max-width: 720px){
  .chart-filterbar .panel{ position: fixed; left:12px; right:12px; top:auto; bottom:12px; max-height:60vh; z-index: 1000; }
}


/* ===== Export / Print styles ===== */
@media print {
  @page { size: A4; margin: 16mm; }
  body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif !important; }
  h1, h2, h3 { color: #000 !important; }
  /* Hide upload card and toolbars on print */
  #uploadCard, #exportToolbar, .chart-filterbar, #cmpCard { display: none !important; }
  /* Remove emojis in print */
  .no-emoji, h1, h2, h3 { unicode-bidi: plaintext; }
  .title-emoji, .inline-emoji { display:none!important; }
}
/* Export-clean class for HTML/PDF generation */
.export-clean h1, .export-clean h2, .export-clean h3 { color:#000 !important; }
.export-clean .title-emoji, .export-clean .inline-emoji { display:none!important; }
.export-clean #uploadCard, .export-clean #exportToolbar, .export-clean .chart-filterbar, .export-clean #cmpCard { display:none!important; }


/* Scoped panel for All Cats Trend */
.chart-filterbar.allcats{ position:relative; z-index:3; display:flex; justify-content:flex-end; }
.chart-filterbar.allcats details{ position:relative; }
.chart-filterbar.allcats .panel{
  display:none; position:absolute; right:0; top:110%;
  background:#fff; border:1px solid #e5e7eb; border-radius:10px;
  box-shadow:0 12px 28px rgba(0,0,0,.12);
  padding:10px; min-width:280px; max-width:380px;
  max-height:320px; overflow:auto; z-index:50;
}
.chart-filterbar.allcats details[open] .panel{ display:block; }
@media (max-width:720px){
  .chart-filterbar.allcats .panel{ position:fixed; left:12px; right:12px; bottom:12px; top:auto; max-height:60vh; }
}

</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.4.0/docx.umd.js"></script>
<style id="jle-exec-kpi">

/* === JLE custom: Executive Analysis & Print Fixes v1 === */
:root{
  --card-bg: #0b0f19;
  --card-bd: #1f2937;
  --muted: #9ca3af;
}
/* Executive section layout */
#execWrap{
  margin-top: 12px;
}
#execWrap .exec-grid{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
}
#execWrap .exec-card{
  background: var(--card-bg);
  border: 1px solid var(--card-bd);
  border-radius: 14px;
  padding: 12px 14px;
}
#execWrap .exec-card h3{
  margin: 0 0 8px 0;
  font-size: 15px;
  line-height: 1.2;
}
#execWrap .exec-card ul{
  margin: 0;
  padding-left: 18px;
}
#execWrap .exec-card li{ 
  margin: 4px 0; 
  line-height: 1.35;
}
#execText{
  white-space: pre-wrap;
  font-size: 12px;
  line-height: 1.35;
  color: var(--muted);
}

/* If the page already renders bullets inside #execBullets, make them pretty */
#execBullets{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
}
#execBullets > strong{
  display: block;
  grid-column: span 2;
  margin-top: 4px;
}
#execBullets > ul, #execBullets > div{
  background: var(--card-bg);
  border: 1px solid var(--card-bd);
  border-radius: 14px;
  padding: 10px 12px;
}

/* KPI table/grid safety for print */
table, .table, .kpi-grid, .kpi, .kpi-cards{
  width: 100%;
}
.kpi-grid, .kpi, .kpi-cards, .kpi-table, .kpi-table thead, .kpi-table tbody, .kpi-table tr, .kpi-table td, .kpi-table th{
  break-inside: avoid;
  page-break-inside: avoid;
}
/* Prevent charts and cards from splitting in PDF */
canvas, .card, .panel, .chart, .exec-card, #execWrap, #charts, #charts3, #kpi, [id*="kpi"], [class*="kpi"]{
  break-inside: avoid;
  page-break-inside: avoid;
}

/* Print tweaks */
@page{
  size: A4;
  margin: 12mm;
}
@media print{
  body.export-clean{
    background: #fff !important;
  }
  /* Hide uploader/toolbar if present */
  #uploadCard, #uploadZone, .toolbar, .topbar, header, .print-hide{
    display: none !important;
  }
  /* Single column for exec on print */
  #execBullets, #execWrap .exec-grid{
    grid-template-columns: 1fr !important;
  }
  /* Reduce font a bit to keep tables on page */
  table, .kpi-table{ font-size: 11px !important; }
  #execText{ font-size: 11px !important; }
  /* Make tables wrap instead of overflow */
  table{ table-layout: auto !important; }
  td, th{ word-break: break-word; overflow-wrap: anywhere; }
  /* Avoid giant canvases */
  canvas{ max-width: 100% !important; height: auto !important; }
}

/* Optional subtle separators between sections */
.section-sep{ height: 1px; background: #1f2937; margin: 8px 0; }

</style>
<style id="jle-print-orientation">

/* === JLE print orientation override: Landscape A4 + fit tweaks === */
@page{
  size: A4 landscape;
  margin: 10mm;
}
@media print{
  /* Slightly tighter fonts to fit more on landscape */
  body{ font-size: 12px !important; }
  table, .kpi-table{ font-size: 11px !important; }
  /* Ensure two columns for main content if your layout supports it; 
     keep executive in single column to avoid split */
  #execBullets, #execWrap .exec-grid{ grid-template-columns: 1fr !important; }
  /* Avoid splitting charts/cards */
  canvas, .card, .panel, .chart, .exec-card, .kpi-grid, .kpi-table, .kpi, [id*="kpi"], [class*="kpi"]{
    break-inside: avoid !important;
    page-break-inside: avoid !important;
  }
  /* Make canvases/images responsive in print */
  canvas, img{ max-width: 100% !important; height: auto !important; }
  /* Let tables use full width and wrap text */
  table{ width: 100% !important; table-layout: auto !important; }
  td, th{ word-break: break-word; overflow-wrap: anywhere; }
}

</style>
<style id="jle-kpi7-print">

/* === JLE: KPI table print size 7pt === */
@media print{
  .kpi-table{
    font-size: 7pt !important;
    line-height: 1.15 !important;
  }
  .kpi-table th, .kpi-table td{
    padding: 2px 6px !important;
  }
}

</style>
<style id="jle-kpi55-print">

/* === JLE: KPI table print size 5.5pt === */
@media print{
  .kpi-table{
    font-size: 5.5pt !important;
    line-height: 1.1 !important;
  }
  .kpi-table th, .kpi-table td{
    padding: 1px 4px !important;
  }
}

</style>
<style id="jle-kpi4-print">

/* === JLE: KPI table print size 4pt === */
@media print{
  .kpi-table{
    font-size: 4pt !important;
    line-height: 1.05 !important;
  }
  .kpi-table th, .kpi-table td{
    padding: 0.5px 2px !important;
  }
}

</style>

<style id="jle-branding">
  .brand-bar{display:flex;align-items:center;gap:.75rem;padding:.6rem 1rem;border-bottom:1px solid #1f2937;background:#0b0f19;position:sticky;top:0;z-index:50}
  .brand-title{font-family:system-ui,Segoe UI,Arial;font-size:16px;color:#e5e7eb;font-weight:600}
  @media print{ .brand-bar{display:none !important;} }
</style>

</head>
<body>
<div class="brand-bar"><img src="logo_cbdio.jpeg" alt="CBDIO"><div class="brand-title">CBDIO ‚Ä¢ Dashboard de Gastos</div></div>

<script id="embeddedData" type="application/json"></script>

<body>
  <div class="container">
    <div class="headerTitle">
      <h1>Centro Binacional para el Desarrollo Ind√≠gena Oaxaque√±o</h1>
      <h2>An√°lisis Financiero (JLE)</h2>
      
  
</div>
    
<div id="exportToolbar" class="row" style="gap:8px; flex-wrap:wrap; margin:8px 0 0 auto">
  <button id="btnFreezeHTML" class="btn" type="button">üìÑ Congelar y descargar (HTML)</button>
  <button id="btnExportPDF" class="btn secondary" type="button">üñ® Exportar PDF</button>
  <button id="btnExportPPTX" class="btn secondary" type="button">üìä Generar PPTX</button> <button id="btnOpenSnapshot" class="btn">üìÑ Abrir copia HTML</button>
</div>


    <div class="card" id="uploadCard">
      <h2>1) üì§ Sube tu Excel (Project Profitability)</h2>
      <p class="muted">Exportado de QBO con columnas por mes y <span class="kbd">Total</span>. Este dashboard analiza <strong>solo GASTOS</strong>.</p>
      <div class="upload-zone" id="uploadZone">
        <button id="btnEmbedSnapshot" class="btn secondary" type="button" style="margin:8px 6px">üì¶ Guardar snapshot (incrustar datos)</button>
        <h3>Arrastra el archivo aqu√≠ o haz clic para elegir .xlsx</h3>
      </div>
      <input type="file" id="fileInput" accept=".xlsx,.xls"/>
      <div class="status info" id="status">Listo para procesar archivos</div>
    </div>

    <div class="card hidden" id="headerCard">
      <h2 id="projectTitle">Proyecto</h2>
      <p class="muted small" id="meta"></p>
      <div class="summary">
        <div class="tile"><div>GASTOS TOTALES</div><div class="v" id="v_gas">$0</div></div>
        <div class="tile"><div>MES CON MENORES GASTOS</div><div class="v" id="v_best">$0</div></div>
        <div class="tile"><div>MES CON MAYORES GASTOS</div><div class="v" id="v_worst">$0</div></div>
      </div>
    </div>

    <div class="grid hidden" id="charts1">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">üìà Tendencia mensual de GASTOS</h3>
          <div class="btn-row">
            <button id="exportPPT" class="btn secondary">PPT</button>
            <button id="exportPDF" class="btn secondary">PDF</button>
          </div>
        </div>
        <div class="chart-container"><canvas id="lineExpenses"></canvas></div>
      </div>
      <div class="card">
        <h3>üß± Gasto por mes (apilado por categor√≠a ‚Äì Top 8)</h3>
        <div class="chart-filterbar"><details><summary class="btn secondary">Filtrar categor√≠as</summary><div class="panel" id="stackPanel"><div id="stackChecks"></div><div class="row-actions"><button id="stackTop8" class="btn small secondary" type="button">Top 8</button><button id="stackClear" class="btn small secondary" type="button">Limpiar</button><button id="stackApply" class="btn small" type="button">Aplicar</button></div></div></details></div><div class="chart-container"><canvas id="stackedExpenses"></canvas></div>
      </div>
    </div>

    <div class="grid hidden" id="charts2">
      <div class="card">
        <h3>üè∑Ô∏è Top categor√≠as de GASTO (tendencia)</h3>
        <div class="chart-container"><canvas id="topCatTrends"></canvas></div>
      </div>
      <div class="card">
        <h3>üç© Distribuci√≥n de GASTOS por categor√≠a</h3>
        <div class="chart-filterbar"><details><summary class="btn secondary">Filtrar categor√≠as</summary><div class="panel" id="donutPanel"><div id="donutChecks"></div><div class="row-actions"><button id="donutTop5" class="btn small secondary" type="button">Top 5</button><button id="donutClear" class="btn small secondary" type="button">Limpiar</button><button id="donutApply" class="btn small" type="button">Aplicar</button></div></div></details></div><div class="chart-container"><canvas id="donutExpenses"></canvas></div>
      </div>
    </div>

    <div class="card hidden" id="kpiWrap">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">üìä Resumen KPI por categor√≠a</h3>
        <div class="btn-row">
          <button id="exportKPICSV" class="btn secondary">CSV</button>
          <button id="exportKPIXLSX" class="btn secondary">Excel</button>
          <button id="exportKPIPDF" class="btn secondary">PDF</button>
        </div>
      </div>
      <table id="kpiTable">
        <thead>
          <tr><th>Categor√≠a</th><th class="amount">Total gastado</th><th class="amount">Promedio mensual</th><th>Tendencia</th><th>Sem√°foro</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="note small">La tendencia se calcula con <strong>regresi√≥n lineal</strong> sobre la serie mensual (pendiente en USD/mes). Las cuentas sin mapeo se muestran tal cual vienen del reporte (QBO).</p>
    </div>

    <div class="card hidden" id="tableWrap">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">üìã Detalle por categor√≠a (mensual)</h3>
        <div class="row"><button class="btn secondary" id="exportDetailCSV">Exportar CSV</button></div>
      </div>
      <table id="detailTable">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    
  

<div class="grid hidden" id="charts3">
  <div class="card">
    <h3>üìä Participaci√≥n del Top 5 en el gasto total</h3>
    <div class="chart-container"><canvas id="top5Share"></canvas></div>
  </div>

<div class="card" id="allCatsTrendCard">
  <h3>üìâ Tendencia de GASTOS por categor√≠a (todas)</h3>
  <div class="muted small">Vista panor√°mica: una l√≠nea por categor√≠a. √ötil para detectar outliers y estacionalidad.</div>
  
<div class="chart-filterbar allcats" style="margin-top:-6px">
  <details><summary class="btn secondary">Filtrar categor√≠as</summary>
    <div class="panel" id="allCatsPanel">
      <input id="allCatsSearch" type="text" placeholder="Buscar categor√≠a..." style="width:100%;padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px"/>
      <div id="allCatsChecks"></div>
      <div class="row-actions" style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
        <button id="allCatsTop5" class="btn small secondary" type="button">Top 5</button>
        <button id="allCatsTop10" class="btn small secondary" type="button">Top 10</button>
        <button id="allCatsAll" class="btn small secondary" type="button">Todas</button>
        <button id="allCatsNone" class="btn small secondary" type="button">Ninguna</button>
        <button id="allCatsApply" class="btn small" type="button">Aplicar</button>
      </div>
    </div>
  </details>
</div>

    <div class="chart-container"><canvas id="allCatsTrend"></canvas></div>
</div>

  <div class="card">
    <h3>üîÅ Cambios del √∫ltimo mes (MoM) ‚Äì Top 3 ‚Üë / Top 3 ‚Üì</h3>
    <div class="chart-container"><canvas id="momTop3"></canvas></div>
  </div>
</div>

    <div class="card hidden" id="execWrap">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h3 style="margin:0">üß† Reporte Ejecutivo ‚Äì An√°lisis Financiero (Gastos)</h3>
    <div class="btn-row">
      <button id="copyExec" class="btn secondary">Copiar texto</button>
    </div>
  </div>
  <div id="execText" style="white-space:pre-wrap;line-height:1.4"></div>
      <div id="execBullets"></div>
</div>
</div>

<script>
// Remove emojis/pictographs for clean exports
function stripEmojis(s){
  if (!s) return '';
  try{
    return String(s).replace(/[\u{1F300}-\u{1FAFF}\u{1F1E6}-\u{1F1FF}\u{2600}-\u{27BF}]/gu, '');
  }catch(e){
    // Fallback without unicode flag
    return String(s).replace(/[\u2600-\u27BF]/g,'').replace(/[\uD83C-\uDBFF][\uDC00-\uDFFF]/g,'');
  }
}


// ====== institutional palette per category ======
const CATEGORY_COLORS = {
  "Personnel ‚Äì Salaries": "#2563eb",
  "Personnel ‚Äì Fringe Benefits": "#16a34a",
  "Office rent": "#7c3aed",
  "Office Expenses": "#64748b",
  "Internet & Communication": "#06b6d4",
  "Utilities & Maintenance": "#eab308",
  "Mileage/Travel": "#f97316",
  "Printing Copying": "#ec4899",
  "Consultant ‚Äì Program": "#dc2626",
  "Consultant ‚Äì Services": "#b91c1c",
  "Equipment": "#84cc16",
  "Meals & Snacks": "#0ea5e9",
  "Program Supplies": "#60a5fa",
  "Program Event/Workshop Expenses": "#a78bfa",
  "Travel/Lodging/Meals": "#fb7185"
};
const FALLBACK_COLORS = ['#3b82f6','#22c55e','#ef4444','#f59e0b','#8b5cf6','#14b8a6','#f97316','#10b981','#6366f1','#e11d48','#fbbf24','#06b6d4','#a855f7','#84cc16','#0ea5e9'];
const assigned = {};
function colorFor(name){
  if (CATEGORY_COLORS[name]) return CATEGORY_COLORS[name];
  if (assigned[name]) return assigned[name];
  // fallback cycle
  const idx = Object.keys(assigned).length % FALLBACK_COLORS.length;
  assigned[name] = FALLBACK_COLORS[idx];
  return assigned[name];
}
const lineColor = '#1f2937';

function fmtUSD(x){ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(x||0); }
function toNumber(val){
  if (typeof val === 'number' && isFinite(val)) return val;
  if (val == null) return 0;
  let s = String(val).trim();
  if (!s) return 0;
  const neg = /\(.*\)/.test(s) || /^-/.test(s);
  s = s.replace(/[^0-9.,-]/g,'').replace(/,/g,'').replace(/[()]/g,'');
  if (!s) return 0;
  const n = parseFloat(s);
  return isNaN(n) ? 0 : (neg ? -Math.abs(n) : n);
}
function norm(s){ return (s||'').toString().trim().replace(/\s+/g,' '); }
function lower(s){ return (s||'').toString().toLowerCase(); }

// Simple mapping heuristics; if no match, return original QBO name
function mapCategoryOrOriginal(raw){
  const nm = norm(raw);
  const simple = nm.replace(/^\d+[.\d\s-]*\s*/, '');
  const low = lower(simple);
  // heuristics
  if (low.includes('salary')||low.includes('wage')) return 'Personnel ‚Äì Salaries';
  if (low.includes('benefit')||low.includes('payroll')||low.includes('workers comp')) return 'Personnel ‚Äì Fringe Benefits';
  if (low.includes('internet')||low.includes('telephone')||low.includes('communication')||low.includes('web')) return 'Internet & Communication';
  if (low.includes('office')||low.includes('software')||low.includes('postage')||low.includes('mail')) return 'Office Expenses';
  if (low.includes('printing')||low.includes('copy')) return 'Printing Copying';
  if (low.includes('rent')) return 'Office rent';
  if (low.includes('utilit')||low.includes('janitorial')||low.includes('maint')||low.includes('repair')) return 'Utilities & Maintenance';
  if (low.includes('travel')||low.includes('mileage')||low.includes('transportation')) return 'Mileage/Travel';
  if (low.includes('lodging')||low.includes('hotel')) return 'Travel/Lodging/Meals';
  if (low.includes('meal')||low.includes('snack')) return 'Meals & Snacks';
  if (low.includes('program supplies')) return 'Program Supplies';
  if (low.includes('workshop')||low.includes('event')) return 'Program Event/Workshop Expenses';
  if (low.includes('stipend')||low.includes('scholar')) return 'Stipends / Scholarships';
  if (low.includes('consultant')) return 'Consultant ‚Äì Program';
  if (low.includes('contract service')) return 'Consultant ‚Äì Services';
  if (low.includes('training')) return 'Training / Capacity Building';
  if (low.includes('equipment')) return 'Equipment';
  // fallback to original QBO name
  return simple || nm;
}

// ====== upload wiring ======
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
uploadZone.addEventListener('click', ()=> fileInput.click());
uploadZone.addEventListener('dragover', e=>{ e.preventDefault(); uploadZone.classList.add('processing'); });
uploadZone.addEventListener('dragleave', ()=> uploadZone.classList.remove('processing'));
uploadZone.addEventListener('drop', e=>{ e.preventDefault(); uploadZone.classList.remove('processing'); if (e.dataTransfer.files?.length) processFile(e.dataTransfer.files[0]); });
fileInput.addEventListener('change', e=>{ if (e.target.files?.length) processFile(e.target.files[0]); });

function showStatus(msg, type='info'){ const e = document.getElementById('status'); e.textContent = msg; e.className = `status ${type}`; }

// ====== global state ======
let charts = {};
let STATE = { months: [], cats: [], projectTitle: '', diag: '', totalsPerMonth: [], kpiRows: [] };

function processFile(file){
  showStatus(`Procesando: ${file.name}`, 'info');
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const wb = XLSX.read(e.target.result, {type:'binary', cellDates:true, cellNF:true, cellText:false});
      const sheetName = wb.SheetNames[0];
      const sheet = wb.Sheets[sheetName];
      const raw = XLSX.utils.sheet_to_json(sheet, {header:1, raw:true, defval:""});
      analyze(raw, sheetName, file.name);
      showStatus('Archivo procesado correctamente ‚úÖ','success');
    }catch(err){
      console.error(err);
      showStatus('Error: '+err.message, 'error');
    }
  };
  reader.readAsBinaryString(file);
}

// ====== analysis (expenses only) ======
function analyze(raw, sheetName, fileName){
  const diag = [];
  // Detect header with month columns
  const monthRe1 = /^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[A-Za-z\s\-/]*\d{2,4}$/i;
  const monthRe2 = /^(January|February|March|April|May|June|July|August|September|October|November|December)(\s*\d{2,4})?$/i;
  let headerRow = -1; let monthCols = []; let totalIdx = -1;
  for (let i=0;i<Math.min(30, raw.length);i++){
    const row = raw[i] || [];
    const hits = [];
    for (let j=0;j<row.length;j++){
      const c = String(row[j]||'').trim();
      if (c.toLowerCase() === 'total') totalIdx = j;
      if (monthRe1.test(c) || monthRe2.test(c) || /^[A-Za-z]{3}\s*\d{2}$/.test(c)) hits.push([j,c]);
    }
    if (hits.length >= 2){
      headerRow = i;
      monthCols = hits.map(h=>h[0]);
      break;
    }
  }
  diag.push(`Archivo: ${fileName}`);
  diag.push(`Hoja: ${sheetName}`);
  diag.push(`Fila encabezado detectada: ${headerRow}`);
  diag.push(`√çndice columna Total: ${totalIdx}`);
  diag.push(`Columnas de meses: ${monthCols.join(', ')}`);

  if (headerRow < 0 || monthCols.length === 0){
    renderEmpty(diag.join('\n') + '\nNo se detectaron columnas de meses.');
    return;
  }

  const months = monthCols.map(c => String(raw[headerRow][c]||'').trim());
  const title = String(raw[1]?.[0] || 'Proyecto no identificado');
  document.getElementById('projectTitle').textContent = title;
  document.getElementById('meta').textContent = `Meses: ${months.join(' ¬∑ ')}`;

  // Parse rows: only expenditures
  let section = 'unknown';
  const rows = []; // {raw, name, monthly}
  for (let r=headerRow+1; r<raw.length; r++){
    const row = raw[r] || [];
    const labelRaw = row[0];
    const label = (labelRaw==null?'' : String(labelRaw)).replace(/\u00A0/g,' ').trim();
    if (!label) continue;

    const low = label.toLowerCase();
    if (low === 'revenue') { section = 'income'; continue; }
    if (low === 'other revenue') { section = 'other'; continue; }
    if (low === 'expenditures' || low === 'expenses'){ section = 'expense'; continue; }
    if (low.startsWith('gross profit')) continue;
    if (low.startsWith('total ')) continue;
    if (['total revenue','total expenditures','net operating revenue','net revenue'].includes(low)) continue;

    const vals = monthCols.map(c => toNumber(row[c]));
    if (vals.every(v => Math.abs(v) < 1e-9)) continue;

    if (section !== 'expense') continue; // keep only expenses

    const mapped = mapCategoryOrOriginal(label);
    rows.push({raw:label, name:mapped, monthly:vals});
  }

  // Aggregate by mapped category (name may be CBDIO or original QBO)
  const catIndex = new Map(); const cats = [];
  rows.forEach(r => {
    const key = r.name;
    if (!catIndex.has(key)){
      catIndex.set(key, cats.length);
      cats.push({name:r.name, monthly: Array(months.length).fill(0), total:0});
    }
    const idx = catIndex.get(key);
    for (let i=0;i<months.length;i++){
      cats[idx].monthly[i] += (r.monthly[i]||0);
      cats[idx].total += (r.monthly[i]||0);
    }
  });

  // Totals per month (expenses only)
  const mExpense = Array(months.length).fill(0);
  cats.forEach(c => c.monthly.forEach((v,i)=> mExpense[i]+=v));
  const tExpense = mExpense.reduce((a,b)=>a+b,0);

  // KPIs
  const maxIdx = mExpense.indexOf(Math.max(...mExpense));
  const minIdx = mExpense.indexOf(Math.min(...mExpense));
  document.getElementById('v_gas').textContent = fmtUSD(tExpense);
  document.getElementById('v_best').textContent = `${months[minIdx]} ¬∑ ${fmtUSD(mExpense[minIdx])}`;
  document.getElementById('v_worst').textContent = `${months[maxIdx]} ¬∑ ${fmtUSD(mExpense[maxIdx])}`;


  // Remove months with zero total expenses
  try {
    const keepIdx = [];
    for (let i=0;i<mExpense.length;i++){ if (Math.abs(mExpense[i]) > 1e-9) keepIdx.push(i); }
    if (keepIdx.length && keepIdx.length < months.length){
      months = keepIdx.map(i => months[i]);
      // filter cats series and recompute totals
      cats.forEach(c => {
        c.monthly = keepIdx.map(i => c.monthly[i]||0);
        c.total = c.monthly.reduce((s,v)=> s+(v||0), 0);
      });
      // recompute mExpense
      const m2 = Array(keepIdx.length).fill(0);
      cats.forEach(c => c.monthly.forEach((v,i)=> m2[i] += (v||0)));
      mExpense = m2;
    }
  } catch(e) { console.warn('zero-month filter failed', e); }
  // store state
  STATE.months = months;
  STATE.cats = cats;
  STATE.projectTitle = title;
  STATE.totalsPerMonth = mExpense;

  // Render charts, tables, kpis
  renderCharts(months, mExpense, cats);
  renderTable(months, cats);
  renderKPI(months, cats);
  generateExecutiveAnalysis();
  renderManagerTables();
  populateAllCatsFilter();
    if (typeof renderExtraCharts==='function') renderExtraCharts();
  populateChartFiltersScoped();
  
// Auto-apply when any checkbox changes
['donutChecks','stackChecks'].forEach((cid)=>{
  const box = document.getElementById(cid);
  if (box && !box.__changeWired){
    box.__changeWired = true;
    box.addEventListener('change', ()=>{
      try{ renderCharts(STATE.months||[], STATE.cats||[]); }catch(e){}
    });
  }
});

// Defaults: Donut Top 5, Stacked Top 8 on first populate
if (!window.__chartFiltersInitialized){
  window.__chartFiltersInitialized = true;
  const selTop = (wrapId, n)=>{
    const box = document.getElementById(wrapId);
    if (!box) return;
    const inputs = Array.from(box.querySelectorAll('input[type="checkbox"]'));
    inputs.forEach((cb,i)=> cb.checked = (i < n));
  };
  selTop('donutChecks',5);
  selTop('stackChecks',8);
  try{ renderCharts(STATE.months||[], STATE.cats||[]); }catch(e){}
}

  buildComparatorUI();
  renderComparator();
  buildCategoryFilterUI();
  renderExtraCharts();
  generateExecutiveAnalysis();
  renderManagerTables();
  populateAllCatsFilter();
    if (typeof renderExtraCharts==='function') renderExtraCharts();
  populateChartFiltersScoped();
  
// Auto-apply when any checkbox changes
['donutChecks','stackChecks'].forEach((cid)=>{
  const box = document.getElementById(cid);
  if (box && !box.__changeWired){
    box.__changeWired = true;
    box.addEventListener('change', ()=>{
      try{ renderCharts(STATE.months||[], STATE.cats||[]); }catch(e){}
    });
  }
});

// Defaults: Donut Top 5, Stacked Top 8 on first populate
if (!window.__chartFiltersInitialized){
  window.__chartFiltersInitialized = true;
  const selTop = (wrapId, n)=>{
    const box = document.getElementById(wrapId);
    if (!box) return;
    const inputs = Array.from(box.querySelectorAll('input[type="checkbox"]'));
    inputs.forEach((cb,i)=> cb.checked = (i < n));
  };
  selTop('donutChecks',5);
  selTop('stackChecks',8);
  try{ renderCharts(STATE.months||[], STATE.cats||[]); }catch(e){}
}

  buildComparatorUI();
  renderComparator();
  buildCategoryFilterUI();
  renderExtraCharts();
  renderDiag(diag, rows, cats);

  // wire export buttons
  wireExports();
}

function renderEmpty(diagText){
  document.getElementById('headerCard').classList.remove('hidden');
  document.getElementById('charts1').classList.add('hidden');
  document.getElementById('charts2').classList.add('hidden');
  document.getElementById('tableWrap').classList.add('hidden');
  document.getElementById('kpiWrap').classList.add('hidden');
  document.getElementById('diagWrap').classList.remove('hidden');
  document.getElementById('diagBox').textContent = diagText;
}

function renderCharts(months, mExpense, cats){
  // Flexible signature: (months, cats) or (months, mExpense, cats)
  if (cats === undefined && Array.isArray(mExpense)) { cats = mExpense; mExpense = null; }
  if (!mExpense && cats && cats.length){
    // compute mExpense from cats
    const n = (cats[0].monthly||[]).length;
    mExpense = Array(n).fill(0);
    cats.forEach(c => { for(let i=0;i<n;i++){ mExpense[i] += (c.monthly[i]||0); } });
  }
  document.getElementById('headerCard').classList.remove('hidden');
  document.getElementById('charts1').classList.remove('hidden');
  document.getElementById('charts2').classList.remove('hidden');

  // Line: expenses per month
  const lctx = document.getElementById('lineExpenses').getContext('2d');
  if (charts.line) charts.line.destroy();
  charts.line = new Chart(lctx, {
    type:'line',
    data:{ labels: months, datasets:[{ label:'Gastos', data: mExpense, tension:.3, fill:false, borderColor: lineColor, pointBackgroundColor: lineColor }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'bottom'} }, scales:{ y:{ beginAtZero:true } } }
  });

  // Stacked bar: top 8 categories with stable colors
  const expCats = cats.map(c=> ({...c})).sort((a,b)=> b.total - a.total);
const chosenS = new Set(getChecked('stackChecks'));
const top = (chosenS.size ? expCats.filter(c=> chosenS.has(c.name)) : expCats.slice(0,8));
const others = (chosenS.size ? [] : expCats.slice(8));
  const othersPerMonth = Array(months.length).fill(0);
  others.forEach(c=> c.monthly.forEach((v,i)=> othersPerMonth[i]+=v));
  const datasets = top.map(c=> ({ label:c.name, data:c.monthly, backgroundColor: colorFor(c.name) }));
  if (others.some(c=>c.total>0)) datasets.push({ label:'Otros', data:othersPerMonth, backgroundColor:'#9ca3af' });
  const sctx = document.getElementById('stackedExpenses').getContext('2d');
  if (charts.stacked) charts.stacked.destroy();
  charts.stacked = new Chart(sctx, {
    type:'bar',
    data:{ labels: months, datasets },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'bottom'} }, scales:{ x:{stacked:true}, y:{stacked:true, beginAtZero:true} } }
  });

  // Multi-line top cat trends with stable colors
  const tctx = document.getElementById('topCatTrends').getContext('2d');
  if (charts.toptr) charts.toptr.destroy();
  charts.toptr = new Chart(tctx, {
    type:'line',
    data:{ labels: months, datasets: top.map(c=> ({ label:c.name, data:c.monthly, tension:.3, fill:false, borderColor: colorFor(c.name), pointBackgroundColor: colorFor(c.name) })) },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'bottom'} }, scales:{ y:{ beginAtZero:true } } }
  });

  // Donut expenses distribution with stable colors
const chosenD = new Set(getChecked('donutChecks'));
const dCats = (chosenD.size ? expCats.filter(c=> chosenD.has(c.name)) : expCats);
const dctx = document.getElementById('donutExpenses').getContext('2d');
if (charts.donutExpenses) { try{ charts.donutExpenses.destroy(); }catch(e){} }
charts.donutExpenses = new Chart(dctx, {
  type:'doughnut',
  data:{ labels: dCats.map(c=>c.name), datasets:[{ data: dCats.map(c=>c.total), backgroundColor: dCats.map(c=> colorFor(c.name)) }] },
  options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
});


// === All categories trend (multi-line) ===
try{
  const actx = document.getElementById('allCatsTrend')?.getContext('2d');
  if (actx){
    const datasetsAll = cats.map(c => ({
      label: c.name,
      data: c.monthly,
      borderColor: colorFor(c.name),
      backgroundColor: colorFor(c.name) + '22',
      fill: false,
      borderWidth: 1,
      tension: 0.2
    }));
    if (!window.charts) window.charts = {};
    if (charts.allCatsTrend){ try{ charts.allCatsTrend.destroy(); }catch(e){} }
    charts.allCatsTrend = new Chart(actx, {
      type: 'line',
      data: { labels: months, datasets: datasetsAll },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }
}catch(e){ console.warn('allCatsTrend render failed', e); }

}

function renderTable(months, cats){
  document.getElementById('tableWrap').classList.remove('hidden');
  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');
  thead.innerHTML = ''; tbody.innerHTML = '';
  const th = document.createElement('tr');
  th.innerHTML = `<th>Categor√≠a</th>${months.map(m=>`<th class="amount">${m}</th>`).join('')}<th class="amount">Total</th>`;
  thead.appendChild(th);

  const rows = cats.map(c => ({...c})).sort((a,b)=> b.total - a.total);
  rows.forEach((c,idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${c.name}</td>` +
      c.monthly.map(v=> `<td class="amount">${fmtUSD(v)}</td>`).join('') +
      `<td class="amount">${fmtUSD(c.total)}</td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('exportDetailCSV').onclick = () => {
    const header = ['Categoria', ...months, 'Total'];
    const lines = [header.join(',')];
    rows.forEach(c => {
      const line = [c.name, ...c.monthly.map(v=>v.toFixed(2)), c.total.toFixed(2)];
      lines.push(line.map(x => `"${String(x).replace(/"/g,'""')}"`).join(','));
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'cbdio_project_expenses_detail.csv';
    a.click();
  };
}

// Linear regression slope for y over x=1..n
function slopePerMonth(arr){
  const n = arr.length;
  const sumX = n*(n+1)/2;
  const sumY = arr.reduce((a,b)=>a+b,0);
  const sumXY = arr.reduce((acc, y, i)=> acc + (i+1)*y, 0);
  const sumXX = n*(n+1)*(2*n+1)/6;
  const num = n*sumXY - sumX*sumY;
  const den = n*sumXX - sumX*sumX;
  if (den === 0) return 0;
  return num/den; // USD per month
}

function renderKPI(months, cats){
  document.getElementById('kpiWrap').classList.remove('hidden');
  const tbody = document.querySelector('#kpiTable tbody');
  tbody.innerHTML = '';

  const n = months.length;
  const rows = cats.map(c => {
    const total = c.total;
    const avg = total / n;
    const s = slopePerMonth(c.monthly);
    const thr = Math.max(1, 0.05 * (avg || 1)); // 5% del promedio (m√≠n 1 USD/mes)
    let tag = '‚û°Ô∏è Estable';
    if (s > thr) tag = 'üìà Al alza';
    else if (s < -thr) tag = 'üìâ A la baja';
    const tagText = tag.replace(/^\W+/, '');
    return {name:c.name, total, avg, slope:s, tag, tagText};
  }).sort((a,b)=> b.total - a.total);

  rows.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    const slopeAbs = Math.abs(r.slope);
    const slopeTxt = (r.slope>=0?'+':'-') + fmtUSD(slopeAbs).replace('$','') + ' USD/mes';
    // Sem√°foro: rojo si ‚Üë (s > thr), verde si ‚Üì (s < -thr), amarillo si |s| ‚â§ thr
    const thr = Math.max(1, 0.05 * (r.avg || 1));
    const status = r.slope > thr ? {c:'r', t:'‚Üë en aumento'} : (r.slope < -thr ? {c:'g', t:'‚Üì en descenso'} : {c:'y', t:'‚Üí estable'});
    tr.innerHTML = `<td>${r.name}</td>
      <td class="amount">${fmtUSD(r.total)}</td>
      <td class="amount">${fmtUSD(r.avg)}</td>
      <td>${r.tag} ¬∑ ${slopeTxt}</td>
      <td><span class="sem"><span class="dot ${status.c}"></span>${status.t}</span></td>`;
    tbody.appendChild(tr);
  });

  // store for export
  STATE.kpiRows = rows;
}

// ====== Exports: KPI CSV/XLSX/PDF + PPT (charts + highlights) ======
function wireExports(){
  const ensure = (id)=>{ const el=document.getElementById(id); if(!el){ console.warn('Missing button', id); return null;} return el; };

  const bCSV = ensure('exportKPICSV');
  const bXLSX = ensure('exportKPIXLSX');
  const bPDF = ensure('exportKPIPDF');
  const bRptPDF = ensure('exportPDF');
  const bPPT = ensure('exportPPT');

  if (bCSV) bCSV.onclick = () => {
    const header = ['Categoria','Total','Promedio mensual','Tendencia','Pendiente (USD/mes)','Semaforo']; // emoji-free
    const lines = [header.join(',')];
    (STATE.kpiRows||[]).forEach(r => {
      const thr = Math.max(1, 0.05 * (r.avg || 1));
      const sem = r.slope > thr ? 'Rojo (alza)' : (r.slope < -thr ? 'Verde (baja)' : 'Amarillo (estable)');
      lines.push([r.name, r.total.toFixed(2), r.avg.toFixed(2), r.tagText, r.slope.toFixed(2), sem].map(x=>`"${String(x).replace(/"/g,'""')}"`).join(','));
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'cbdio_expenses_kpi.csv';
    a.click();
  };

  if (bXLSX) bXLSX.onclick = () => {
    const ws_data = [['Categoria','Total','Promedio mensual','Tendencia','Pendiente (USD/mes)','Semaforo']];
    (STATE.kpiRows||[]).forEach(r => {
      const thr = Math.max(1, 0.05 * (r.avg || 1));
      const sem = r.slope > thr ? 'Rojo (alza)' : (r.slope < -thr ? 'Verde (baja)' : 'Amarillo (estable)');
      ws_data.push([r.name, r.total, r.avg, r.tagText, r.slope, sem]);
    });
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'KPIs');
    XLSX.writeFile(wb, 'cbdio_expenses_kpi.xlsx');
  };

  if (bPDF) bPDF.onclick = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'landscape', unit:'pt', format:'a4' });
    const margin = 40;
    doc.setFont('helvetica','bold'); doc.setFontSize(16);
    doc.text(`CBDIO ‚Äì KPIs de Gastos ¬∑ ${STATE.projectTitle}`, margin, margin);
    doc.setFont('helvetica','normal'); doc.setFontSize(10);

    let y = margin+20;
    const cols = ['Categor√≠a','Total','Promedio mensual','Tendencia','Pendiente (USD/mes)'];
    const colW = [260,140,160,160,160]; // PDF sin sem√°foro
    doc.setFillColor(230,236,245); doc.rect(margin, y, colW.reduce((a,b)=>a+b,0), 20, 'F');
    cols.forEach((c,i)=> doc.text(c, margin + (i?colW.slice(0,i).reduce((a,b)=>a+b,0):0) + 6, y+14));
    y += 24;
    (STATE.kpiRows||[]).slice(0,18).forEach(r => {
      const row = [r.name, fmtUSD(r.total), fmtUSD(r.avg), r.tagText, (r.slope>=0?'+':'')+r.slope.toFixed(2)];
      row.forEach((cell,i)=> doc.text(String(cell), margin + (i?colW.slice(0,i).reduce((a,b)=>a+b,0):0) + 6, y+14));
      doc.rect(margin, y, colW.reduce((a,b)=>a+b,0), 22);
      y += 22;
    });
    doc.save('cbdio_expenses_kpi.pdf');
  };

  if (bRptPDF) bRptPDF.onclick = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'landscape', unit:'pt', format:'a4' });
    const margin = 36;
    doc.setFont('helvetica','bold'); doc.setFontSize(18);
    doc.text(`CBDIO ‚Äì Gastos Mensuales ¬∑ ${STATE.projectTitle}`, margin, margin);
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    const c1 = document.getElementById('lineExpenses');
    if (c1){ const img1 = c1.toDataURL('image/png', 1.0); doc.addImage(img1, 'PNG', margin, margin+10, 780, 300); doc.text('Gr√°fico: Tendencia mensual de gastos', margin, margin+320); }
    doc.save('cbdio_expenses_report.pdf');
  };

  if (bPPT) bPPT.onclick = async () => {
    const pptx = new PptxGenJS();
    pptx.layout = 'LAYOUT_16x9';

    let slide = pptx.addSlide();
    slide.addText('Centro Binacional para el Desarrollo Ind√≠gena Oaxaque√±o', { x:0.5, y:0.7, w:9, h:1, fontSize:20, bold:true });
    slide.addText(`An√°lisis Financiero (JLE) ‚Äì ${STATE.projectTitle}`, { x:0.5, y:1.3, w:9, h:0.6, fontSize:14 });

    const lineCanvas = document.getElementById('lineExpenses');
    if (lineCanvas){
      const lineImg = lineCanvas.toDataURL('image/png', 1.0);
      slide = pptx.addSlide();
      slide.addText('Tendencia mensual de gastos', { x:0.5, y:0.3, fontSize:18, bold:true });
      slide.addImage({ data: lineImg, x:0.5, y:0.8, w:9 });
    }

    const top5 = (STATE.kpiRows||[]).slice(0,5).map(r => `${r.name}: ${fmtUSD(r.total)} ¬∑ ${r.tagText} (${(r.slope>=0?'+':'')}${r.slope.toFixed(2)} USD/mes)`);
    slide = pptx.addSlide();
    slide.addText('KPIs por categor√≠a (Top)', { x:0.5, y:0.3, fontSize:18, bold:true });
    slide.addText(top5.join('\n'), { x:0.6, y:0.9, fontSize:14 });

    await pptx.writeFile({ fileName: 'cbdio_expenses_report.pptx' });
  };
}

// ====== Diagn√≥stico ======
function renderDiag(diag, rows, cats){
  document.getElementById('diagWrap').classList.remove('hidden');
  const box = document.getElementById('diagBox');
  const nonZero = rows.length;
  const sample = rows.slice(0,12).map(r => `  ‚Ä¢ ${r.raw} ‚Üí ${r.name}`).join('\n');
  diag.push(`L√≠neas de gasto con montos ‚â† 0: ${nonZero}`);
  diag.push('Muestras (QBO ‚Üí Categor√≠a usada):');
  diag.push(sample);
  box.textContent = diag.join('\n');
}

// ====== Executive Analysis ======
function perc(x){ return (x*100).toFixed(1)+'%'; }
function safeDiv(a,b){ return b && b!=0 ? (a/b) : 0; } // Pythonic; fix to JS below

function generateExecutiveAnalysis(){
  const months = STATE.months || [];
  const cats = STATE.cats || [];
  if (!months.length || !cats.length){ document.getElementById('execWrap').classList.add('hidden'); return; }

  // Top categories
  const topCats = [...cats].sort((a,b)=> b.total - a.total).slice(0,5);

  // Overall trend & volatility
  const m = STATE.totalsPerMonth || [];
  const n = m.length;
  const total = m.reduce((a,b)=>a+b,0);
  const avg = total / (n||1);
  const slope = slopePerMonth(m);
  const last = m[n-1] || 0, first = m[0] || 0;
  const mom = n>1 ? (last - (m[n-2]||0)) : 0;
  const yoy = n>12 ? (last - (m[n-13]||0)) : null;

  // volatility (coeficiente de variaci√≥n)
  const varc = m.reduce((acc,v)=> acc + Math.pow(v-avg,2), 0) / (n || 1);

  const stdev = Math.sqrt(varc);
  const cv = avg ? stdev/avg : 0;

  // Category drivers (slopes)
  const catTrends = cats.map(c=>({ 
    name:c.name, 
    slope:slopePerMonth(c.monthly), 
    total:c.total, 
    last:c.monthly[c.monthly.length-1]||0,
    avg:c.total/(c.monthly.length||1)
  })).sort((a,b)=> Math.abs(b.slope) - Math.abs(a.slope));

  const upDrivers = catTrends.filter(x=>x.slope>0).slice(0,3);
  const downDrivers = catTrends.filter(x=>x.slope<0).slice(0,3);

  // Build narrative
  const lines = [];
  lines.push(`Proyecto: ${STATE.projectTitle}`);
  lines.push(`Periodo: ${months[0]} ‚Äì ${months[months.length-1]}`);
  lines.push('');
  lines.push('1) Resumen ejecutivo');
  const slopeTxt = (slope>=0?'+':'-') + Math.abs(slope).toFixed(2) + ' USD/mes';
  const momTxt = (mom>=0?'+':'-') + Math.abs(mom).toFixed(2);
  lines.push(`‚Ä¢ Gasto total: ${fmtUSD(total)} ¬∑ Promedio mensual: ${fmtUSD(avg)} ¬∑ Tendencia: ${slope>=0?'üìà al alza':'üìâ a la baja'} (${slopeTxt}). Volatilidad (CV): ${(cv*100).toFixed(1)}%.`);
  lines.push(`‚Ä¢ √öltimo mes vs anterior: ${mom>=0?'‚ñ≤':'‚ñº'} ${fmtUSD(Math.abs(mom))}${yoy!==null?` ¬∑ Œî vs hace 12 meses: ${yoy>=0?'‚ñ≤':'‚ñº'} ${fmtUSD(Math.abs(yoy))}`:''}.`);
  lines.push('');
  lines.push('2) Principales categor√≠as (Top 5 por gasto total)');
  topCats.forEach((c,i)=>{
    const s = slopePerMonth(c.monthly);
    lines.push(`   ${i+1}. ${c.name}: ${fmtUSD(c.total)} (${fmtUSD(c.total/(c.monthly.length||1))}/mes) ¬∑ Tendencia: ${s>=0?'üìà':'üìâ'} ${ (s>=0?'+':'-') + fmtUSD(Math.abs(s)).replace('$','') } USD/mes.`);
  });
  // Sem√°foro counts
  const semCounts = cats.reduce((acc,c)=>{ const avg = c.total/(c.monthly.length||1); const thr = Math.max(1, 0.05*(avg||1)); const s = slopePerMonth(c.monthly); if (s>thr) acc.rojo++; else if (s<-thr) acc.verde++; else acc.amarillo++; return acc; }, {rojo:0,amarillo:0,verde:0});
  lines.push(`‚Ä¢ Sem√°foro categor√≠as ‚Äì Rojo: ${semCounts.rojo} ¬∑ Amarillo: ${semCounts.amarillo} ¬∑ Verde: ${semCounts.verde}`);
  lines.push('');
  lines.push('3) Categor√≠as que m√°s mueven la tendencia');
  lines.push('   Al alza:');
  upDrivers.forEach(d=> lines.push(`   ‚Ä¢ ${d.name}: pendiente +${d.slope.toFixed(2)} USD/mes (prom: ${fmtUSD(d.avg)})`));
  const topRojos = catTrends.filter(x=> x.slope>0 && x.slope > Math.max(1, 0.05*(x.avg||1))).slice(0,5);
  if (topRojos.length){ lines.push('   (Top rojos a vigilar)'); topRojos.forEach(tr => lines.push(`     ‚ó¶ ${tr.name}: +${tr.slope.toFixed(2)} USD/mes`)); }
  lines.push('   A la baja:');
  downDrivers.forEach(d=> lines.push(`   ‚Ä¢ ${d.name}: pendiente ${d.slope.toFixed(2)} USD/mes (prom: ${fmtUSD(d.avg)})`));
  lines.push('');
  lines.push('4) Lectura y riesgos');
  if (cv>0.35){ lines.push('   ‚Ä¢ Alta variabilidad mensual: considerar calendarizar gastos o revisar estacionalidad/one-offs.'); }
  if (slope>0 && (upDrivers[0]?.slope||0) > (0.2*avg)){ lines.push('   ‚Ä¢ La tendencia ascendente est√° concentrada en pocas categor√≠as: riesgo de presi√≥n presupuestal focalizada.'); }
  if (topCats[0] && (topCats[0].total/total) > 0.35){ lines.push(`   ‚Ä¢ Concentraci√≥n en ${topCats[0].name}: >35% del total; monitorear dependencia y justificar variaciones.`); }
  lines.push('');
  lines.push('5) Recomendaciones de gesti√≥n');
  lines.push('   ‚Ä¢ Establecer topes mensuales por categor√≠a top y activar alertas (>10% sobre promedio).');
  lines.push('   ‚Ä¢ Revisar contratos/vales en categor√≠as con pendiente positiva elevada y negociar condiciones.');
  lines.push('   ‚Ä¢ Programar gastos estacionales para suavizar picos; usar compromisos (encumbrances) donde aplique.');
  lines.push('   ‚Ä¢ Preparar nota explicativa para el Board si el √∫ltimo mes muestra desviaciones >15% vs promedio.');

  const text = lines.join('\n');
  const box = document.getElementById('execText');
  box.textContent = text;
  document.getElementById('execWrap').classList.remove('hidden');

  // Export buttons
  const bPDF = document.getElementById('exportExecPDF');
  
if (bPDF){
  bPDF.onclick = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });
    const margin = 48, width = 540;
    const title = 'Reporte Ejecutivo ‚Äì Gastos';
    const project = STATE.projectTitle || '';
    const period = (STATE.months && STATE.months.length) ? (STATE.months[0] + ' ‚Äì ' + STATE.months[STATE.months.length-1]) : '';

    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text(title, margin, margin);
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    doc.text('Proyecto: ' + project, margin, margin+16);
    doc.text('Periodo: ' + period, margin, margin+30);

    let y = margin + 54;
    const addHeading = (txt)=>{ doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text(stripEmojis(txt), margin, y); y += 16; doc.setFont('helvetica','normal'); doc.setFontSize(10); };
    const addPara = (txt)=>{
      const lines = doc.splitTextToSize(stripEmojis(txt), width);
      lines.forEach(line => { if (y>780){ doc.addPage(); y = margin; } doc.text(line, margin, y); y += 14; });
    };
    const addList = (arr)=>{
      arr.forEach(item => {
        const lines = doc.splitTextToSize('‚Ä¢ ' + stripEmojis(item), width);
        lines.forEach((line, idx) => { if (y>780){ doc.addPage(); y = margin; } doc.text(line, margin, y); y += 14; });
      });
    };

    // Build sections from DOM bullets for clean structure
    const bulletsEl = document.getElementById('execBullets');
    if (bulletsEl){
      const groups = [];
      let current = null;
      bulletsEl.childNodes.forEach(node => {
        if (node.tagName === 'STRONG'){
          if (current) groups.push(current);
          current = { heading: node.textContent.trim(), items: [] };
        } else if (node.tagName === 'UL'){
          const lis = Array.from(node.querySelectorAll('li')).map(li => li.textContent.trim());
          if (!current) current = { heading: '', items: [] };
          current.items.push(...lis);
        } else if (node.tagName === 'DIV'){
          // plain line (e.g., sem√°foro counts)
          if (!current) current = { heading: '', items: [] };
          current.items.push(node.textContent.trim());
        }
      });
      if (current) groups.push(current);

      // Render each group
      groups.forEach(g => {
        if (g.heading){
          addHeading(g.heading);
        }
        if (g.items && g.items.length){
          addList(g.items);
          y += 6;
        }
      });
    } else {
      // Fallback: use text block
      addHeading('Resumen');
      addPara((document.getElementById('execText')?.textContent)||'');
    }

    doc.save('cbdio_exec_summary.pdf');
  };
}


  const bCopy = document.getElementById('copyExec');
  if (bCopy){
    bCopy.onclick = async () => {
      try{ await navigator.clipboard.writeText(text); alert('Reporte ejecutivo copiado al portapapeles.'); }
      catch(e){ alert('No se pudo copiar autom√°ticamente. Selecciona el texto y copia manualmente.'); }
    };
  }
}


// ====== Extra charts (Top5 share & MoM Top3) ======
function renderExtraCharts(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;

    // Build/refresh filter UI
    buildCategoryFilterUI();
    // Compute Top share according to selection
    const total = (STATE.totalsPerMonth||[]).reduce((a,b)=>a+b,0);
    const catsSorted = [...cats].sort((a,b)=> b.total - a.total);
    const sel = getTopShareSelection(total, catsSorted);
    const topNames = sel.selected.map(c=>c.name);
    const topVals = sel.selected.map(c=>c.total);
    const topShares = topVals.map(v => total? (v/total*100) : 0);
    const labelsShare = [...topNames, 'Otros'];
    const dataShare = [...topShares, total? (sel.others/total*100) : 0];
    const colorsShare = [...topNames.map(n=> colorFor(n)), '#9ca3af'];

    // Compute MoM deltas (last vs prev) per category
    const deltas = cats.map(c=> (c.monthly[c.monthly.length-1]||0) - (c.monthly[c.monthly.length-2]||0));
    const momArr = cats.map((c,i)=> ({ name:c.name, delta:deltas[i] }));
    const momUp = [...momArr].sort((a,b)=> b.delta - a.delta).slice(0,3);
    const momDown = [...momArr].sort((a,b)=> a.delta - b.delta).slice(0,3).reverse(); // make it descending absolute with negatives shown
    const momData = [...momUp, ...momDown.map(x=>({name:x.name, delta:x.delta}))]; // keep negatives

    // Show container
    const wrap = document.getElementById('charts3');
    if (wrap) wrap.classList.remove('hidden');

    // Render Top5 Share (bar horizontal)
    const shCtx = document.getElementById('top5Share').getContext('2d');
    if (charts.top5Share) charts.top5Share.destroy();
    charts.top5Share = new Chart(shCtx, {
      type: 'bar',
      data: { labels: labelsShare, datasets: [{ label: '% del total', data: dataShare, backgroundColor: colorsShare }] },
      options: {
        indexAxis: 'y',
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(ctx)=> ctx.parsed.x.toFixed(1) + '%' } } },
        scales:{ x:{ beginAtZero:true, ticks:{ callback:(v)=> v + '%' }, max:100 } }
      }
    });

    // Render MoM Top3 (barras, mezcla de positivos/negativos)
    const momCtx = document.getElementById('momTop3').getContext('2d');
    if (charts.momTop3) charts.momTop3.destroy();
    charts.momTop3 = new Chart(momCtx, {
      type: 'bar',
      data: { labels: momData.map(x=>x.name), datasets: [{ label: 'Œî √∫ltimo mes', data: momData.map(x=>x.delta), backgroundColor: momData.map(x=> x.delta>=0 ? '#10b981' : '#ef4444') }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(ctx)=> (ctx.parsed.y>=0?'+':'-') + Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(Math.abs(ctx.parsed.y)) } } },
        scales:{ y:{ beginAtZero:false } }
      }
    });

  }catch(e){ console.warn('renderExtraCharts failed', e); }
}


// ====== Category filter UI for Top Share ======
function buildCategoryFilterUI(){
  const modeSel = document.getElementById('topShareMode');
  const panel = document.getElementById('customCatPanel');
  const list = document.getElementById('customCatList');
  const btnAll = document.getElementById('btnAllCats');
  const btnNone = document.getElementById('btnNoneCats');
  const btnApply = document.getElementById('btnApplyCats');
  if (!modeSel || !panel || !list) return;

  // Populate checkbox list from STATE.cats, ordered by total desc
  const cats = [...(STATE.cats||[])].sort((a,b)=> b.total - a.total);
  // Restore previous mode/selection if available on first build
  if (!STATE.__restored){ restoreModeAndSelection(); STATE.__restored = true; }

  list.innerHTML = cats.map((c,i)=>{
    const checked = (STATE.customCats.length ? STATE.customCats.includes(c.name) : (i<5));
    return `<label style="display:inline-flex;align-items:center;gap:6px;margin:4px 10px 4px 0">
      <input type="checkbox" data-cat="${c.name.replace(/"/g,'&quot;')}" ${checked?'checked':''}/>
      <span>${c.name}</span>
    </label>`;
  }).join('');

  modeSel.value = STATE.shareMode || 'top5'; seedDefaultPresetsIfEmpty(); populatePresetSelect(); attachPresetHandlers(); attachSearchHandler();
  panel.classList.toggle('hidden', modeSel.value !== 'custom');

  modeSel.onchange = () => {
    STATE.shareMode = modeSel.value;
    panel.classList.toggle('hidden', STATE.shareMode !== 'custom');
    persistModeAndSelection();
    // If not custom, re-render directly
    if (STATE.shareMode !== 'custom'){
      renderExtraCharts();
    }
  };

  btnAll.onclick = () => {
    list.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = true);
  };
  btnNone.onclick = () => {
    list.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = false);
  };
  btnApply.onclick = () => {
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    STATE.customCats = chosen;
    persistModeAndSelection();
    renderExtraCharts();
  };
}

function getTopShareSelection(total, catsSorted){
  // catsSorted: [{name,total,monthly}...] sorted desc by total
  let selected = [];
  if (STATE.shareMode === 'top10'){
    selected = catsSorted.slice(0,10);
  } else if (STATE.shareMode === 'custom'){
    const set = new Set(STATE.customCats||[]);
    selected = catsSorted.filter(c => set.has(c.name));
    if (!selected.length){ selected = catsSorted.slice(0,5); } // fallback
  } else { // top5 default
    selected = catsSorted.slice(0,5);
  }
  const selTotal = selected.reduce((a,c)=> a + c.total, 0);
  const others = Math.max(0, total - selTotal);
  return { selected, others };
}


// ====== Presets & Search for category filter ======
const PRESET_KEY = 'cbdio_topshare_presets_v1';
const MODE_KEY = 'cbdio_topshare_mode';
const SEL_KEY = 'cbdio_topshare_customCats';

function loadPresets(){
  try{ return JSON.parse(localStorage.getItem(PRESET_KEY) || '{}'); }catch(e){ return {}; }
}
function savePresets(obj){
  try{ localStorage.setItem(PRESET_KEY, JSON.stringify(obj)); }catch(e){}
}
function persistModeAndSelection(){
  try{
    localStorage.setItem(MODE_KEY, STATE.shareMode || 'top5');
    localStorage.setItem(SEL_KEY, JSON.stringify(STATE.customCats || []));
  }catch(e){}
}
function restoreModeAndSelection(){
  try{
    const m = localStorage.getItem(MODE_KEY);
    const s = localStorage.getItem(SEL_KEY);
    if (m) STATE.shareMode = m;
    if (s) STATE.customCats = JSON.parse(s);
  }catch(e){}
}

function populatePresetSelect(){
  const sel = document.getElementById('presetSelect');
  if (!sel) return;
  const presets = loadPresets();
  const names = Object.keys(presets).sort();
  sel.innerHTML = '<option value="">(elige un preset)</option>' + names.map(n => `<option value="${n}">${n}</option>`).join('');
}

function attachPresetHandlers(){
  const btnLoad = document.getElementById('btnLoadPreset');
  const btnSave = document.getElementById('btnSavePreset');
  const btnDel  = document.getElementById('btnDeletePreset');
  const sel     = document.getElementById('presetSelect');
  const list    = document.getElementById('customCatList');

  if (btnLoad) btnLoad.onclick = () => {
    const name = sel && sel.value;
    if (!name) return;
    const presets = loadPresets();
    if (presets[name]){
      STATE.customCats = presets[name];
      // Reflect in checkboxes
      list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = STATE.customCats.includes(cb.getAttribute('data-cat'));
      });
      renderExtraCharts();
    }
  };

  if (btnSave) btnSave.onclick = () => {
    const name = prompt('Nombre del preset:');
    if (!name) return;
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    const presets = loadPresets();
    presets[name] = chosen;
    savePresets(presets);
    populatePresetSelect();
    alert('Preset guardado.');
  };

  if (btnDel) btnDel.onclick = () => {
    const name = sel && sel.value;
    if (!name) return;
    const presets = loadPresets();
    if (presets[name]){
      if (confirm('¬øEliminar preset "'+name+'"?')){
        delete presets[name];
        savePresets(presets);
        populatePresetSelect();
        alert('Preset eliminado.');
      }
    }
  };
}

function attachSearchHandler(){
  const input = document.getElementById('catSearch');
  const list  = document.getElementById('customCatList');
  if (!input || !list) return;
  input.oninput = () => {
    const q = input.value.trim().toLowerCase();
    list.querySelectorAll('label').forEach(lbl => {
      const text = lbl.textContent.toLowerCase();
      lbl.style.display = (!q || text.includes(q)) ? 'inline-flex' : 'none';
    });
  };
}


// ====== Seed default presets: Direct vs Indirect ======
function categorizeDefaultBuckets(catNames){
  const direct = new Set();
  const indirect = new Set();
  const push = (set, name) => set.add(name);

  catNames.forEach(name => {
    const low = name.toLowerCase();
    // Likely DIRECT
    if (/(salary|wage)/.test(low)) return push(direct, name);
    if (/(benefit|payroll|fringe|medical|vision|dental|life)/.test(low)) return push(direct, name);
    if (/(stipend|scholar)/.test(low)) return push(direct, name);
    if (/(program supplies|workshop|event)/.test(low)) return push(direct, name);
    if (/(travel|mileage|lodging|hotel|meals)/.test(low)) return push(direct, name);
    if (/(training|capacity)/.test(low)) return push(direct, name);
    if (/(consultant|contract service)/.test(low)) return push(direct, name);
    if (/(equipment)/.test(low)) return push(direct, name);
    if (/(printing|copy)/.test(low)) return push(direct, name);
    // Likely INDIRECT
    if (/(office rent|rent)/.test(low)) return push(indirect, name);
    if (/(office expenses|office|postage|mail|software)/.test(low)) return push(indirect, name);
    if (/(internet|communication|telephone|web)/.test(low)) return push(indirect, name);
    if (/(utilities|maintenance|janitorial|repair)/.test(low)) return push(indirect, name);
    if (/(marketing|advertising)/.test(low)) return push(indirect, name);
    if (/(insurance)/.test(low)) return push(indirect, name);
    if (/(indirect)/.test(low)) return push(indirect, name);
    // Fallback: lean to INDIRECT
    push(indirect, name);
  });

  return { direct: Array.from(direct), indirect: Array.from(indirect) };
}

function seedDefaultPresetsIfEmpty(){
  const presets = loadPresets();
  if (Object.keys(presets).length > 0) return; // already have user presets

  const catNames = (STATE.cats||[]).map(c=>c.name);
  const { direct, indirect } = categorizeDefaultBuckets(catNames);

  // Only save if we have at least something
  if (direct.length || indirect.length){
    presets['Direct'] = direct;
    presets['Indirect'] = indirect;
    savePresets(presets);
  }
}


// ====== Manager Tables Renderer ======
function renderManagerTables(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;

    // ---- Top categor√≠as por gasto ----
    const totalAll = (STATE.totalsPerMonth||[]).reduce((a,b)=>a+b,0) || 1;
    const topSorted = [...cats].sort((a,b)=> b.total - a.total).slice(0,5);
    const tbodyTop = document.querySelector('#tblTopCats tbody');
    if (tbodyTop){
      tbodyTop.innerHTML = '';
      const maxTotal = topSorted.length ? Math.max(...topSorted.map(c=>c.total)) : 1;
      topSorted.forEach((c,idx)=>{
        const avg = c.total/(c.monthly.length||1);
        const s = slopePerMonth(c.monthly||[]);
        const tag = s>Math.max(1,.05*(avg||1)) ? 'üìà Al alza' : (s<-Math.max(1,.05*(avg||1)) ? 'üìâ A la baja' : '‚û°Ô∏è Estable');
        const pct = (c.total/totalAll*100);
        const color = colorFor(c.name);
        const barW = Math.max(4, (c.total/maxTotal)*100);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx+1}</td>
          <td>${c.name}</td>
          <td style="text-align:right">${fmtUSD(c.total)}</td>
          <td style="text-align:right">${pct.toFixed(1)}%</td>
          <td style="text-align:right">${fmtUSD(avg)}</td>
          <td>${tag}</td>
          <td><div class="barcell"><div class="barfill" style="width:${barW}%;background:${color}33"></div></div></td>`;
        tbodyTop.appendChild(tr);
      });
    }

    // ---- Heatmap mensual por categor√≠a ----
    const head = document.getElementById('hmHead');
    const body = document.getElementById('hmBody');
    if (head && body){
      head.innerHTML = '<tr><th>Categor√≠a</th>' + months.map(m=> `<th>${m}</th>`).join('') + '<th style="text-align:right">Total</th></tr>';
      body.innerHTML = '';
      // Global min/max for scaling
      let gmin = Infinity, gmax = -Infinity;
      cats.forEach(c => (c.monthly||[]).forEach(v => { gmin = Math.min(gmin, v||0); gmax = Math.max(gmax, v||0); }));
      if (!isFinite(gmin)) gmin = 0; if (!isFinite(gmax) || gmax<=0) gmax = 1;
      function cellColor(v){
        const x = Math.max(0, Math.min(1, v/gmax));
        // scale green->yellow->red
        const r = Math.round(255 * x);
        const g = Math.round(200 * (1 - x) + 40);
        const b = 80;
        return `rgba(${r},${g},${b},0.18)`;
      }
      const catsSorted = [...cats].sort((a,b)=> b.total - a.total);
      catsSorted.forEach(c => {
        const tr = document.createElement('tr');
        let tds = `<td>${c.name}</td>`;
        (c.monthly||[]).forEach(v => {
          tds += `<td class="hmcell" style="background:${cellColor(v||0)}">${v?fmtUSD(v):''}</td>`;
        });
        tds += `<td style="text-align:right">${fmtUSD(c.total||0)}</td>`;
        tr.innerHTML = tds;
        body.appendChild(tr);
      });
    }

    // ---- Direct vs Indirect (tabla) ----
    const diBody = document.querySelector('#tblDirectIndirect tbody');
    if (diBody){
      diBody.innerHTML = '';
      const names = cats.map(c=> c.name);
      // Use existing heuristics from V19
      const buckets = categorizeDefaultBuckets ? categorizeDefaultBuckets(names) : { direct:names, indirect:[] };
      const setD = new Set(buckets.direct||[]);
      let totalD = 0, totalI = 0;
      cats.forEach(c => { if (setD.has(c.name)) totalD += c.total; else totalI += c.total; });
      const tot = totalD + totalI || 1;
      const pD = (totalD/tot*100), pI = (totalI/tot*100);

      function barHTML(pct, color){ return `<div class="barcell"><div class="barfill" style="width:${pct.toFixed(1)}%;background:${color}66"></div></div>`; }

      const trD = document.createElement('tr');
      trD.innerHTML = `<td>Direct</td><td style="text-align:right">${fmtUSD(totalD)}</td><td style="text-align:right">${pD.toFixed(1)}%</td><td>${barHTML(pD,'#10b981')}</td>`;
      const trI = document.createElement('tr');
      trI.innerHTML = `<td>Indirect</td><td style="text-align:right">${fmtUSD(totalI)}</td><td style="text-align:right">${pI.toFixed(1)}%</td><td>${barHTML(pI,'#7c3aed')}</td>`;

      diBody.appendChild(trD);
      diBody.appendChild(trI);
    }
  }catch(e){ console.warn('renderManagerTables failed', e); }
}


// ====== Zero-month filter: drop months with total 0 ======
function applyZeroMonthFilter(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;
    // compute totals per month from categories if missing
    const n = (cats[0].monthly||[]).length;
    const totals = Array(n).fill(0);
    cats.forEach(c => { for(let i=0;i<n;i++){ totals[i] += (c.monthly[i]||0); } });
    // indices where totals > 0
    const keepIdx = [];
    for (let i=0;i<n;i++){ if (Math.abs(totals[i]) > 1e-9) keepIdx.push(i); }
    if (keepIdx.length === n) { STATE.totalsPerMonth = totals; return; } // nothing to drop

    // Filter months and cat series
    STATE.months = keepIdx.map(i => months[i]);
    STATE.cats = cats.map(c => ({
      name: c.name,
      monthly: keepIdx.map(i => c.monthly[i]||0),
      total: keepIdx.reduce((s,i)=> s + (c.monthly[i]||0), 0)
    }));
    // Recompute totalsPerMonth
    const totals2 = Array(keepIdx.length).fill(0);
    STATE.cats.forEach(c => { for(let i=0;i<keepIdx.length;i++){ totals2[i] += (c.monthly[i]||0); } });
    STATE.totalsPerMonth = totals2;
  }catch(e){ console.warn('applyZeroMonthFilter failed', e); }
}


// ====== Comparator Chart ======
function buildComparatorUI(){
  const list = document.getElementById('cmpList');
  if (!list) return;
  const cats = STATE.cats || [];
  // order by total desc
  const ordered = [...cats].sort((a,b)=> b.total - a.total);
  list.innerHTML = ordered.map(c => `
    <label style="display:inline-flex;align-items:center;gap:6px;margin:4px 10px 4px 0">
      <input type="checkbox" data-cat="${c.name.replace(/"/g,'&quot;')}"/>
      <span>${c.name}</span>
    </label>
  `).join('');

  const btnTop = document.getElementById('btnCmpTop5');
  const btnClr = document.getElementById('btnCmpClear');
  const btnApp = document.getElementById('btnCmpApply');
  const modeSel = document.getElementById('cmpMode');

  const maxSel = 6;
  function applyTop(n=5){
    list.querySelectorAll('input[type="checkbox"]').forEach((cb,idx)=> cb.checked = (idx<n));
  }
  function clearAll(){
    list.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = false);
  }
  function getChosen(){
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    return chosen.slice(0, maxSel);
  }
  if (btnTop && !btnTop.__wired){ btnTop.__wired = true; btnTop.onclick = ()=> { applyTop(5); renderComparator(); }; }
  if (btnClr && !btnClr.__wired){ btnClr.__wired = true; btnClr.onclick = ()=> { clearAll(); renderComparator(); }; }
  if (btnApp && !btnApp.__wired){ btnApp.__wired = true; btnApp.onclick = ()=> renderComparator(); }
  if (modeSel && !modeSel.__wired){ modeSel.__wired = true; modeSel.onchange = ()=> renderComparator(); }

  // default to Top 5
  applyTop(5);
}

function renderComparator(){
  try{
    const months = STATE.months||[];
    const cats = STATE.cats||[];
    if (!months.length || !cats.length) return;
    const modeSel = document.getElementById('cmpMode');
    const mode = modeSel ? modeSel.value : 'line';
    const list = document.getElementById('cmpList');
    if (!list) return;
    const chosen = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb=> cb.getAttribute('data-cat'));
    const chosenSet = new Set(chosen);
    const picked = cats.filter(c => chosenSet.has(c.name)).slice(0,6);

    const datasets = picked.map(c => ({
      label: c.name,
      data: c.monthly,
      borderColor: colorFor(c.name),
      backgroundColor: colorFor(c.name) + '33',
      fill: (mode === 'line') ? false : true,
      tension: 0.25
    }));

    const ctx = document.getElementById('cmpChart').getContext('2d');
    if (!window.charts) window.charts = {};
    if (charts.cmpChart) { try{ charts.cmpChart.destroy(); }catch(e){} }
    charts.cmpChart = new Chart(ctx, {
      type: (mode === 'line') ? 'line' : 'bar',
      data: { labels: months, datasets: datasets },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ position:'bottom' } },
        scales: (mode==='bar') ? { x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } } : { y:{ beginAtZero:true } }
      }
    });
  }catch(e){ console.warn('renderComparator failed', e); }
}


// ====== Chart dropdown filters (scoped) ======
function populateChartFiltersScoped(){
  try{
    const cats = (STATE.cats||[]).slice().sort((a,b)=> b.total - a.total);
    const inject = (containerId)=>{
      const box = document.getElementById(containerId);
      if (!box) return;
      box.innerHTML = cats.map(c => `<label><input type="checkbox" value="${c.name.replace(/"/g,'&quot;')}"/> <span>${c.name}</span></label>`).join('');
    };
    inject('donutChecks'); inject('stackChecks');

    // buttons
    const on = (id, fn)=>{ const el = document.getElementById(id); if (el && !el.__wired){ el.__wired = true; el.onclick = fn; } };
    const selectTop = (wrapId, n)=>{
      const box = document.getElementById(wrapId);
      if (!box) return;
      const inputs = Array.from(box.querySelectorAll('input[type="checkbox"]'));
      inputs.forEach((cb,i)=> cb.checked = (i < n));
    };
    const clearAll = (wrapId)=>{
      const box = document.getElementById(wrapId);
      if (!box) return;
      box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false);
    };
    const reRender = ()=>{ try{ renderCharts(STATE.months||[], STATE.cats||[]); }catch(e){} };

    on('donutTop5', ()=>{ selectTop('donutChecks',5); reRender(); });
    on('donutClear', ()=>{ clearAll('donutChecks'); reRender(); });
    on('donutApply', ()=>{ reRender(); });

    on('stackTop8', ()=>{ selectTop('stackChecks',8); reRender(); });
    on('stackClear', ()=>{ clearAll('stackChecks'); reRender(); });
    on('stackApply', ()=>{ reRender(); });
  }catch(e){ console.warn('populateChartFiltersScoped failed', e); }
}
function getChecked(containerId){
  const box = document.getElementById(containerId);
  if (!box) return [];
  return Array.from(box.querySelectorAll('input[type="checkbox"]:checked')).map(i=> i.value);
}


// === Smart positioning for dropdown panels ===
(function smartPanels(){
  function adjustPanel(detailsEl, panelEl){
    if (!panelEl) return;
    // Reset classes
    panelEl.classList.remove('flip','modal');
    // If narrow viewport, modal class via CSS media already applies, but double-check for tiny heights
    const rect = panelEl.getBoundingClientRect();
    const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
    const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

    // If the panel would overflow to the right by >16px, flip to left
    if (rect.right > vw - 16) panelEl.classList.add('flip');
    // If the panel would overflow bottom by >16px, modal
    if (rect.bottom > vh - 16) panelEl.classList.add('modal');
  }

  function wireOne(detailsSel, panelSel){
    const d = document.querySelector(detailsSel);
    const p = document.querySelector(panelSel);
    if (!d || !p || d.__wired) return;
    d.__wired = true;
    d.addEventListener('toggle', ()=> { if (d.open) { setTimeout(()=> adjustPanel(d,p), 0); } });
    window.addEventListener('resize', ()=> { if (d.open) adjustPanel(d,p); });
    window.addEventListener('scroll', ()=> { if (d.open) adjustPanel(d,p); }, { passive:true });
  }

  // Wire both charts
  wireOne('.chart-filterbar details:nth-of-type(1)', '#donutPanel');
  wireOne('.chart-filterbar details:nth-of-type(2)', '#stackPanel');

  // Close on outside click when modal
  document.addEventListener('click', (ev)=>{
    const openDetails = Array.from(document.querySelectorAll('.chart-filterbar details[open]'));
    for (const d of openDetails){
      const panel = d.querySelector('.panel');
      if (panel && panel.classList.contains('modal')){
        if (!panel.contains(ev.target) && !d.querySelector('summary').contains(ev.target)){
          d.open = false;
        }
      }
    }
  });
})();  


// ====== Snapshot embed utilities ======
function getEmbeddedDataNode(){
  return document.getElementById('embeddedData');
}
function saveSnapshotToHTML(){
  try{
    const node = getEmbeddedDataNode();
    if (!node) return alert('No se encontr√≥ el contenedor de snapshot.');
    const payload = {
      months: STATE.months||[],
      cats: STATE.cats||[],
      totalsPerMonth: STATE.totalsPerMonth||[],
      meta: { generatedAt: new Date().toISOString(), version: 'v19-snapshot-1' }
    };
    node.textContent = JSON.stringify(payload);
    // Quick visual feedback
    const b = document.getElementById('btnEmbedSnapshot');
    if (b){ b.textContent = '‚úÖ Snapshot incrustado'; setTimeout(()=> b.textContent='üì¶ Guardar snapshot (incrustar datos)', 2000); }
  }catch(e){
    console.warn('saveSnapshotToHTML failed', e);
    alert('No se pudo guardar el snapshot.');
  }
}
function tryLoadEmbeddedSnapshot(){
  try{
    const node = getEmbeddedDataNode();
    if (!node || !node.textContent) return false;
    const p = JSON.parse(node.textContent);
    if (!p || !Array.isArray(p.months) || !Array.isArray(p.cats)) return false;
    // Set STATE
    STATE.months = p.months;
    STATE.cats = p.cats;
    STATE.totalsPerMonth = p.totalsPerMonth || [];
    // Hide upload card if present
    const up = document.getElementById('uploadCard');
    if (up) up.classList.add('hidden');
    const uz = document.getElementById('uploadZone'); if (uz) uz.classList.add('hidden');
    // Render everything
    renderKPI(STATE.months, STATE.cats);
    renderCharts(STATE.months, STATE.totalsPerMonth, STATE.cats);
    renderTables(STATE.months, STATE.cats);
    generateExecutiveAnalysis();
    renderManagerTables();
  populateAllCatsFilter();
    if (typeof renderExtraCharts==='function') renderExtraCharts();
    populateChartFiltersScoped && populateChartFiltersScoped();
    buildComparatorUI && buildComparatorUI();
    renderComparator && renderComparator();
    return true;
  }catch(e){
    console.warn('tryLoadEmbeddedSnapshot failed', e);
    return false;
  }
}


// Wire snapshot button
(function(){
  const btn = document.getElementById('btnEmbedSnapshot');
  if (btn && !btn.__wired){
    btn.__wired = true;
    btn.addEventListener('click', (e)=>{ e.preventDefault(); saveSnapshotToHTML(); });
  }
})();
// Try to load embedded snapshot on startup
document.addEventListener('DOMContentLoaded', ()=> {
  try{ tryLoadEmbeddedSnapshot(); }catch(e){}
});


// ====== Download snapshot as self-contained HTML ======
function ensureSnapshotInDOM(){
  // If embeddedData is empty, write current STATE to it
  const node = document.getElementById('embeddedData');
  if (!node) return false;
  if (!node.textContent || node.textContent.trim()===''){
    if (!window.STATE || !Array.isArray(STATE.months) || !Array.isArray(STATE.cats)) return false;
    const payload = {
      months: STATE.months||[],
      cats: STATE.cats||[],
      totalsPerMonth: STATE.totalsPerMonth||[],
      meta: { generatedAt: new Date().toISOString(), version: 'v19-snapshot-1' }
    };
    node.textContent = JSON.stringify(payload);
  }
  return true;
}
function downloadSnapshotCopy(){
  try{
    if (!ensureSnapshotInDOM()){
      alert('Necesito que subas un Excel primero para poder generar la copia con datos.');
      return;
    }
    // Serialize full HTML
    const htmlText = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
    const blob = new Blob([htmlText], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    a.download = `CBDIO_Expenses_Snapshot_${ts}.html`;
    a.href = url;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{
      URL.revokeObjectURL(url);
      a.remove();
    }, 100);
  }catch(e){
    console.warn('downloadSnapshotCopy failed', e);
    alert('No se pudo generar la copia con datos.');
  }
}


// Wire download snapshot button
(function(){
  const btn = document.getElementById('btnDownloadSnapshot');
  if (btn && !btn.__wired){
    btn.__wired = true;
    btn.addEventListener('click', (e)=>{ e.preventDefault(); downloadSnapshotCopy(); });
  }
})();


// ===== Export helpers =====
function canvasesToImages(scope=document){
  const canv = Array.from(scope.querySelectorAll('canvas'));
  const payload = [];
  canv.forEach(cv => {
    try{
      const url = cv.toDataURL('image/png');
      const img = document.createElement('img');
      img.src = url;
      img.alt = cv.id || 'chart';
      img.style.maxWidth = '100%';
      img.style.height = 'auto';
      payload.push({canvas: cv, image: img});
    }catch(e){ console.warn('toDataURL failed for', cv.id, e); }
  });
  return payload;
}
function freezeDomClone(){
  // Clone full document to avoid mutating live dashboard
  const clone = document.documentElement.cloneNode(true);
  // Remove scripts to avoid re-running code in snapshot
  clone.querySelectorAll('script').forEach(s => s.remove());
  // Replace canvases with images
  const pairs = canvasesToImages(document);
  pairs.forEach(({canvas, image})=>{
    const sel = canvas.id ? `#${CSS.escape(canvas.id)}` : null;
    const twin = sel ? clone.querySelector(sel) : null;
    if (twin && twin.tagName.toLowerCase()==='canvas'){
      twin.replaceWith(image.cloneNode(true));
    }
  });
  // Add export-clean class and hide uploader
  clone.querySelector('body')?.classList.add('export-clean');
  const up = clone.querySelector('#uploadCard'); if (up) up.remove();
  const uz = clone.querySelector('#uploadZone'); if (uz) uz.remove();
  return '<!DOCTYPE html>\n' + clone.outerHTML;
}
function downloadBlob(text, filename, type='text/html'){
  const blob = new Blob([text], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
}
function buildExportFilename(ext){
  function safeSlug(s){
    return String(s||'').normalize('NFKD').replace(/[^\w\s-]+/g,'').trim().replace(/[\s_-]+/g,'_').replace(/^_+|_+$/g,'');
  }
  function monthRangeStr(){
    try{
      const m = STATE.months||[]; if (!m.length) return '';
      return `${m[0]}_a_${m[m.length-1]}`.replace(/\s+/g,'_');
    }catch(_){ return ''; }
  }
  function totalStr(){
    try{
      const t = (STATE.totalsPerMonth||[]).reduce((a,b)=>a+(b||0),0) || 0;
      return t ? ('Tot_' + t.toFixed(2).replace(/\./g,'_')) : '';
    }catch(_){ return ''; }
  }
  const proj = safeSlug(STATE.projectTitle || 'Proyecto');
  const pid  = STATE.projectId ? ('ID_' + safeSlug(STATE.projectId)) : '';
  const per  = monthRangeStr();
  const tot  = totalStr();
  const ts   = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  const parts = ['CBDIO', proj]; if (pid) parts.push(pid); if (per) parts.push(per); if (tot) parts.push(tot); parts.push(ts);
  return parts.join('_') + '.' + ext;
}
// Freeze & download HTML
function onFreezeHTML(){
  try{
    const frozen = freezeDomClone();
    const fname = buildExportFilename('html');
    downloadBlob(frozen, fname, 'text/html');
  }catch(e){
    console.warn('Freeze HTML failed', e);
    alert('No se pudo generar el HTML congelado.');
  }
}
// Export to PDF via print (clean mode)
function onExportPDF(){
  try{
    document.body.classList.add('export-clean');
    setTimeout(()=> window.print(), 50);
    setTimeout(()=> document.body.classList.remove('export-clean'), 1500);
  }catch(e){
    console.warn('Export PDF failed', e);
    document.body.classList.remove('export-clean');
    alert('No se pudo preparar el PDF.');
  }
}
// PPTX best-effort using PptxGenJS from CDN
async function ensurePptx(){
  if (window.PptxGenJS) return window.PptxGenJS;
  await new Promise((res, rej)=>{
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js';
    s.onload = res; s.onerror = rej; document.head.appendChild(s);
  });
  return window.PptxGenJS;
}
async function onExportPPTX(){
  try{
    await ensurePptx();
    const PptxGenJS = window.PptxGenJS;
    const pptx = new PptxGenJS();
    pptx.author = 'CBDIO Dashboard'; pptx.company = 'CBDIO';
    const title = STATE.projectTitle || 'Reporte de Gastos';
    const per = (STATE.months||[]); const period = per.length? (per[0] + ' ‚Äì ' + per[per.length-1]) : '';
    // Title slide
    let slide = pptx.addSlide();
    slide.addText('Centro Binacional para el Desarrollo Ind√≠gena Oaxaque√±o', { x:0.5, y:0.5, w:9, h:0.6, fontSize:20, bold:true, color:'000000' });
    slide.addText('An√°lisis Financiero (JLE)', { x:0.5, y:1.1, w:9, h:0.5, fontSize:18, color:'000000' });
    slide.addText(`${title}${period?' ¬∑ '+period:''}`, { x:0.5, y:1.7, w:9, h:0.5, fontSize:16, color:'000000' });

    // Collect chart images
    const charts = Array.from(document.querySelectorAll('canvas')).map(cv=>({ id: cv.id, data: cv.toDataURL('image/png') })).filter(o=>o.data);

    for (const chunk of charts){
      const s = pptx.addSlide();
      s.addText(chunk.id || 'Gr√°fica', { x:0.5, y:0.4, w:9, h:0.4, fontSize:16, color:'000000' });
      s.addImage({ data: chunk.data, x:0.5, y:0.9, w:8.5, h:4.5 });
    }

    const fname = buildExportFilename('pptx');
    await pptx.writeFile({ fileName: fname });
  }catch(e){
    console.warn('Export PPTX failed', e);
    alert('No se pudo generar el PPTX (intenta con el HTML congelado o PDF).');
  }
}

// Wire toolbar
(function(){
  const b1 = document.getElementById('btnFreezeHTML');
  const b2 = document.getElementById('btnExportPDF');
  const b3 = document.getElementById('btnExportPPTX');
  if (b1 && !b1.__wired){ b1.__wired = true; b1.addEventListener('click', onFreezeHTML); }
  if (b2 && !b2.__wired){ b2.__wired = true; b2.addEventListener('click', onExportPDF); }
  if (b3 && !b3.__wired){ b3.__wired = true; b3.addEventListener('click', onExportPPTX); }
})();


// ===== All Cats Trend interactive filters =====
window.__allCatsSelection = null; // Set of selected names or null for default
function populateAllCatsFilter(){
  try{
    const box = document.getElementById('allCatsChecks');
    if (!box) return;
    const cats = (STATE.cats||[]).slice().sort((a,b)=> b.total - a.total);
    box.innerHTML = cats.map(c => `<label style="display:flex;align-items:center;gap:6px;padding:4px 2px"><input type="checkbox" value="${c.name.replace(/"/g,'&quot;')}"/> <span>${c.name}</span></label>`).join('');
    // restore selection if present
    const sel = window.__allCatsSelection;
    if (sel && sel.size){
      box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = sel.has(cb.value));
    } else {
      // default to Top 10
      Array.from(box.querySelectorAll('input[type="checkbox"]')).forEach((cb,i)=> cb.checked = (i<10));
    }
    // Wire buttons
    const on = (id, fn)=>{ const el = document.getElementById(id); if (el && !el.__wired){ el.__wired=true; el.onclick=fn; } };
    const chooseTop = (n)=>{
      const inputs = Array.from(box.querySelectorAll('input[type="checkbox"]'));
      inputs.forEach((cb,i)=> cb.checked = (i < n));
      autoApplyAllCats();
    };
    const chooseAll = ()=>{ box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=true); autoApplyAllCats(); };
    const chooseNone = ()=>{ box.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false); autoApplyAllCats(); };
    on('allCatsTop5', ()=> chooseTop(5));
    on('allCatsTop10', ()=> chooseTop(10));
    on('allCatsAll', chooseAll);
    on('allCatsNone', chooseNone);
    on('allCatsApply', ()=> autoApplyAllCats(true));

    // search filtering
    const search = document.getElementById('allCatsSearch');
    if (search && !search.__wired){
      search.__wired = true;
      search.addEventListener('input', ()=>{
        const q = search.value.trim().toLowerCase();
        Array.from(box.querySelectorAll('label')).forEach(lab=>{
          const txt = (lab.textContent||'').toLowerCase();
          lab.style.display = txt.includes(q) ? '' : 'none';
        });
      });
    }
    // auto-apply on change
    if (!box.__wiredChange){
      box.__wiredChange = true;
      box.addEventListener('change', ()=> autoApplyAllCats());
    }
  }catch(e){ console.warn('populateAllCatsFilter failed', e); }
}
function getAllCatsSelected(){
  const box = document.getElementById('allCatsChecks');
  if (!box) return [];
  return Array.from(box.querySelectorAll('input[type="checkbox"]:checked')).map(i=> i.value);
}
function autoApplyAllCats(force=false){
  try{
    const picked = getAllCatsSelected();
    window.__allCatsSelection = picked.length ? new Set(picked) : (force ? new Set() : null);
    // Re-render charts, which will read the selection
    renderCharts(STATE.months||[], STATE.totalsPerMonth||[], STATE.cats||[]);
  }catch(e){ console.warn('autoApplyAllCats failed', e); }
}







</script>

<div class="grid" id="mgrTables">
  <div class="card">
    <h3>üèÜ Top categor√≠as por gasto</h3>
    <div class="table-responsive">
      <table id="tblTopCats" class="compact">
        <thead><tr>
          <th>Rank</th><th>Categor√≠a</th><th style="text-align:right">Total</th><th style="text-align:right">% del total</th><th style="text-align:right">Prom./mes</th><th>Tendencia</th><th style="width:160px">Comparativa</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div><div class="muted small" style="margin-top:6px"></div>
  </div></div>
</div>

  <div class="card hidden" id="diagWrap">
      <h3>üß™ Diagn√≥stico</h3>
      <div class="diag" id="diagBox"></div>
    </div>

<!-- Robust Chart.js loader with multi-CDN fallback -->
<script>
(function(){
  function isReady(){ return !!(window.Chart && typeof window.Chart === 'function'); }
  function loadScript(url){
    return new Promise((resolve, reject)=>{
      var s = document.createElement('script'); s.src = url; s.async = true;
      s.onload = ()=> resolve(url); s.onerror = ()=> reject(url);
      document.head.appendChild(s);
    });
  }
  async function ensureChartJS(){
    if (isReady()) return true;
    const cdns = [
      'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js',
      'https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js'
    ];
    for (const u of cdns){
      try { await loadScript(u); if (isReady()) return true; } catch(_){}
    }
    return isReady();
  }
  async function boot(){
    try{
      const ok = await ensureChartJS();
      // Proceed even if not ok: tables render, charts will skip.
      if (typeof tryLoadEmbeddedSnapshot === 'function'){
        var loaded = tryLoadEmbeddedSnapshot();
        if (loaded || ok) return;
      }
      if (window.STATE && Array.isArray(STATE.months) && Array.isArray(STATE.cats)){
        if (typeof renderKPI==='function') renderKPI(STATE.months, STATE.cats);
        if (typeof renderCharts==='function'){
          try{ renderCharts(STATE.months, STATE.totalsPerMonth||[], STATE.cats); }
          catch(e){ try{ renderCharts(STATE.months, STATE.cats); }catch(_){ } }
        }
        if (typeof renderTables==='function') renderTables(STATE.months, STATE.cats);
        if (typeof renderExtraCharts==='function') renderExtraCharts();
        if (typeof renderManagerTables==='function') renderManagerTables();
        if (typeof populateChartFiltersScoped==='function') populateChartFiltersScoped();
        if (typeof populateAllCatsFilter==='function') populateAllCatsFilter();
      }
    }catch(e){ console.warn('boot failed', e); }
  }
  window.addEventListener('DOMContentLoaded', boot);
})();
</script>


<script id="jle-exec-enhancer">
(function(){
  function enhanceExec(){
    const wrap = document.getElementById('execWrap');
    const bullets = document.getElementById('execBullets');
    if (!wrap || !bullets) return;
    // If not already enhanced, wrap each immediate UL into a card-like div
    if (!bullets.__jleEnhanced){
      const kids = Array.from(bullets.childNodes);
      const frag = document.createDocumentFragment();
      let currentGroup = null;
      kids.forEach(node => {
        if (node.tagName === 'STRONG'){
          const h = document.createElement('div');
          h.className = 'exec-card';
          const h3 = document.createElement('h3');
          h3.textContent = node.textContent.trim();
          h.appendChild(h3);
          frag.appendChild(h);
          currentGroup = h;
        } else if (node.tagName === 'UL'){
          const card = document.createElement('div');
          card.className = 'exec-card';
          const ul = node.cloneNode(true);
          card.appendChild(ul);
          frag.appendChild(card);
        } else if (node.tagName === 'DIV'){
          const card = document.createElement('div');
          card.className = 'exec-card';
          card.textContent = node.textContent.trim();
          frag.appendChild(card);
        }
      });
      if (frag.childNodes.length){
        bullets.innerHTML = '';
        const grid = document.createElement('div');
        grid.className = 'exec-grid';
        grid.appendChild(frag);
        bullets.appendChild(grid);
      }
      bullets.__jleEnhanced = true;
    }
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', enhanceExec);
  } else { enhanceExec(); }
  // Re-run after data load (some apps render later)
  setTimeout(enhanceExec, 1200);
})();
</script>





<script id="jle-open-snapshot">
(function(){
  async function onOpenSnapshot(){
    try{
      // Helper: try to persist STATE into embeddedData on the live page if possible
      try{
        if (typeof ensureSnapshotInDOM === 'function'){ ensureSnapshotInDOM(); }
      }catch(_){}

      // Attempt 1: Build payload from live STATE
      let payload = null;
      if (window.STATE && Array.isArray(STATE.cats) && STATE.cats.length && Array.isArray(STATE.months) && STATE.months.length){
        let totals = Array.isArray(STATE.totalsPerMonth) && STATE.totalsPerMonth.length ? STATE.totalsPerMonth : [];
        if (!totals.length && STATE.cats.length){
          const n = (STATE.cats[0].monthly||[]).length;
          totals = Array(n).fill(0);
          STATE.cats.forEach(c => { for(let i=0;i<n;i++){ totals[i] += (c.monthly[i]||0); } });
        }
        payload = { months: STATE.months, cats: STATE.cats, totalsPerMonth: totals, meta: { generatedAt: new Date().toISOString(), kind: 'interactive-snapshot' } };
      }

      // Attempt 2: Fallback to embeddedData in current page
      if (!payload){
        const embedLive = document.getElementById('embeddedData');
        if (embedLive && embedLive.textContent){
          try{
            const p = JSON.parse(embedLive.textContent);
            if (p && Array.isArray(p.cats) && p.cats.length && Array.isArray(p.months) && p.months.length){
              let totals = Array.isArray(p.totalsPerMonth) && p.totalsPerMonth.length ? p.totalsPerMonth : [];
              if (!totals.length && p.cats.length){
                const n = (p.cats[0].monthly||[]).length;
                totals = Array(n).fill(0);
                p.cats.forEach(c => { for(let i=0;i<n;i++){ totals[i] += (c.monthly[i]||0); } });
              }
              payload = { months: p.months, cats: p.cats, totalsPerMonth: totals, meta: p.meta || { generatedAt: new Date().toISOString(), kind: 'interactive-snapshot' } };
            }
          }catch(_){}
        }
      }

      if (payload){
        // Interactive copy with embedded data + autoboot
        const clone = document.documentElement.cloneNode(true);
        // Ensure embeddedData exists
        let embed = clone.querySelector('#embeddedData');
        if (!embed){
          const s = clone.ownerDocument.createElement('script');
          s.type = 'application/json'; s.id = 'embeddedData';
          (clone.querySelector('body')||clone).appendChild(s);
          embed = clone.querySelector('#embeddedData');
        }
        embed.textContent = JSON.stringify(payload);
        // Remove uploader
        const up = clone.querySelector('#uploadCard'); if (up) up.remove();
        const uz = clone.querySelector('#uploadZone'); if (uz) uz.remove();
        // Autoboot charts on load
        const boot = clone.ownerDocument.createElement('script');
        boot.id = 'snapshot-autoboot';
        boot.textContent = "(function(){function boot(){try{if (typeof tryLoadEmbeddedSnapshot==='function'){var ok=tryLoadEmbeddedSnapshot(); if(!ok){setTimeout(boot,300);} } else { setTimeout(boot,300); }}catch(e){setTimeout(boot,300);} } if (document.readyState==='loading'){document.addEventListener('DOMContentLoaded', boot);} else { boot(); }})();";
        (clone.querySelector('body')||clone).appendChild(boot);
        const htmlText = '<!DOCTYPE html>\n' + clone.outerHTML;
        const blob = new Blob([htmlText], {type:'text/html'});
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        setTimeout(()=> URL.revokeObjectURL(url), 60000);
        return;
      }

      // Attempt 3 (final fallback): Freeze current DOM with canvases as images (static snapshot)
      if (typeof freezeDomClone === 'function'){
        const frozen = freezeDomClone(); // removes scripts, converts canvases to images, hides uploader
        const blob = new Blob([frozen], {type:'text/html'});
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        setTimeout(()=> URL.revokeObjectURL(url), 60000);
        return;
      }

      alert('No encontr√© datos. Sube un Excel o usa un HTML con snapshot incrustado.');
    }catch(e){
      console.warn('onOpenSnapshot failed', e);
      alert('No se pudo abrir la copia HTML.');
    }
  }
  const b = document.getElementById('btnOpenSnapshot');
  if (b && !b.__wired){
    b.__wired = true;
    b.addEventListener('click', onOpenSnapshot);
  }
})();
</script>





<script id="jle-trend-filters-fix">
(function(){
  function getPayload(){
    try{ if (window.STATE && Array.isArray(STATE.cats) && Array.isArray(STATE.months)) return { months: STATE.months, cats: STATE.cats }; }catch(_){}
    try{ const s=document.getElementById('embeddedData'); if(s&&s.textContent){ const p=JSON.parse(s.textContent); if(p&&Array.isArray(p.cats)&&Array.isArray(p.months)) return {months:p.months,cats:p.cats}; } }catch(_){}
    return null;
  }
  function findTrendCanvas(){
    const heads=Array.from(document.querySelectorAll('h1,h2,h3,h4'));
    for(const h of heads){
      const t=(h.textContent||'').toLowerCase();
      if(/tendencia.*gastos.*categor/.test(t)){
        const sec=h.closest('section, .card, .panel, .chart, div')||h.parentElement;
        const cv=sec?sec.querySelector('canvas'):null;
        if(cv) return cv;
      }
    }
    const cvs=Array.from(document.querySelectorAll('canvas'));
    return cvs[0]||null;
  }
  function getSelectedCategories(allNames){
    const names=new Set();
    const boxes=Array.from(document.querySelectorAll('input[type="checkbox"]'));
    for(const b of boxes){
      if(!b.checked) continue;
      let label=""; const id = b.id && document.querySelector(`label[for="${b.id}"]`);
      if(id) label=(id.textContent||"").trim();
      else if(b.closest('label')) label=(b.closest('label').textContent||"").trim();
      if(!label) label=(b.value||b.name||b.title||"").trim();
      if(label) names.add(label);
    }
    const selects=Array.from(document.querySelectorAll('select[multiple], select[name*="cat"]'));
    for(const s of selects){ for(const opt of Array.from(s.selectedOptions||[])){ names.add((opt.text||opt.value||"").trim()); } }
    if(!names.size) return allNames.slice();
    const selected=[]; const lower=allNames.map(n=>({n,k:n.toLowerCase()}));
    names.forEach(lbl=>{ const L=lbl.toLowerCase(); let hit=lower.find(x=>x.k===L)||lower.find(x=>x.k.startsWith(L))||lower.find(x=>L.startsWith(x.k)); if(hit) selected.push(hit.n); });
    return selected.length?selected:allNames.slice();
  }
  function buildDatasets(cats, selected){
    const ds=[]; const palette=['#2563eb','#10b981','#f59e0b','#ef4444','#8b5cf6','#14b8a6','#f97316','#22c55e','#eab308','#3b82f6']; let i=0;
    selected.forEach(name=>{ const c=cats.find(x=>(x.name||'')===name); if(!c) return;
      ds.push({ label:c.name||'Categor√≠a', data:(c.monthly||[]).map(v=>+v||0), borderColor:palette[i%palette.length], backgroundColor:palette[i%palette.length]+'55', borderWidth:2, tension:.25, fill:false });
      i++;
    });
    return ds;
  }
  function redrawTrend(){
    const payload=getPayload(); if(!payload) return;
    const cv=findTrendCanvas(); if(!cv) return;
    const allNames=payload.cats.map(c=>c.name||'Categor√≠a');
    const selected=getSelectedCategories(allNames);
    if(window.Chart&&Chart.getChart){ const inst=Chart.getChart(cv); if(inst&&inst.destroy) inst.destroy(); }
    const ctx=cv.getContext('2d');
    new Chart(ctx,{ type:'line', data:{ labels:payload.months.slice(), datasets:buildDatasets(payload.cats, selected) },
      options:{ responsive:true, interaction:{mode:'nearest',intersect:false}, plugins:{legend:{position:'bottom'}}, scales:{ y:{beginAtZero:true} } } });
  }
  function wireFilters(){
    const els=Array.from(document.querySelectorAll('input[type="checkbox"], select'));
    els.forEach(el=>{ if(!el.__wiredTrend){ el.__wiredTrend=true; el.addEventListener('change', ()=> setTimeout(redrawTrend,10)); } });
  }
  function boot(){ wireFilters(); setTimeout(redrawTrend,50); }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', boot); } else { boot(); }
  setTimeout(wireFilters,800); setTimeout(wireFilters,1600);
})();
</script>

</body>
</html>
